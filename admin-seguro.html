<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administra√ß√£o - Bingo Arrai√° INEC</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <!-- Loading inicial -->
    <div id="loading-inicial" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; font-family: Arial;">
        <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">üîß</div>
            <h2>Carregando Painel Admin...</h2>
            <p>Verificando autentica√ß√£o...</p>
        </div>
    </div>

    <!-- Conte√∫do principal ser√° carregado aqui -->
    <div id="conteudo-principal" style="display: none;">
        <!-- Todo o conte√∫do do admin.html original aqui -->
    </div>

    <!-- Scripts em ordem espec√≠fica -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script>
        // Fun√ß√£o mostrarToast global
        function mostrarToast(mensagem, tipo = 'info', duracao = 3000) {
            console.log(`[TOAST ${tipo.toUpperCase()}] ${mensagem}`);
            
            const toastAnterior = document.getElementById('toast-notification');
            if (toastAnterior) {
                toastAnterior.remove();
            }
            
            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${tipo === 'success' ? '#4CAF50' : tipo === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10001;
                font-weight: bold;
                max-width: 300px;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                font-family: 'Comic Sans MS', cursive, sans-serif;
            `;
            
            toast.textContent = mensagem;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duracao);
        }
        
        // Tornar fun√ß√£o global
        window.mostrarToast = mostrarToast;
    </script>
    
    <script src="firebase-config-admin.js"></script>
    <script src="auth-admin.js"></script>
    
    <script>
        // Sistema de inicializa√ß√£o seguro
        let sistemaCarregado = false;
        
        function inicializarSistema() {
            console.log('üöÄ Iniciando sistema admin...');
            
            // Verificar se as depend√™ncias est√£o carregadas
            if (typeof firebase === 'undefined') {
                mostrarToast('‚ùå Firebase n√£o carregado', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            if (typeof firebaseConfig === 'undefined') {
                mostrarToast('‚ùå Configura√ß√£o Firebase n√£o encontrada', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            if (typeof isUserAuthenticated === 'undefined') {
                console.warn('‚ö†Ô∏è Fun√ß√£o isUserAuthenticated n√£o encontrada');
                window.location.href = 'login.html';
                return;
            }
            
            // Verificar autentica√ß√£o
            try {
                if (!isUserAuthenticated()) {
                    console.log('üîê Usu√°rio n√£o autenticado');
                    mostrarToast('üîê Redirecionando para login...', 'info');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                    return;
                }
                
                console.log('‚úÖ Usu√°rio autenticado');
                carregarConteudoAdmin();
                
            } catch (error) {
                console.error('‚ùå Erro na verifica√ß√£o de autentica√ß√£o:', error);
                mostrarToast('‚ùå Erro na autentica√ß√£o', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }
        
        function carregarConteudoAdmin() {
            console.log('üìÑ Carregando conte√∫do do admin...');
            
            // Buscar o conte√∫do do admin.html original
            fetch('admin.html')
                .then(response => response.text())
                .then(html => {
                    // Extrair apenas o body content
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const body = doc.body;
                    
                    // Remover scripts para evitar conflitos
                    const scripts = body.querySelectorAll('script');
                    scripts.forEach(script => script.remove());
                    
                    // Carregar conte√∫do
                    const conteudoPrincipal = document.getElementById('conteudo-principal');
                    conteudoPrincipal.innerHTML = body.innerHTML;
                    
                    // Mostrar conte√∫do
                    document.getElementById('loading-inicial').style.display = 'none';
                    conteudoPrincipal.style.display = 'block';
                    
                    // Carregar admin.js por √∫ltimo
                    carregarAdminScript();
                })
                .catch(error => {
                    console.error('‚ùå Erro ao carregar conte√∫do:', error);
                    mostrarToast('‚ùå Erro ao carregar painel', 'error');
                    
                    // Fallback: redirecionar para admin.html original
                    setTimeout(() => {
                        window.location.href = 'admin.html';
                    }, 2000);
                });
        }
        
        function carregarAdminScript() {
            console.log('üìÑ Carregando admin.js...');
            
            const script = document.createElement('script');
            script.src = 'admin.js';
            script.onload = () => {
                console.log('‚úÖ Admin.js carregado');
                mostrarToast('‚úÖ Painel admin carregado!', 'success');
                sistemaCarregado = true;
            };
            script.onerror = () => {
                console.error('‚ùå Erro ao carregar admin.js');
                mostrarToast('‚ùå Erro ao carregar funcionalidades', 'error');
            };
            
            document.head.appendChild(script);
        }
        
        // Aguardar carregamento completo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarSistema);
        } else {
            inicializarSistema();
        }
        
        // Timeout de seguran√ßa
        setTimeout(() => {
            if (!sistemaCarregado) {
                console.warn('‚ö†Ô∏è Sistema n√£o carregou em tempo h√°bil');
                document.getElementById('loading-inicial').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h2>Problema no Carregamento</h2>
                        <p>O sistema est√° demorando para carregar.</p>
                        <button onclick="window.location.href='login.html'" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px;">
                            üîë Ir para Login
                        </button>
                        <button onclick="window.location.reload()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px;">
                            üîÑ Recarregar
                        </button>
                    </div>
                `;
            }
        }, 10000);
    </script>
</body>
</html>
