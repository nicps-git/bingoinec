<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento - Processo de Compra</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .log { height: 400px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; }
        .step { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 10px; margin: 10px 0; }
        .step.completed { background: #d4edda; border-left-color: #28a745; }
        .step.failed { background: #f8d7da; border-left-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Monitoramento - Processo de Compra</h1>
        
        <div class="section warning">
            <h3>üéØ OBJETIVO</h3>
            <p>Monitorar cada etapa do processo de compra para identificar onde est√° falhando a grava√ß√£o</p>
        </div>

        <div class="section">
            <h3>üß™ Execu√ß√£o Monitorada</h3>
            <button onclick="executarProcessoCompleto()">üöÄ Executar Processo Completo</button>
            <button onclick="verificarFirebaseAposCompra()">üìä Verificar Firebase</button>
            <button onclick="limparLog()">üóëÔ∏è Limpar Log</button>
        </div>

        <div class="section">
            <h3>üìã Etapas do Processo</h3>
            <div id="etapa-1" class="step">1. Inicializar Firebase Service</div>
            <div id="etapa-2" class="step">2. Carregar Configura√ß√µes</div>
            <div id="etapa-3" class="step">3. Gerar Cartela</div>
            <div id="etapa-4" class="step">4. Simular Adi√ß√£o ao Carrinho</div>
            <div id="etapa-5" class="step">5. Preparar Dados da Compra</div>
            <div id="etapa-6" class="step">6. Salvar no Firebase</div>
            <div id="etapa-7" class="step">7. Verificar Grava√ß√£o</div>
        </div>

        <div class="section">
            <h3>üìã Log Detalhado</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
    
    <script>
        let firebaseService = null;
        let db = null;
        let configuracoes = {};
        let cartelaAtual = null;
        let carrinho = [];

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function limparLog() {
            document.getElementById('log').innerHTML = '';
            // Reset das etapas
            for (let i = 1; i <= 7; i++) {
                const etapa = document.getElementById(`etapa-${i}`);
                etapa.className = 'step';
            }
        }

        function marcarEtapa(numero, status) {
            const etapa = document.getElementById(`etapa-${numero}`);
            etapa.className = `step ${status}`;
        }

        function normalizarTelefone(telefone) {
            return telefone.toString().replace(/\D/g, '');
        }

        // ETAPA 1: Inicializar Firebase Service
        async function inicializarFirebaseService() {
            log("üî• ETAPA 1: Inicializando Firebase Service...");
            marcarEtapa(1, 'running');
            
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o carregado');
                }
                
                db = firebase.firestore();
                
                if (typeof FirebaseService !== 'undefined') {
                    firebaseService = new FirebaseService();
                    log("‚úÖ Firebase Service instanciado");
                } else {
                    log("‚ö†Ô∏è Usando fallback para Firebase Service");
                    firebaseService = {
                        db: db,
                        async salvarCartela(cartela) {
                            log(`üìù [FALLBACK] Salvando cartela: ${cartela.id}`);
                            const cartelaCompleta = {
                                ...cartela,
                                dataGravacao: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            const docRef = await this.db.collection('cartelas').doc(cartelaCompleta.id).set(cartelaCompleta);
                            log(`‚úÖ [FALLBACK] Cartela salva: ${cartelaCompleta.id}`);
                            return cartelaCompleta.id;
                        },
                        async carregarConfiguracoes() {
                            return {
                                numeroInicial: 1,
                                numeroFinal: 75,
                                precoCartela: 5.00
                            };
                        }
                    };
                }

                marcarEtapa(1, 'completed');
                log("‚úÖ ETAPA 1 CONCLU√çDA");
                return true;

            } catch (error) {
                log(`‚ùå ETAPA 1 FALHOU: ${error.message}`);
                marcarEtapa(1, 'failed');
                throw error;
            }
        }

        // ETAPA 2: Carregar Configura√ß√µes
        async function carregarConfiguracoes() {
            log("‚öôÔ∏è ETAPA 2: Carregando configura√ß√µes...");
            marcarEtapa(2, 'running');
            
            try {
                configuracoes = await firebaseService.carregarConfiguracoes();
                log(`‚úÖ Configura√ß√µes carregadas: ${JSON.stringify(configuracoes)}`);
                
                marcarEtapa(2, 'completed');
                log("‚úÖ ETAPA 2 CONCLU√çDA");
                return configuracoes;

            } catch (error) {
                log(`‚ùå ETAPA 2 FALHOU: ${error.message}`);
                configuracoes = {
                    numeroInicial: 1,
                    numeroFinal: 75,
                    precoCartela: 5.00
                };
                log("üîß Usando configura√ß√µes padr√£o");
                marcarEtapa(2, 'completed');
                return configuracoes;
            }
        }

        // ETAPA 3: Gerar Cartela
        function gerarCartela() {
            log("üé≤ ETAPA 3: Gerando cartela...");
            marcarEtapa(3, 'running');
            
            try {
                const inicial = configuracoes.numeroInicial || 1;
                const final = configuracoes.numeroFinal || 75;
                
                // Gerar n√∫meros simplificados para teste
                const numeros = [
                    [1, 2, 3, 4, 5],
                    [16, 17, 18, 19, 20],
                    [31, 'FREE', 33, 34, 35],
                    [46, 47, 48, 49, 50],
                    [61, 62, 63, 64, 65]
                ];

                cartelaAtual = {
                    id: Date.now(),
                    numeros: numeros,
                    preco: configuracoes.precoCartela || 5.00
                };

                log(`‚úÖ Cartela gerada: ID=${cartelaAtual.id}, Pre√ßo=R$${cartelaAtual.preco}`);
                marcarEtapa(3, 'completed');
                log("‚úÖ ETAPA 3 CONCLU√çDA");
                return cartelaAtual;

            } catch (error) {
                log(`‚ùå ETAPA 3 FALHOU: ${error.message}`);
                marcarEtapa(3, 'failed');
                throw error;
            }
        }

        // ETAPA 4: Simular Adi√ß√£o ao Carrinho
        function adicionarAoCarrinho() {
            log("üõí ETAPA 4: Adicionando ao carrinho...");
            marcarEtapa(4, 'running');
            
            try {
                if (!cartelaAtual) {
                    throw new Error('Nenhuma cartela gerada');
                }

                carrinho = [cartelaAtual]; // Simular carrinho com 1 cartela
                log(`‚úÖ Cartela adicionada ao carrinho. Total: ${carrinho.length} cartela(s)`);
                
                marcarEtapa(4, 'completed');
                log("‚úÖ ETAPA 4 CONCLU√çDA");
                return carrinho;

            } catch (error) {
                log(`‚ùå ETAPA 4 FALHOU: ${error.message}`);
                marcarEtapa(4, 'failed');
                throw error;
            }
        }

        // ETAPA 5: Preparar Dados da Compra
        function prepararDadosCompra() {
            log("üìù ETAPA 5: Preparando dados da compra...");
            marcarEtapa(5, 'running');
            
            try {
                const comprador = {
                    nome: "Monitor Teste",
                    telefone: "85999777888",
                    email: "monitor@teste.com"
                };

                const cartelasParaSalvar = carrinho.map(item => ({
                    id: `cartela_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    numeros: item.numeros,
                    preco: item.preco,
                    vendida: true,
                    comprador: comprador.nome,
                    telefone: normalizarTelefone(comprador.telefone),
                    email: comprador.email,
                    dataVenda: new Date().toISOString(),
                    timestamp: new Date(),
                    origem: "monitoramento-teste"
                }));

                log(`‚úÖ Dados preparados: ${cartelasParaSalvar.length} cartela(s)`);
                log(`üë§ Comprador: ${comprador.nome} | Telefone: ${normalizarTelefone(comprador.telefone)}`);
                log(`üìù Primeira cartela: ${JSON.stringify(cartelasParaSalvar[0], null, 2)}`);
                
                marcarEtapa(5, 'completed');
                log("‚úÖ ETAPA 5 CONCLU√çDA");
                return { comprador, cartelasParaSalvar };

            } catch (error) {
                log(`‚ùå ETAPA 5 FALHOU: ${error.message}`);
                marcarEtapa(5, 'failed');
                throw error;
            }
        }

        // ETAPA 6: Salvar no Firebase
        async function salvarNoFirebase(cartelasParaSalvar) {
            log("üíæ ETAPA 6: Salvando no Firebase...");
            marcarEtapa(6, 'running');
            
            const idsCartelas = [];
            let salvoComSucesso = false;

            try {
                for (let i = 0; i < cartelasParaSalvar.length; i++) {
                    const cartela = cartelasParaSalvar[i];
                    log(`üíæ Salvando cartela ${i + 1}/${cartelasParaSalvar.length}: ${cartela.id}`);
                    
                    // Log detalhado dos dados sendo salvos
                    log(`üìã Dados completos da cartela:`);
                    log(JSON.stringify(cartela, null, 2));
                    
                    try {
                        const idSalvo = await firebaseService.salvarCartela(cartela);
                        idsCartelas.push(idSalvo);
                        log(`‚úÖ Cartela ${cartela.id} salva com ID: ${idSalvo}`);
                        
                        // Verifica√ß√£o individual imediata
                        log(`üîç Verificando cartela ${idSalvo} imediatamente...`);
                        try {
                            const verificacao = await db.collection('cartelas').doc(idSalvo || cartela.id).get();
                            if (verificacao.exists) {
                                log(`‚úÖ Cartela ${idSalvo} confirmada no banco`);
                            } else {
                                log(`‚ö†Ô∏è Cartela ${idSalvo} n√£o encontrada na verifica√ß√£o imediata`);
                            }
                        } catch (verifError) {
                            log(`‚ùå Erro na verifica√ß√£o individual: ${verifError.message}`);
                        }
                        
                    } catch (cartError) {
                        log(`‚ùå Erro ao salvar cartela ${cartela.id}: ${cartError.message}`);
                        log(`‚ùå Stack trace: ${cartError.stack}`);
                        throw cartError;
                    }
                }
                
                salvoComSucesso = true;
                log(`‚úÖ Todas as ${cartelasParaSalvar.length} cartelas processadas`);
                
                marcarEtapa(6, 'completed');
                log("‚úÖ ETAPA 6 CONCLU√çDA");
                return idsCartelas;

            } catch (error) {
                log(`‚ùå ETAPA 6 FALHOU: ${error.message}`);
                log(`‚ùå Stack completo: ${error.stack}`);
                marcarEtapa(6, 'failed');
                throw error;
            }
        }

        // ETAPA 7: Verificar Grava√ß√£o
        async function verificarGravacao(cartelasParaSalvar) {
            log("üîç ETAPA 7: Verificando grava√ß√£o no Firebase...");
            marcarEtapa(7, 'running');
            
            try {
                // Aguardar propaga√ß√£o
                log("‚è≥ Aguardando 3 segundos para propaga√ß√£o...");
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Buscar por origem
                log("üîç Buscando cartelas por origem 'monitoramento-teste'...");
                const snapshotOrigem = await db.collection('cartelas').where('origem', '==', 'monitoramento-teste').get();
                log(`üìä Cartelas encontradas por origem: ${snapshotOrigem.size}`);
                
                // Buscar por telefone
                log("üîç Buscando cartelas por telefone '85999777888'...");
                const snapshotTelefone = await db.collection('cartelas').where('telefone', '==', '85999777888').get();
                log(`üìä Cartelas encontradas por telefone: ${snapshotTelefone.size}`);
                
                // Buscar por comprador
                log("üîç Buscando cartelas por comprador 'Monitor Teste'...");
                const snapshotComprador = await db.collection('cartelas').where('comprador', '==', 'Monitor Teste').get();
                log(`üìä Cartelas encontradas por comprador: ${snapshotComprador.size}`);
                
                // Resultado final
                const totalEncontradas = Math.max(snapshotOrigem.size, snapshotTelefone.size, snapshotComprador.size);
                const sucesso = totalEncontradas >= cartelasParaSalvar.length;
                
                if (sucesso) {
                    log(`‚úÖ VERIFICA√á√ÉO SUCESSO: ${totalEncontradas} cartela(s) encontrada(s)`);
                    marcarEtapa(7, 'completed');
                } else {
                    log(`‚ö†Ô∏è VERIFICA√á√ÉO PARCIAL: ${totalEncontradas}/${cartelasParaSalvar.length} cartela(s) encontrada(s)`);
                    marcarEtapa(7, 'failed');
                }
                
                log("‚úÖ ETAPA 7 CONCLU√çDA");
                return { totalEncontradas, sucesso };

            } catch (error) {
                log(`‚ùå ETAPA 7 FALHOU: ${error.message}`);
                marcarEtapa(7, 'failed');
                throw error;
            }
        }

        // Processo Completo
        async function executarProcessoCompleto() {
            log("üöÄ INICIANDO MONITORAMENTO COMPLETO DO PROCESSO DE COMPRA");
            log("=" * 60);
            
            try {
                // Etapa 1
                await inicializarFirebaseService();
                
                // Etapa 2
                await carregarConfiguracoes();
                
                // Etapa 3
                gerarCartela();
                
                // Etapa 4
                adicionarAoCarrinho();
                
                // Etapa 5
                const { comprador, cartelasParaSalvar } = prepararDadosCompra();
                
                // Etapa 6
                const idsCartelas = await salvarNoFirebase(cartelasParaSalvar);
                
                // Etapa 7
                const verificacao = await verificarGravacao(cartelasParaSalvar);
                
                log("=" * 60);
                log("üéâ PROCESSO COMPLETO FINALIZADO!");
                log(`üìä Resultado: ${verificacao.sucesso ? 'SUCESSO' : 'FALHA'}`);
                log(`üìã Cartelas encontradas: ${verificacao.totalEncontradas}/${cartelasParaSalvar.length}`);
                log(`üÜî IDs gerados: ${idsCartelas.join(', ')}`);
                
                if (verificacao.sucesso) {
                    alert("‚úÖ Processo completo com SUCESSO! Cartelas gravadas no Firebase.");
                } else {
                    alert("‚ö†Ô∏è Processo com PROBLEMAS. Verifique o log para detalhes.");
                }

            } catch (error) {
                log("=" * 60);
                log(`‚ùå PROCESSO FALHOU: ${error.message}`);
                log(`‚ùå Stack: ${error.stack}`);
                alert(`‚ùå Processo falhou: ${error.message}`);
            }
        }

        async function verificarFirebaseAposCompra() {
            log("üìä Verificando estado atual do Firebase...");
            
            try {
                if (!db) {
                    await inicializarFirebaseService();
                }

                const snapshot = await db.collection('cartelas').get();
                log(`üìã Total de cartelas no Firebase: ${snapshot.size}`);

                if (snapshot.size > 0) {
                    const cartelas = [];
                    snapshot.forEach(doc => {
                        cartelas.push({
                            id: doc.id,
                            data: doc.data()
                        });
                    });

                    log("üìã √öltimas 5 cartelas:");
                    cartelas.slice(-5).forEach(cartela => {
                        log(`   ${cartela.id}: ${cartela.data.comprador || 'Sem nome'} - ${cartela.data.origem || 'origem desconhecida'}`);
                    });
                } else {
                    log("üì≠ Nenhuma cartela encontrada no Firebase");
                }

            } catch (error) {
                log(`‚ùå Erro ao verificar Firebase: ${error.message}`);
            }
        }

        // Auto-inicializar
        window.addEventListener('load', () => {
            log("üöÄ Monitoramento de processo de compra iniciado");
            log("üìã Clique em 'Executar Processo Completo' para come√ßar");
        });
    </script>
</body>
</html>
