<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investiga√ß√£o Direta Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .debug-log {
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .button-group {
            margin: 10px 0;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn.danger {
            background-color: #dc3545;
        }
        .btn.danger:hover {
            background-color: #c82333;
        }
        .btn.success {
            background-color: #28a745;
        }
        .btn.success:hover {
            background-color: #218838;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .raw-data {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Investiga√ß√£o Direta Firebase</h1>
        <p>Diagn√≥stico profundo do banco de dados para identificar onde est√£o as cartelas</p>

        <div class="debug-section">
            <h3>Status da Conex√£o</h3>
            <div id="connectionStatus" class="status warning">Verificando conex√£o...</div>
        </div>

        <div class="button-group">
            <button class="btn" onclick="verificarConexaoFirebase()">1. Verificar Conex√£o Firebase</button>
            <button class="btn" onclick="listarTodasColecoes()">2. Listar Todas as Cole√ß√µes</button>
            <button class="btn" onclick="contarTodosDocumentos()">3. Contar Todos os Documentos</button>
            <button class="btn" onclick="listarCartelasCompletas()">4. Listar Cartelas Completas</button>
            <button class="btn success" onclick="analisarEstruturaDados()">5. Analisar Estrutura dos Dados</button>
        </div>

        <div class="button-group">
            <button class="btn" onclick="buscarPorTelefoneRaw()">Busca RAW por Telefone</button>
            <button class="btn" onclick="verificarIndices()">Verificar √çndices</button>
            <button class="btn danger" onclick="criarCartelaTesteDireto()">Criar Cartela de Teste</button>
            <button class="btn" onclick="limparLogs()">Limpar Logs</button>
        </div>

        <div class="debug-section">
            <h3>Log de Debug</h3>
            <div id="debugLog" class="debug-log"></div>
        </div>

        <div class="debug-section">
            <h3>Dados Brutos</h3>
            <div id="rawData" class="raw-data">Nenhum dado carregado ainda...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let debugLog = [];
        let allCartelas = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const logEntry = `[${timestamp}] ${emoji} ${message}`;
            debugLog.push(logEntry);
            
            const logElement = document.getElementById('debugLog');
            logElement.innerHTML = debugLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        function updateRawData(data) {
            document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
        }

        function updateConnectionStatus(status, type) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status;
            statusElement.className = `status ${type}`;
        }

        async function verificarConexaoFirebase() {
            log('üîç Verificando conex√£o com Firebase...');
            
            try {
                if (!firebase.apps.length) {
                    log('‚ùå Firebase n√£o inicializado!', 'error');
                    updateConnectionStatus('Firebase n√£o inicializado', 'error');
                    return false;
                }

                const db = firebase.firestore();
                log('‚úÖ Firebase conectado com sucesso');
                
                // Teste simples de conectividade
                const testDoc = await db.collection('test').doc('connection').get();
                log(`‚úÖ Teste de conectividade realizado - existe: ${testDoc.exists}`);
                
                updateConnectionStatus('Conectado e funcionando', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                updateConnectionStatus(`Erro: ${error.message}`, 'error');
                return false;
            }
        }

        async function listarTodasColecoes() {
            log('üìã Listando todas as cole√ß√µes...');
            
            try {
                const db = firebase.firestore();
                
                // Como n√£o podemos listar cole√ß√µes diretamente no cliente,
                // vamos tentar acessar as cole√ß√µes conhecidas
                const colecoesTeste = ['cartelas', 'numeros', 'sorteio', 'usuarios', 'vendas'];
                
                for (const nomeColecao of colecoesTeste) {
                    try {
                        const snapshot = await db.collection(nomeColecao).limit(1).get();
                        const total = snapshot.size;
                        log(`üìÅ Cole√ß√£o '${nomeColecao}': ${total > 0 ? 'EXISTS' : 'EMPTY'} (amostra: ${total})`);
                        
                        if (total > 0) {
                            const doc = snapshot.docs[0];
                            log(`   ‚îî Exemplo de documento: ${doc.id}`);
                            log(`   ‚îî Dados: ${JSON.stringify(doc.data()).substring(0, 100)}...`);
                        }
                    } catch (error) {
                        log(`‚ùå Erro ao acessar '${nomeColecao}': ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro ao listar cole√ß√µes: ${error.message}`, 'error');
            }
        }

        async function contarTodosDocumentos() {
            log('üî¢ Contando todos os documentos...');
            
            try {
                const db = firebase.firestore();
                
                // Contar cartelas
                const cartelasSnapshot = await db.collection('cartelas').get();
                const totalCartelas = cartelasSnapshot.size;
                log(`üìä Total de cartelas no banco: ${totalCartelas}`);
                
                // Contar cartelas vendidas
                const vendidasSnapshot = await db.collection('cartelas').where('vendida', '==', true).get();
                const totalVendidas = vendidasSnapshot.size;
                log(`üí∞ Total de cartelas vendidas: ${totalVendidas}`);
                
                // Contar por telefone espec√≠fico
                const telefoneSnapshot = await db.collection('cartelas')
                    .where('vendida', '==', true)
                    .where('telefoneComprador', '==', '85966666666')
                    .get();
                log(`üì± Cartelas para telefone 85966666666: ${telefoneSnapshot.size}`);
                
                const summary = {
                    total: totalCartelas,
                    vendidas: totalVendidas,
                    telefone85966666666: telefoneSnapshot.size
                };
                
                updateRawData(summary);
                
            } catch (error) {
                log(`‚ùå Erro ao contar documentos: ${error.message}`, 'error');
            }
        }

        async function listarCartelasCompletas() {
            log('üìã Listando cartelas completas...');
            
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('cartelas').limit(20).get();
                
                log(`üìä Encontradas ${snapshot.size} cartelas (primeiras 20)`);
                
                const cartelas = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    cartelas.push({
                        id: doc.id,
                        ...data
                    });
                    
                    log(`üéØ Cartela ${doc.id}:`);
                    log(`   ‚îî Vendida: ${data.vendida || false}`);
                    log(`   ‚îî Nome: ${data.nomeComprador || 'N/A'}`);
                    log(`   ‚îî Telefone: ${data.telefoneComprador || 'N/A'}`);
                    log(`   ‚îî N√∫meros: ${data.numeros ? data.numeros.length : 0} n√∫meros`);
                });
                
                allCartelas = cartelas;
                updateRawData(cartelas);
                
            } catch (error) {
                log(`‚ùå Erro ao listar cartelas: ${error.message}`, 'error');
            }
        }

        async function analisarEstruturaDados() {
            log('üîç Analisando estrutura dos dados...');
            
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('cartelas').limit(10).get();
                
                log(`üìä Analisando ${snapshot.size} cartelas para estrutura`);
                
                const estruturas = {};
                const telefones = new Set();
                const nomes = new Set();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Analisar campos presentes
                    const campos = Object.keys(data);
                    const chaveEstrutura = campos.sort().join(',');
                    
                    if (!estruturas[chaveEstrutura]) {
                        estruturas[chaveEstrutura] = {
                            count: 0,
                            exemplos: []
                        };
                    }
                    
                    estruturas[chaveEstrutura].count++;
                    if (estruturas[chaveEstrutura].exemplos.length < 3) {
                        estruturas[chaveEstrutura].exemplos.push({
                            id: doc.id,
                            data: data
                        });
                    }
                    
                    // Coletar telefones e nomes √∫nicos
                    if (data.telefoneComprador) {
                        telefones.add(data.telefoneComprador);
                    }
                    if (data.nomeComprador) {
                        nomes.add(data.nomeComprador);
                    }
                });
                
                log(`üì± Telefones √∫nicos encontrados: ${telefones.size}`);
                telefones.forEach(tel => log(`   ‚îî ${tel}`));
                
                log(`üë§ Nomes √∫nicos encontrados: ${nomes.size}`);
                nomes.forEach(nome => log(`   ‚îî ${nome}`));
                
                log(`üèóÔ∏è Estruturas de dados encontradas: ${Object.keys(estruturas).length}`);
                Object.entries(estruturas).forEach(([estrutura, info]) => {
                    log(`   ‚îî Estrutura (${info.count}x): [${estrutura}]`);
                });
                
                const analise = {
                    estruturas: estruturas,
                    telefonesUnicos: Array.from(telefones),
                    nomesUnicos: Array.from(nomes)
                };
                
                updateRawData(analise);
                
            } catch (error) {
                log(`‚ùå Erro na an√°lise: ${error.message}`, 'error');
            }
        }

        async function buscarPorTelefoneRaw() {
            log('üîç Busca RAW por telefone 85966666666...');
            
            try {
                const db = firebase.firestore();
                
                // M√∫ltiplas consultas RAW
                const consultas = [
                    { desc: 'Busca exata', query: db.collection('cartelas').where('telefoneComprador', '==', '85966666666') },
                    { desc: 'Busca com vendida=true', query: db.collection('cartelas').where('telefoneComprador', '==', '85966666666').where('vendida', '==', true) },
                    { desc: 'Busca todas vendidas', query: db.collection('cartelas').where('vendida', '==', true) }
                ];
                
                for (const consulta of consultas) {
                    log(`üîé ${consulta.desc}...`);
                    const snapshot = await consulta.query.get();
                    log(`   ‚îî Resultado: ${snapshot.size} documentos`);
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        log(`   ‚îî Doc ${doc.id}: tel=${data.telefoneComprador}, vendida=${data.vendida}, nome=${data.nomeComprador}`);
                    });
                }
                
            } catch (error) {
                log(`‚ùå Erro na busca RAW: ${error.message}`, 'error');
            }
        }

        async function verificarIndices() {
            log('üìá Verificando √≠ndices e consultas...');
            
            try {
                const db = firebase.firestore();
                
                // Testar consultas que podem precisar de √≠ndices
                const testesIndice = [
                    { desc: 'Consulta por telefoneComprador', query: db.collection('cartelas').where('telefoneComprador', '==', '85966666666') },
                    { desc: 'Consulta composta telefone+vendida', query: db.collection('cartelas').where('telefoneComprador', '==', '85966666666').where('vendida', '==', true) },
                    { desc: 'Ordena√ß√£o por timestamp', query: db.collection('cartelas').orderBy('timestamp') }
                ];
                
                for (const teste of testesIndice) {
                    try {
                        log(`üß™ Testando: ${teste.desc}`);
                        const snapshot = await teste.query.limit(1).get();
                        log(`   ‚úÖ Sucesso: ${snapshot.size} resultado(s)`);
                    } catch (error) {
                        log(`   ‚ùå Falha: ${error.message}`, 'error');
                        if (error.message.includes('index')) {
                            log(`   üí° Pode precisar de √≠ndice!`, 'warning');
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro ao verificar √≠ndices: ${error.message}`, 'error');
            }
        }

        async function criarCartelaTesteDireto() {
            log('üß™ Criando cartela de teste diretamente...');
            
            try {
                const db = firebase.firestore();
                
                const cartelaTeste = {
                    numero: 999,
                    numeros: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                    vendida: true,
                    nomeComprador: 'TESTE DIRETO',
                    telefoneComprador: '85966666666',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    pre√ßo: 10.00,
                    testeDireto: true
                };
                
                const docRef = await db.collection('cartelas').add(cartelaTeste);
                log(`‚úÖ Cartela de teste criada com ID: ${docRef.id}`);
                
                // Imediatamente tentar buscar
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
                
                const buscaTeste = await db.collection('cartelas')
                    .where('telefoneComprador', '==', '85966666666')
                    .where('testeDireto', '==', true)
                    .get();
                
                log(`üîç Busca imediata p√≥s-cria√ß√£o: ${buscaTeste.size} resultado(s)`);
                
            } catch (error) {
                log(`‚ùå Erro ao criar cartela teste: ${error.message}`, 'error');
            }
        }

        function limparLogs() {
            debugLog = [];
            document.getElementById('debugLog').innerHTML = '';
            document.getElementById('rawData').textContent = 'Logs limpos...';
            log('üßπ Logs limpos');
        }

        // Inicializa√ß√£o
        window.onload = async function() {
            log('üöÄ Iniciando investiga√ß√£o direta do Firebase...');
            await verificarConexaoFirebase();
        };
    </script>
</body>
</html>
