<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste Espec√≠fico - P√°gina Principal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .resultado {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 13px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        .erro { background: #f44336; }
        .sucesso { background: #4CAF50; }
        .info { background: #2196F3; }
        .warning { background: #ff9800; }
        
        .formulario {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        .carrinho {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste Espec√≠fico - Fluxo da P√°gina Principal</h1>
        <p>Este teste replica exatamente o que acontece na p√°gina <code>cartelas.html</code>.</p>
        
        <div>
            <button onclick="gerarCartelaCompleta()">üé≤ Gerar Nova Cartela</button>
            <button onclick="adicionarAoCarrinho()" id="btn-adicionar" disabled>üõí Adicionar ao Carrinho</button>
            <button onclick="limparCarrinho()">üßπ Limpar Carrinho</button>
        </div>
        
        <div class="carrinho">
            <h3>üõí Carrinho de Compras</h3>
            <div id="carrinho-display">
                <p>Carrinho vazio</p>
            </div>
            <p><strong>Total: <span id="total">R$ 0,00</span></strong></p>
        </div>
        
        <div class="formulario">
            <h3>üë§ Dados do Comprador</h3>
            <input type="text" id="nome" placeholder="Nome completo" value="Teste Usuario Completo">
            <input type="tel" id="telefone" placeholder="Telefone" value="(11) 99999-8888">
            <button onclick="finalizarCompraCompleta()" id="btn-finalizar" disabled>üí≥ Finalizar Compra</button>
        </div>
        
        <div id="resultados"></div>
    </div>

    <!-- Exatos scripts da p√°gina principal -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
    
    <script>
        let resultadosDiv;
        let cartelaAtual = null;
        let carrinho = [];
        
        window.addEventListener('DOMContentLoaded', () => {
            resultadosDiv = document.getElementById('resultados');
            log('üöÄ P√°gina carregada, aguardando Firebase...');
            
            // Aguardar Firebase
            setTimeout(() => {
                if (window.FirebaseDB) {
                    log('‚úÖ Firebase conectado com sucesso!');
                } else {
                    log('‚ùå Firebase n√£o conectado!', 'erro');
                }
            }, 2000);
        });
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'erro' ? 'erro' : type === 'sucesso' ? 'sucesso' : type === 'warning' ? 'warning' : 'info';
            
            resultadosDiv.innerHTML += `
                <div class="resultado ${className}">
                    [${timestamp}] ${message}
                </div>
            `;
            
            console.log(`[${timestamp}] ${message}`);
            resultadosDiv.scrollTop = resultadosDiv.scrollHeight;
        }
        
        // FUNCIONALIDADE 1: Gerar cartela (igual √† p√°gina principal)
        function gerarCartelaCompleta() {
            log('üé≤ === GERANDO NOVA CARTELA ===');
            
            try {
                // Gerar n√∫meros aleat√≥rios
                const numeros = [];
                for (let i = 0; i < 15; i++) {
                    let numero;
                    do {
                        numero = Math.floor(Math.random() * 75) + 1;
                    } while (numeros.includes(numero));
                    numeros.push(numero);
                }
                numeros.sort((a, b) => a - b);
                
                // Criar objeto cartela
                cartelaAtual = {
                    id: `CART-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                    numeros: numeros,
                    preco: 5.00,
                    status: 'no-carrinho'
                };
                
                log(`‚úÖ Cartela gerada: ${cartelaAtual.id}`);
                log(`üî¢ N√∫meros: [${cartelaAtual.numeros.join(', ')}]`);
                
                // Habilitar bot√£o adicionar
                document.getElementById('btn-adicionar').disabled = false;
                
                log('‚úÖ Bot√£o "Adicionar ao Carrinho" habilitado', 'sucesso');
                
            } catch (error) {
                log(`‚ùå Erro ao gerar cartela: ${error.message}`, 'erro');
            }
        }
        
        // FUNCIONALIDADE 2: Adicionar ao carrinho (igual √† p√°gina principal)
        function adicionarAoCarrinho() {
            log('üõí === ADICIONANDO AO CARRINHO ===');
            
            try {
                if (!cartelaAtual) {
                    log('‚ùå Nenhuma cartela gerada!', 'erro');
                    return;
                }
                
                // Adicionar ao carrinho
                carrinho.push({...cartelaAtual});
                log(`‚úÖ Cartela ${cartelaAtual.id} adicionada ao carrinho`);
                log(`üìä Total de cartelas no carrinho: ${carrinho.length}`);
                
                // Atualizar display do carrinho
                atualizarCarrinhoDisplay();
                
                // Resetar cartela atual
                cartelaAtual = null;
                document.getElementById('btn-adicionar').disabled = true;
                
                // Habilitar finalizar compra
                document.getElementById('btn-finalizar').disabled = false;
                
                log('‚úÖ Carrinho atualizado e bot√£o "Finalizar Compra" habilitado', 'sucesso');
                
            } catch (error) {
                log(`‚ùå Erro ao adicionar ao carrinho: ${error.message}`, 'erro');
            }
        }
        
        function atualizarCarrinhoDisplay() {
            const display = document.getElementById('carrinho-display');
            const total = document.getElementById('total');
            
            if (carrinho.length === 0) {
                display.innerHTML = '<p>Carrinho vazio</p>';
                total.textContent = 'R$ 0,00';
                return;
            }
            
            display.innerHTML = carrinho.map((cartela, index) => 
                `<p>${index + 1}. Cartela ${cartela.id} - R$ ${cartela.preco.toFixed(2)}</p>`
            ).join('');
            
            const totalValue = carrinho.reduce((sum, cartela) => sum + cartela.preco, 0);
            total.textContent = `R$ ${totalValue.toFixed(2)}`;
        }
        
        function limparCarrinho() {
            log('üßπ Limpando carrinho...');
            carrinho = [];
            atualizarCarrinhoDisplay();
            document.getElementById('btn-finalizar').disabled = true;
            log('‚úÖ Carrinho limpo');
        }
        
        // FUNCIONALIDADE 3: Finalizar compra (igual √† p√°gina principal)
        async function finalizarCompraCompleta() {
            log('üí≥ === FINALIZANDO COMPRA ===');
            
            try {
                // Validar dados
                const nome = document.getElementById('nome').value.trim();
                const telefone = document.getElementById('telefone').value.trim();
                
                if (!nome) {
                    log('‚ùå Nome √© obrigat√≥rio!', 'erro');
                    return;
                }
                
                if (!telefone) {
                    log('‚ùå Telefone √© obrigat√≥rio!', 'erro');
                    return;
                }
                
                if (carrinho.length === 0) {
                    log('‚ùå Carrinho vazio!', 'erro');
                    return;
                }
                
                log(`üë§ Comprador: ${nome}`);
                log(`üì± Telefone: ${telefone}`);
                log(`üõí Cartelas no carrinho: ${carrinho.length}`);
                
                // Preparar dados para salvar (EXATO COMO NA P√ÅGINA PRINCIPAL)
                const cartelasParaSalvar = carrinho.map((cartela, index) => {
                    const cartelaPreparada = {
                        id: cartela.id,
                        numeros: cartela.numeros,
                        preco: cartela.preco,
                        status: 'vendida',
                        comprador: {
                            nome: nome,
                            telefone: telefone
                        },
                        nome: nome,
                        telefone: telefone,
                        dataCompra: new Date(),
                        timestamp: Date.now()
                    };
                    
                    log(`üìã Cartela ${index + 1} preparada para salvar:`, 'info');
                    log(`   ID: ${cartelaPreparada.id}`);
                    log(`   N√∫meros: [${cartelaPreparada.numeros.join(', ')}]`);
                    log(`   Comprador: ${cartelaPreparada.comprador.nome}`);
                    log(`   Telefone: ${cartelaPreparada.comprador.telefone}`);
                    
                    return cartelaPreparada;
                });
                
                // Salvar no Firebase (USANDO MESMO M√âTODO DA P√ÅGINA PRINCIPAL)
                log('üî• Iniciando grava√ß√£o no Firebase...');
                
                if (!window.FirebaseDB) {
                    throw new Error('FirebaseDB n√£o dispon√≠vel');
                }
                
                let sucessos = 0;
                let erros = 0;
                
                for (let i = 0; i < cartelasParaSalvar.length; i++) {
                    const cartela = cartelasParaSalvar[i];
                    log(`üíæ Salvando cartela ${i + 1}/${cartelasParaSalvar.length}: ${cartela.id}`);
                    
                    try {
                        log('üî• Usando m√©todo FirebaseDB.saveCartela CORRIGIDO (m√©todo do admin)');
                        const resultado = await window.FirebaseDB.saveCartela(cartela);
                        
                        if (resultado.success) {
                            log(`‚úÖ Cartela ${cartela.id} salva com ID Firebase: ${resultado.id}`, 'sucesso');
                            sucessos++;
                        } else {
                            throw new Error('Falha ao salvar cartela');
                        }
                        
                    } catch (error) {
                        log(`‚ùå Erro ao salvar cartela ${cartela.id}: ${error.message}`, 'erro');
                        erros++;
                    }
                }
                
                // Resultado final
                log(`üìä RESULTADO FINAL: ${sucessos} sucessos, ${erros} erros`);
                
                if (sucessos > 0) {
                    log('üéâ COMPRA FINALIZADA COM SUCESSO!', 'sucesso');
                    log(`‚úÖ ${sucessos} cartela(s) salva(s) no Firebase`);
                    
                    // Limpar carrinho
                    carrinho = [];
                    atualizarCarrinhoDisplay();
                    document.getElementById('btn-finalizar').disabled = true;
                    
                } else {
                    log('üí• NENHUMA CARTELA FOI SALVA!', 'erro');
                }
                
            } catch (error) {
                log(`üí• Erro durante finaliza√ß√£o: ${error.message}`, 'erro');
            }
        }
    </script>
</body>
</html>
