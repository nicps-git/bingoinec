<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TESTE FOR√áADO - Grava√ß√£o Direta Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(45deg, #ffcdd2, #f8bbd9);
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .test-box {
            margin: 15px 0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .success { border-color: #4CAF50; background: #e8f5e8; }
        .error { border-color: #f44336; background: #ffeaea; }
        .warning { border-color: #FF9800; background: #fff8e1; }
        
        button {
            padding: 15px 30px;
            margin: 10px 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .btn-force { background: #f44336; color: white; }
        .btn-test { background: #2196F3; color: white; }
        .btn-check { background: #4CAF50; color: white; }
        
        .console-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-ok { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-warning { background: #FF9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® TESTE FOR√áADO - Grava√ß√£o Direta Firebase</h1>
        <p><strong>Este teste for√ßa a grava√ß√£o ignorando todo o sistema</strong></p>
        
        <div class="test-box">
            <h3>üéØ Status dos Componentes</h3>
            <div id="component-status">
                <p><span class="status-indicator status-warning"></span> Verificando...</p>
            </div>
        </div>
        
        <div class="test-box">
            <h3>üî• Testes de For√ßa</h3>
            <button class="btn-test" onclick="testarSDK()">1Ô∏è‚É£ Testar SDK Firebase</button>
            <button class="btn-test" onclick="testarDB()">2Ô∏è‚É£ Testar Database</button>
            <button class="btn-force" onclick="forcarGravacao()">3Ô∏è‚É£ FOR√áAR GRAVA√á√ÉO</button>
            <button class="btn-check" onclick="verificarCartelas()">4Ô∏è‚É£ Verificar Cartelas Salvas</button>
            <button onclick="limparConsole()">üßπ Limpar</button>
        </div>
        
        <div class="test-box">
            <h3>üì∫ Console Output</h3>
            <div id="console-output" class="console-output">Aguardando comandos...</div>
        </div>
    </div>

    <!-- Firebase SDK v8 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <script>
        let consoleLines = [];
        
        function addToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': '[INFO]',
                'success': '[SUCCESS]',
                'error': '[ERROR]',
                'warning': '[WARNING]',
                'debug': '[DEBUG]'
            }[type] || '[INFO]';
            
            const line = `${timestamp} ${prefix} ${message}`;
            consoleLines.push(line);
            
            // Tamb√©m logar no console real
            console.log(line);
            
            // Atualizar display
            const output = document.getElementById('console-output');
            output.textContent = consoleLines.join('\n');
            output.scrollTop = output.scrollHeight;
        }
        
        function limparConsole() {
            consoleLines = [];
            document.getElementById('console-output').textContent = 'Console limpo...';
        }
        
        function updateComponentStatus(firebase_ok, firebasedb_ok, db_ok) {
            const statusDiv = document.getElementById('component-status');
            
            const firebaseIcon = firebase_ok ? 'status-ok' : 'status-error';
            const firebasedbIcon = firebasedb_ok ? 'status-ok' : 'status-error';
            const dbIcon = db_ok ? 'status-ok' : 'status-error';
            
            statusDiv.innerHTML = `
                <p><span class="status-indicator ${firebaseIcon}"></span> Firebase SDK: ${firebase_ok ? 'OK' : 'ERRO'}</p>
                <p><span class="status-indicator ${firebasedbIcon}"></span> FirebaseDB: ${firebasedb_ok ? 'OK' : 'ERRO'}</p>
                <p><span class="status-indicator ${dbIcon}"></span> Database: ${db_ok ? 'OK' : 'ERRO'}</p>
            `;
        }
        
        async function testarSDK() {
            addToConsole('=== TESTE 1: SDK FIREBASE ===');
            
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o carregado');
                }
                
                addToConsole(`SDK Firebase dispon√≠vel v${firebase.SDK_VERSION || 'desconhecida'}`, 'success');
                addToConsole(`Apps inicializados: ${firebase.apps.length}`);
                
                if (firebase.apps.length > 0) {
                    const app = firebase.apps[0];
                    addToConsole(`App principal: ${app.name}`, 'success');
                    addToConsole(`Projeto: ${app.options.projectId}`, 'success');
                }
                
                updateComponentStatus(true, !!window.FirebaseDB, false);
                
            } catch (error) {
                addToConsole(`ERRO no SDK: ${error.message}`, 'error');
                updateComponentStatus(false, false, false);
            }
        }
        
        async function testarDB() {
            addToConsole('=== TESTE 2: DATABASE ===');
            
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o dispon√≠vel');
                }
                
                // Criar inst√¢ncia do Firestore
                const db = firebase.firestore();
                addToConsole('Inst√¢ncia Firestore criada', 'success');
                
                // Testar opera√ß√£o b√°sica
                const testRef = db.collection('teste-forca').doc('teste-conexao');
                await testRef.set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    teste: 'conexao-forcada',
                    numero: Math.floor(Math.random() * 1000)
                });
                
                addToConsole('GRAVA√á√ÉO DE TESTE REALIZADA!', 'success');
                
                // Tentar ler de volta
                const doc = await testRef.get();
                if (doc.exists) {
                    addToConsole('LEITURA DE TESTE REALIZADA!', 'success');
                    addToConsole(`Dados lidos: ${JSON.stringify(doc.data())}`, 'debug');
                } else {
                    addToConsole('Documento n√£o encontrado ap√≥s grava√ß√£o', 'warning');
                }
                
                updateComponentStatus(true, !!window.FirebaseDB, true);
                
            } catch (error) {
                addToConsole(`ERRO na database: ${error.message}`, 'error');
                addToConsole(`C√≥digo: ${error.code}`, 'error');
                updateComponentStatus(true, !!window.FirebaseDB, false);
            }
        }
        
        async function forcarGravacao() {
            addToConsole('=== TESTE 3: FOR√áAR GRAVA√á√ÉO DE CARTELA ===');
            
            try {
                // M√âTODO 1: Tentar usar o sistema existente
                addToConsole('M√âTODO 1: Usando window.FirebaseDB.saveCartela');
                
                if (!window.FirebaseDB || typeof window.FirebaseDB.saveCartela !== 'function') {
                    addToConsole('window.FirebaseDB.saveCartela n√£o dispon√≠vel', 'warning');
                } else {
                    const cartelaForcada = {
                        id: `FORCADA-${Date.now()}`,
                        numeros: [1, 16, 31, 46, 61, 2, 17, 32, 47, 62, 3, 18, 33, 48, 63],
                        preco: 5.00,
                        status: 'vendida',
                        comprador: {
                            nome: 'Teste For√ßado',
                            telefone: '11999999999'
                        },
                        nome: 'Teste For√ßado',
                        telefone: '11999999999',
                        dataCompra: new Date(),
                        timestamp: Date.now()
                    };
                    
                    addToConsole(`Tentando salvar cartela: ${cartelaForcada.id}`, 'debug');
                    
                    try {
                        const resultado = await window.FirebaseDB.saveCartela(cartelaForcada);
                        addToConsole(`M√âTODO 1 SUCESSO! ID: ${resultado.id}`, 'success');
                    } catch (error1) {
                        addToConsole(`M√âTODO 1 FALHOU: ${error1.message}`, 'error');
                        addToConsole(`Stack: ${error1.stack}`, 'debug');
                    }
                }
                
                // M√âTODO 2: Grava√ß√£o direta no Firestore
                addToConsole('M√âTODO 2: Grava√ß√£o direta no Firestore');
                
                const db = firebase.firestore();
                const cartelaDireta = {
                    id: `DIRETA-${Date.now()}`,
                    numeros: [5, 20, 35, 50, 65, 6, 21, 36, 51, 66, 7, 22, 37, 52, 67],
                    preco: 5.00,
                    status: 'vendida',
                    comprador: {
                        nome: 'Grava√ß√£o Direta',
                        telefone: '11888888888'
                    },
                    nome: 'Grava√ß√£o Direta',
                    telefone: '11888888888',
                    dataCompra: new Date(),
                    timestamp: Date.now(),
                    timestampFirebase: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('cartelas').add(cartelaDireta);
                addToConsole(`M√âTODO 2 SUCESSO! Firebase ID: ${docRef.id}`, 'success');
                
                // Verificar se foi realmente salvo
                const doc = await docRef.get();
                if (doc.exists) {
                    addToConsole('VERIFICA√á√ÉO: Cartela existe no Firebase!', 'success');
                    const data = doc.data();
                    addToConsole(`Campos salvos: ${Object.keys(data).join(', ')}`, 'debug');
                } else {
                    addToConsole('VERIFICA√á√ÉO: Cartela N√ÉO encontrada!', 'error');
                }
                
            } catch (error) {
                addToConsole(`ERRO GERAL na grava√ß√£o for√ßada: ${error.message}`, 'error');
                addToConsole(`Stack completo: ${error.stack}`, 'debug');
            }
        }
        
        async function verificarCartelas() {
            addToConsole('=== TESTE 4: VERIFICAR CARTELAS SALVAS ===');
            
            try {
                const db = firebase.firestore();
                
                // Buscar todas as cartelas
                const snapshot = await db.collection('cartelas')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                addToConsole(`Total de cartelas encontradas: ${snapshot.size}`, 'success');
                
                if (snapshot.size > 0) {
                    snapshot.forEach((doc, index) => {
                        const data = doc.data();
                        addToConsole(`Cartela ${index + 1}: ID=${data.id}, Nome=${data.nome}, Status=${data.status}`, 'info');
                    });
                } else {
                    addToConsole('NENHUMA CARTELA ENCONTRADA NO FIREBASE!', 'warning');
                }
                
            } catch (error) {
                addToConsole(`ERRO ao verificar cartelas: ${error.message}`, 'error');
            }
        }
        
        // Auto-start
        window.addEventListener('load', async () => {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            addToConsole('üöÄ Sistema de teste for√ßado carregado');
            
            // Verificar componentes automaticamente
            const firebase_ok = typeof firebase !== 'undefined';
            const firebasedb_ok = !!window.FirebaseDB;
            const db_ok = false; // Ser√° testado depois
            
            updateComponentStatus(firebase_ok, firebasedb_ok, db_ok);
            
            if (firebase_ok) {
                addToConsole('Firebase SDK detectado', 'success');
            } else {
                addToConsole('Firebase SDK N√ÉO detectado', 'error');
            }
            
            if (firebasedb_ok) {
                addToConsole('FirebaseDB detectado', 'success');
            } else {
                addToConsole('FirebaseDB N√ÉO detectado', 'error');
            }
        });
        
        // Interceptar logs do console original
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (args[0] && typeof args[0] === 'string') {
                if (args[0].includes('FirebaseDB') || args[0].includes('cartela') || args[0].includes('Firebase')) {
                    addToConsole(`CONSOLE: ${args.join(' ')}`, 'debug');
                }
            }
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(`CONSOLE ERROR: ${args.join(' ')}`, 'error');
        };
    </script>
</body>
</html>
