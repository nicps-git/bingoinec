<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸª Bingo ArraiÃ¡ INEC - VERSÃƒO ROBUSTA</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- DecoraÃ§Ãµes de Festa Junina -->
    <div class="bandeirolas">
        <div class="bandeirola bandeirola-1"></div>
        <div class="bandeirola bandeirola-2"></div>
        <div class="bandeirola bandeirola-3"></div>
    </div>
    
    <div class="fogueira">
        <div class="fogo"></div>
        <div class="lenha"></div>
    </div>

    <header>
        <div class="logo-empresa">
            <img src="inec.png" alt="Logo INEC" class="logo-inec">
        </div>
        <div class="admin-link">
            <a href="#" onclick="verificarAcessoAdmin()" class="btn-admin">âš™ï¸ Admin</a>
        </div>
        <div class="cartelas-link">
            <a href="cartelas.html" class="btn-cartelas">ğŸ« Comprar</a>
            <a href="minhas-cartelas.html" class="btn-cartelas">ğŸ‘€ Minhas Cartelas</a>
        </div>
        <h1>ğŸŒ½ Bingo ArraiÃ¡ INEC ğŸŒ½</h1>
        <p>ğŸŠ Festa Junina com DiversÃ£o Garantida! ğŸŠ</p>
    </header>

    <main>
        <div class="bingo-card">
            <h2>ğŸ¯ NÃºmero Sorteado</h2>
            <div id="numero-sorteado" class="numero-destaque">Clique em Sortear</div>
            <button id="sortear-btn">ğŸ² Sortear</button>
        </div>
        
        <div class="barraca-bingo">
            <div class="numeros-sorteados">
                <h2>ğŸ“‹ NÃºmeros Anteriores</h2>
                <div class="contador">
                    <span id="contador-numeros">0</span> nÃºmeros sorteados
                </div>
                <ul id="numeros-anteriores"></ul>
            </div>
        </div>
        
        <!-- Debug Info -->
        <div style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-width: 300px; z-index: 9999;">
            <div id="debug-info">ğŸ”„ Carregando...</div>
        </div>
    </main>
    
    <div id="fogos"></div>

    <!-- Firebase SDK v8 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>

    <script>
        // ===== VERSÃƒO ROBUSTA E SIMPLIFICADA =====
        
        function verificarAcessoAdmin() {
            if (window.bingoAuth && window.bingoAuth.isAuthenticated()) {
                window.location.href = 'admin.html';
            } else {
                if (confirm('Para acessar a Ã¡rea administrativa, Ã© necessÃ¡rio fazer login. Deseja ir para a pÃ¡gina de login?')) {
                    window.location.href = 'login.html';
                }
            }
        }
        
        // Estado global simples
        let sistemaRobusto = {
            botao: null,
            numeroEl: null,
            listaEl: null,
            contadorEl: null,
            numerosSorteados: [],
            numerosDisponiveis: [],
            inicializado: false
        };
        
        // FunÃ§Ã£o de sorteio robusta
        function sortearNumeroRobusto() {
            console.log('ğŸ² sortearNumeroRobusto executada!');
            atualizarDebug('ğŸ² FunÃ§Ã£o executada!');
            
            if (sistemaRobusto.numerosDisponiveis.length === 0) {
                alert('Todos os nÃºmeros jÃ¡ foram sorteados!');
                return;
            }
            
            // Desabilitar botÃ£o temporariamente
            sistemaRobusto.botao.disabled = true;
            sistemaRobusto.botao.textContent = 'ğŸ² Sorteando...';
            
            // Sortear nÃºmero
            const randomIndex = Math.floor(Math.random() * sistemaRobusto.numerosDisponiveis.length);
            const numero = sistemaRobusto.numerosDisponiveis.splice(randomIndex, 1)[0];
            
            setTimeout(() => {
                // Atualizar display
                sistemaRobusto.numeroEl.textContent = numero;
                sistemaRobusto.numerosSorteados.push(numero);
                
                // Adicionar Ã  lista
                const li = document.createElement('li');
                li.textContent = numero;
                sistemaRobusto.listaEl.appendChild(li);
                
                // Atualizar contador
                sistemaRobusto.contadorEl.textContent = sistemaRobusto.numerosSorteados.length;
                
                // Salvar no Firebase (se disponÃ­vel)
                if (typeof window.firebaseService !== 'undefined') {
                    firebaseService.salvarNumeroSorteado(numero).catch(console.error);
                }
                
                // Reabilitar botÃ£o
                sistemaRobusto.botao.disabled = false;
                sistemaRobusto.botao.textContent = sistemaRobusto.numerosDisponiveis.length > 0 ? 
                                                  'ğŸ¯ PrÃ³ximo NÃºmero' : 'ğŸ‰ Fim!';
                
                console.log(`âœ… NÃºmero ${numero} sorteado. Restam ${sistemaRobusto.numerosDisponiveis.length}`);
                atualizarDebug(`âœ… Sorteado: ${numero}`);
                
            }, 1000);
        }
        
        function atualizarDebug(msg) {
            const debug = document.getElementById('debug-info');
            if (debug) {
                debug.innerHTML = `${new Date().toLocaleTimeString()}<br>${msg}<br>DisponÃ­veis: ${sistemaRobusto.numerosDisponiveis.length}`;
            }
        }
        
        // InicializaÃ§Ã£o robusta
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Iniciando versÃ£o robusta...');
            atualizarDebug('ğŸš€ Iniciando...');
            
            // Encontrar elementos
            sistemaRobusto.botao = document.getElementById('sortear-btn');
            sistemaRobusto.numeroEl = document.getElementById('numero-sorteado');
            sistemaRobusto.listaEl = document.getElementById('numeros-anteriores');
            sistemaRobusto.contadorEl = document.getElementById('contador-numeros');
            
            if (!sistemaRobusto.botao) {
                console.error('âŒ BotÃ£o sortear nÃ£o encontrado!');
                atualizarDebug('âŒ BotÃ£o nÃ£o encontrado!');
                return;
            }
            
            console.log('âœ… Elementos encontrados');
            atualizarDebug('âœ… Elementos OK');
            
            // Aguardar Firebase
            let tentativas = 0;
            const aguardarFirebase = setInterval(async () => {
                tentativas++;
                
                if (typeof window.firebaseService !== 'undefined') {
                    console.log('ğŸ”¥ Firebase detectado, carregando dados...');
                    atualizarDebug('ğŸ”¥ Carregando Firebase...');
                    
                    try {
                        const config = await firebaseService.carregarConfiguracoes();
                        const numerosSalvos = await firebaseService.carregarNumerosSorteados();
                        
                        // Configurar nÃºmeros
                        const inicio = config.numeroInicial || 1;
                        const fim = config.numeroFinal || 75;
                        const todos = Array.from({length: fim - inicio + 1}, (_, i) => i + inicio);
                        sistemaRobusto.numerosDisponiveis = todos.filter(n => !numerosSalvos.includes(n));
                        sistemaRobusto.numerosSorteados = numerosSalvos;
                        
                        // Restaurar interface
                        sistemaRobusto.listaEl.innerHTML = '';
                        numerosSalvos.forEach(num => {
                            const li = document.createElement('li');
                            li.textContent = num;
                            sistemaRobusto.listaEl.appendChild(li);
                        });
                        sistemaRobusto.contadorEl.textContent = numerosSalvos.length;
                        
                        console.log(`âœ… Dados carregados: ${numerosSalvos.length} sorteados, ${sistemaRobusto.numerosDisponiveis.length} disponÃ­veis`);
                        atualizarDebug('âœ… Dados Firebase OK');
                        
                    } catch (error) {
                        console.error('âŒ Erro Firebase:', error);
                        atualizarDebug('âš ï¸ Firebase erro, usando local');
                        
                        // Fallback local
                        sistemaRobusto.numerosDisponiveis = Array.from({length: 75}, (_, i) => i + 1);
                    }
                    
                    clearInterval(aguardarFirebase);
                    finalizarInicializacao();
                    
                } else if (tentativas >= 10) {
                    console.log('âš ï¸ Firebase nÃ£o carregou, usando configuraÃ§Ã£o local');
                    atualizarDebug('âš ï¸ Modo local');
                    sistemaRobusto.numerosDisponiveis = Array.from({length: 75}, (_, i) => i + 1);
                    clearInterval(aguardarFirebase);
                    finalizarInicializacao();
                }
            }, 500);
            
            function finalizarInicializacao() {
                // Configurar botÃ£o
                console.log('ğŸ”§ Configurando botÃ£o...');
                
                // Limpar listeners antigos
                const novoBotao = sistemaRobusto.botao.cloneNode(true);
                sistemaRobusto.botao.parentNode.replaceChild(novoBotao, sistemaRobusto.botao);
                sistemaRobusto.botao = novoBotao;
                
                // Adicionar listener
                sistemaRobusto.botao.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('ğŸ¯ CLIQUE DETECTADO!');
                    sortearNumeroRobusto();
                });
                
                // Habilitar botÃ£o
                if (sistemaRobusto.numerosDisponiveis.length > 0) {
                    sistemaRobusto.botao.disabled = false;
                    sistemaRobusto.botao.textContent = 'ğŸ² Sortear';
                    console.log('âœ… BotÃ£o habilitado');
                    atualizarDebug('âœ… Pronto para usar!');
                } else {
                    sistemaRobusto.botao.disabled = true;
                    sistemaRobusto.botao.textContent = 'ğŸ‰ Fim do Jogo!';
                    atualizarDebug('ğŸ‰ Jogo finalizado');
                }
                
                sistemaRobusto.inicializado = true;
                console.log('ğŸ‰ InicializaÃ§Ã£o concluÃ­da!');
            }
        });
    </script>
</body>
</html>
