<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Valida√ß√£o Final - Sistema de Cartelas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .resultado {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        .erro { background: #f44336; }
        .sucesso { background: #4CAF50; }
        .info { background: #2196F3; }
        .warning { background: #ff9800; }
        
        .status {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .status-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
        }
        
        .steps {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }
        
        .step-status {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .step-pending { background: #666; }
        .step-running { background: #ff9800; }
        .step-success { background: #4CAF50; }
        .step-error { background: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Valida√ß√£o Final - Sistema de Cartelas</h1>
        <p>Este teste valida todas as corre√ß√µes implementadas e simula o fluxo completo como na p√°gina principal.</p>
        
        <div class="status">
            <div class="status-item">
                <h4>üî• Firebase</h4>
                <div id="firebase-status">Verificando...</div>
            </div>
            <div class="status-item">
                <h4>üõí Carrinho</h4>
                <div id="carrinho-status">0 itens</div>
            </div>
            <div class="status-item">
                <h4>üíæ M√©todo</h4>
                <div id="metodo-status">Verificando...</div>
            </div>
        </div>
        
        <div class="steps">
            <h3>üìã Passos do Teste</h3>
            <div class="step" id="step-1">
                <div class="step-status step-pending">1</div>
                <div>Verificar inicializa√ß√£o do Firebase</div>
            </div>
            <div class="step" id="step-2">
                <div class="step-status step-pending">2</div>
                <div>Gerar cartela de teste</div>
            </div>
            <div class="step" id="step-3">
                <div class="step-status step-pending">3</div>
                <div>Adicionar ao carrinho com localStorage</div>
            </div>
            <div class="step" id="step-4">
                <div class="step-status step-pending">4</div>
                <div>Simular dados do comprador</div>
            </div>
            <div class="step" id="step-5">
                <div class="step-status step-pending">5</div>
                <div>Gravar cartela no Firebase usando m√©todo do admin</div>
            </div>
            <div class="step" id="step-6">
                <div class="step-status step-pending">6</div>
                <div>Verificar cartela no banco</div>
            </div>
            <div class="step" id="step-7">
                <div class="step-status step-pending">7</div>
                <div>Limpar carrinho e localStorage</div>
            </div>
        </div>
        
        <div>
            <button onclick="executarValidacaoCompleta()">üöÄ Executar Valida√ß√£o Completa</button>
            <button onclick="verificarCartelasFirebase()">üîç Verificar Cartelas no Firebase</button>
            <button onclick="limparTudo()">üßπ Limpar Tudo</button>
        </div>
        
        <div id="resultados"></div>
    </div>

    <!-- Scripts exatos da p√°gina principal -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
    
    <script>
        let resultadosDiv;
        let testCounter = 1;
        
        window.addEventListener('DOMContentLoaded', () => {
            resultadosDiv = document.getElementById('resultados');
            log('üöÄ Valida√ß√£o carregada');
            
            // Verificar status inicial
            setTimeout(verificarStatusInicial, 1000);
        });
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'erro' ? 'erro' : type === 'sucesso' ? 'sucesso' : type === 'warning' ? 'warning' : 'info';
            
            resultadosDiv.innerHTML += `
                <div class="resultado ${className}">
                    [${timestamp}] ${message}
                </div>
            `;
            
            console.log(`[${timestamp}] ${message}`);
            resultadosDiv.scrollTop = resultadosDiv.scrollHeight;
        }
        
        function verificarStatusInicial() {
            // Firebase
            if (window.FirebaseDB && typeof firebase !== 'undefined') {
                document.getElementById('firebase-status').innerHTML = '‚úÖ Conectado';
                document.getElementById('metodo-status').innerHTML = '‚úÖ saveCartela dispon√≠vel';
                log('‚úÖ Firebase inicializado corretamente', 'sucesso');
            } else {
                document.getElementById('firebase-status').innerHTML = '‚ùå N√£o conectado';
                document.getElementById('metodo-status').innerHTML = '‚ùå M√©todo n√£o dispon√≠vel';
                log('‚ùå Firebase n√£o dispon√≠vel', 'erro');
            }
            
            // Carrinho
            const carrinhoStorage = localStorage.getItem('bingo-carrinho');
            let carrinhoCount = 0;
            if (carrinhoStorage) {
                try {
                    carrinhoCount = JSON.parse(carrinhoStorage).length || 0;
                } catch {}
            }
            document.getElementById('carrinho-status').innerHTML = `${carrinhoCount} itens`;
        }
        
        function setStepStatus(stepNum, status) {
            const step = document.getElementById(`step-${stepNum}`);
            const statusEl = step.querySelector('.step-status');
            
            statusEl.className = `step-status step-${status}`;
            
            if (status === 'running') {
                statusEl.innerHTML = '‚è≥';
            } else if (status === 'success') {
                statusEl.innerHTML = '‚úÖ';
            } else if (status === 'error') {
                statusEl.innerHTML = '‚ùå';
            } else {
                statusEl.innerHTML = stepNum;
            }
        }
        
        async function executarValidacaoCompleta() {
            log('üéØ === INICIANDO VALIDA√á√ÉO COMPLETA ===');
            
            try {
                // Passo 1: Verificar Firebase
                setStepStatus(1, 'running');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (!window.FirebaseDB || typeof firebase === 'undefined') {
                    throw new Error('Firebase n√£o dispon√≠vel');
                }
                
                setStepStatus(1, 'success');
                log('‚úÖ Passo 1: Firebase verificado', 'sucesso');
                
                // Passo 2: Gerar cartela
                setStepStatus(2, 'running');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const cartela = {
                    id: `VALID-${Date.now()}-${testCounter}`,
                    numeros: Array.from({length: 15}, () => Math.floor(Math.random() * 75) + 1).sort((a, b) => a - b),
                    preco: 5.00,
                    status: 'vendida',
                    comprador: {
                        nome: `Teste Valida√ß√£o ${testCounter}`,
                        telefone: `(11) 99999-${String(testCounter).padStart(4, '0')}`
                    },
                    nome: `Teste Valida√ß√£o ${testCounter}`,
                    telefone: `(11) 99999-${String(testCounter).padStart(4, '0')}`,
                    dataCompra: new Date(),
                    timestamp: Date.now()
                };
                
                setStepStatus(2, 'success');
                log(`‚úÖ Passo 2: Cartela gerada - ${cartela.id}`, 'sucesso');
                
                // Passo 3: Adicionar ao carrinho com localStorage
                setStepStatus(3, 'running');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const carrinho = [cartela];
                localStorage.setItem('bingo-carrinho', JSON.stringify(carrinho));
                document.getElementById('carrinho-status').innerHTML = '1 item';
                
                setStepStatus(3, 'success');
                log('‚úÖ Passo 3: Cartela adicionada ao carrinho e localStorage', 'sucesso');
                
                // Passo 4: Dados do comprador (j√° inclusos)
                setStepStatus(4, 'running');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                setStepStatus(4, 'success');
                log(`‚úÖ Passo 4: Dados do comprador - ${cartela.comprador.nome}`, 'sucesso');
                
                // Passo 5: Gravar no Firebase usando m√©todo do admin
                setStepStatus(5, 'running');
                log('üíæ Gravando cartela no Firebase usando m√©todo do admin...');
                
                const resultado = await window.FirebaseDB.saveCartela(cartela);
                
                if (resultado.success) {
                    setStepStatus(5, 'success');
                    log(`‚úÖ Passo 5: Cartela gravada com ID ${resultado.id}`, 'sucesso');
                    
                    // Passo 6: Verificar no banco
                    setStepStatus(6, 'running');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const db = firebase.firestore();
                    const doc = await db.collection('cartelas').doc(resultado.id).get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        setStepStatus(6, 'success');
                        log('‚úÖ Passo 6: Cartela verificada no Firebase', 'sucesso');
                        log(`   ID: ${doc.id}`);
                        log(`   Comprador: ${data.nome || data.comprador?.nome}`);
                        log(`   Telefone: ${data.telefone || data.comprador?.telefone}`);
                        log(`   N√∫meros: ${data.numeros?.length} n√∫meros`);
                        log(`   Status: ${data.status}`);
                        log(`   Vendida: ${data.vendida ? 'Sim' : 'N√£o'}`);
                    } else {
                        throw new Error('Cartela n√£o encontrada no Firebase');
                    }
                    
                    // Passo 7: Limpar carrinho e localStorage
                    setStepStatus(7, 'running');
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    localStorage.removeItem('bingo-carrinho');
                    document.getElementById('carrinho-status').innerHTML = '0 itens';
                    
                    setStepStatus(7, 'success');
                    log('‚úÖ Passo 7: Carrinho e localStorage limpos', 'sucesso');
                    
                    // Sucesso total
                    log('üéâ === VALIDA√á√ÉO COMPLETA CONCLU√çDA COM SUCESSO ===', 'sucesso');
                    testCounter++;
                    
                } else {
                    throw new Error('Falha ao gravar cartela');
                }
                
            } catch (error) {
                log(`üí• ERRO na valida√ß√£o: ${error.message}`, 'erro');
                
                // Marcar passos como erro
                for (let i = 1; i <= 7; i++) {
                    const step = document.getElementById(`step-${i}`);
                    if (step.querySelector('.step-status').classList.contains('step-running')) {
                        setStepStatus(i, 'error');
                        break;
                    }
                }
            }
        }
        
        async function verificarCartelasFirebase() {
            log('üîç === VERIFICANDO CARTELAS NO FIREBASE ===');
            
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('cartelas')
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();
                
                log(`üìã Encontradas ${snapshot.size} cartelas recentes:`);
                
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    log(`${index + 1}. ${doc.id}`);
                    log(`   üë§ ${data.nome || data.comprador?.nome || 'N/A'}`);
                    log(`   üì± ${data.telefone || data.comprador?.telefone || 'N/A'}`);
                    log(`   üî¢ ${data.numeros?.length || 0} n√∫meros`);
                    log(`   ‚úÖ Status: ${data.status || 'N/A'} ${data.vendida ? '(vendida)' : ''}`);
                    log(`   üìÖ ${data.dataCompra ? new Date(data.dataCompra.seconds * 1000).toLocaleString() : 'N/A'}`);
                });
                
            } catch (error) {
                log(`‚ùå Erro ao verificar cartelas: ${error.message}`, 'erro');
            }
        }
        
        function limparTudo() {
            resultadosDiv.innerHTML = '';
            localStorage.removeItem('bingo-carrinho');
            document.getElementById('carrinho-status').innerHTML = '0 itens';
            
            // Reset steps
            for (let i = 1; i <= 7; i++) {
                setStepStatus(i, 'pending');
            }
            
            log('üßπ Tudo limpo');
        }
    </script>
</body>
</html>
