<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Direto - Minhas Cartelas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f8ff;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .alert.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .cartelas-list {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Direto - Sistema Minhas Cartelas</h1>
        
        <div id="status-inicializacao">
            <h3>Status da Inicializa√ß√£o</h3>
            <div id="status-display">Aguardando...</div>
        </div>
        
        <div class="form-group">
            <h3>Buscar Cartelas</h3>
            <label for="telefone">Telefone:</label>
            <input type="tel" id="telefone" placeholder="11999887766" value="11999887766">
            
            <label for="email">Email:</label>
            <input type="email" id="email" placeholder="teste@email.com" value="teste@email.com">
            
            <button onclick="buscarCartelas()">üîç Buscar Cartelas</button>
            <button onclick="testarInicializacao()">üîÑ Testar Inicializa√ß√£o</button>
            <button onclick="limparLog()">üóëÔ∏è Limpar Log</button>
        </div>
        
        <div id="resultados">
            <h3>Resultados</h3>
            <div id="alertas"></div>
            <div id="cartelas-encontradas" class="cartelas-list" style="display: none;"></div>
        </div>
        
        <div id="log-debug">
            <h3>Log de Debug</h3>
            <div id="log-area" class="log"></div>
        </div>
    </div>

    <!-- Firebase Dependencies -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Project Dependencies -->
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>

    <script>
        // Vari√°veis globais
        let firebaseService = null;
        let sistemaInicializado = false;
        
        // Sistema de log
        function log(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[TESTE] ${message}`);
        }
        
        function limparLog() {
            document.getElementById('log-area').textContent = '';
        }
        
        function mostrarAlerta(message, type = 'info') {
            const alertasDiv = document.getElementById('alertas');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            alertasDiv.appendChild(alertDiv);
            
            // Remover alerta ap√≥s 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
        
        function atualizarStatusInicializacao(status, tipo = 'info') {
            const statusDiv = document.getElementById('status-display');
            statusDiv.innerHTML = `<div class="alert ${tipo}">${status}</div>`;
        }
        
        // Normalizar telefone
        function normalizarTelefone(telefone) {
            if (!telefone) return '';
            const telefoneNumerico = telefone.toString().replace(/\D/g, '');
            log(`Normalizando telefone: "${telefone}" -> "${telefoneNumerico}"`);
            return telefoneNumerico;
        }
        
        // Inicializa√ß√£o do sistema (baseado no minhas-cartelas.js)
        async function inicializarSistema() {
            try {
                log('üî• Inicializando sistema...');
                
                // Verificar se Firebase SDK est√° carregado
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o carregado');
                }
                log('‚úÖ Firebase SDK carregado');
                
                // Tentar criar inst√¢ncia do Firebase Service
                if (typeof FirebaseService !== 'undefined') {
                    firebaseService = new FirebaseService();
                    log('‚úÖ Firebase Service instanciado');
                    
                    // Testar conex√£o
                    try {
                        const conexaoOk = await firebaseService.verificarConexao();
                        if (conexaoOk) {
                            log('‚úÖ Conex√£o com Firebase estabelecida');
                            sistemaInicializado = true;
                            return true;
                        } else {
                            log('‚ö†Ô∏è Conex√£o fraca, mas continuando...');
                            sistemaInicializado = true;
                            return true;
                        }
                    } catch (connError) {
                        log(`‚ö†Ô∏è Erro na verifica√ß√£o de conex√£o, mas continuando: ${connError.message}`);
                        sistemaInicializado = true;
                        return true;
                    }
                } else {
                    log('‚ö†Ô∏è Classe FirebaseService n√£o encontrada, usando fallback');
                    // Criar fallback direto
                    firebaseService = {
                        db: firebase.firestore(),
                        async carregarCartelasPorComprador(telefone, email) {
                            log(`Buscando cartelas para telefone: ${telefone}, email: ${email}`);
                            const snapshot = await this.db.collection('cartelas').where('telefone', '==', telefone).get();
                            const cartelas = [];
                            snapshot.forEach(doc => cartelas.push({ id: doc.id, ...doc.data() }));
                            log(`Encontradas ${cartelas.length} cartelas`);
                            return cartelas;
                        },
                        async carregarNumerosSorteados() {
                            const snapshot = await this.db.collection('numeros-sorteados').orderBy('timestamp', 'desc').get();
                            const numeros = [];
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                if (data.numero) numeros.push(data.numero);
                            });
                            return numeros.reverse();
                        },
                        escutarNumerosSorteados(callback) {
                            return this.db.collection('numeros-sorteados')
                                .orderBy('timestamp', 'desc')
                                .onSnapshot((snapshot) => {
                                    const numeros = [];
                                    snapshot.forEach(doc => {
                                        const data = doc.data();
                                        if (data.numero) numeros.push(data.numero);
                                    });
                                    callback(numeros.reverse());
                                });
                        }
                    };
                    sistemaInicializado = true;
                    return true;
                }
                
            } catch (error) {
                log(`‚ùå Erro ao inicializar sistema: ${error.message}`);
                return false;
            }
        }
        
        // Testar inicializa√ß√£o
        async function testarInicializacao() {
            log('=== TESTE DE INICIALIZA√á√ÉO ===');
            atualizarStatusInicializacao('üîÑ Inicializando...', 'info');
            
            const sucesso = await inicializarSistema();
            
            if (sucesso) {
                atualizarStatusInicializacao('‚úÖ Sistema inicializado com sucesso!', 'success');
                log('üéâ Sistema inicializado com sucesso!');
                
                // Verificar m√©todos dispon√≠veis
                if (firebaseService) {
                    log('M√©todos dispon√≠veis no Firebase Service:');
                    if (typeof firebaseService.carregarCartelasPorComprador === 'function') {
                        log('‚úÖ carregarCartelasPorComprador');
                    }
                    if (typeof firebaseService.carregarNumerosSorteados === 'function') {
                        log('‚úÖ carregarNumerosSorteados');
                    }
                    if (typeof firebaseService.escutarNumerosSorteados === 'function') {
                        log('‚úÖ escutarNumerosSorteados');
                    }
                }
                
            } else {
                atualizarStatusInicializacao('‚ùå Falha na inicializa√ß√£o', 'error');
                log('‚ùå Sistema n√£o conseguiu inicializar');
            }
            
            return sucesso;
        }
        
        // Buscar cartelas
        async function buscarCartelas() {
            log('=== BUSCA DE CARTELAS ===');
            
            const telefone = document.getElementById('telefone').value.trim();
            const email = document.getElementById('email').value.trim();
            
            if (!telefone && !email) {
                mostrarAlerta('‚ö†Ô∏è Informe pelo menos o telefone ou email.', 'warning');
                return;
            }
            
            // Verificar se sistema est√° inicializado
            if (!sistemaInicializado || !firebaseService) {
                mostrarAlerta('‚ùå Sistema n√£o inicializado. Execute o teste de inicializa√ß√£o primeiro.', 'error');
                return;
            }
            
            try {
                mostrarAlerta('üîç Buscando cartelas...', 'info');
                
                const telefoneNormalizado = telefone ? normalizarTelefone(telefone) : null;
                log(`Dados de busca: telefone="${telefoneNormalizado}", email="${email}"`);
                
                const cartelas = await firebaseService.carregarCartelasPorComprador(telefoneNormalizado, email);
                
                const cartelasDiv = document.getElementById('cartelas-encontradas');
                
                if (cartelas.length > 0) {
                    mostrarAlerta(`‚úÖ Encontradas ${cartelas.length} cartelas!`, 'success');
                    
                    let html = `<h4>Cartelas Encontradas (${cartelas.length}):</h4>`;
                    cartelas.forEach((cartela, index) => {
                        html += `
                            <div style="border: 1px solid #ccc; margin: 10px 0; padding: 10px; border-radius: 4px;">
                                <strong>Cartela ${index + 1}</strong><br>
                                ID: ${cartela.id}<br>
                                Comprador: ${cartela.comprador || 'N/A'}<br>
                                Telefone: ${cartela.telefone || 'N/A'}<br>
                                Email: ${cartela.email || 'N/A'}<br>
                                Data: ${cartela.timestamp ? new Date(cartela.timestamp.toDate()).toLocaleString() : 'N/A'}
                            </div>
                        `;
                    });
                    
                    cartelasDiv.innerHTML = html;
                    cartelasDiv.style.display = 'block';
                    
                } else {
                    mostrarAlerta('‚ÑπÔ∏è Nenhuma cartela encontrada para os dados informados.', 'info');
                    cartelasDiv.innerHTML = '<p>Nenhuma cartela encontrada.</p>';
                    cartelasDiv.style.display = 'block';
                }
                
                // Testar carregamento de n√∫meros sorteados
                log('Testando carregamento de n√∫meros sorteados...');
                const numerosSorteados = await firebaseService.carregarNumerosSorteados();
                log(`N√∫meros sorteados encontrados: ${numerosSorteados.length}`);
                
            } catch (error) {
                log(`‚ùå Erro na busca: ${error.message}`);
                mostrarAlerta(`‚ùå Erro na busca: ${error.message}`, 'error');
            }
        }
        
        // Inicializa√ß√£o autom√°tica quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', async () => {
            log('=== P√ÅGINA CARREGADA ===');
            
            // Aguardar um pouco para garantir que todos os scripts carregaram
            setTimeout(async () => {
                await testarInicializacao();
            }, 1000);
        });
    </script>
</body>
</html>
