<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste Isolado - Grava√ß√£o Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .resultado {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .sucesso { background: #d4edda; color: #155724; }
        .erro { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste Isolado - Grava√ß√£o Firebase</h1>
        <p>Este teste foca apenas na grava√ß√£o no Firebase, isolando o problema.</p>
        
        <div class="form-group">
            <label for="nome">Nome do Comprador:</label>
            <input type="text" id="nome" value="Teste Isolado" required>
        </div>
        
        <div class="form-group">
            <label for="telefone">Telefone:</label>
            <input type="tel" id="telefone" value="(11) 99999-9999" required>
        </div>
        
        <button onclick="testarGravacaoIsolada()">üíæ Testar Grava√ß√£o Isolada</button>
        <button onclick="simularFluxoCompleto()">üéØ Simular Fluxo Completo</button>
        <button onclick="limparLogs()">üßπ Limpar Logs</button>
        
        <div id="resultado"></div>
        <div id="logs" class="log">Aguardando teste...</div>
    </div>

    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>

    <script>
        let contadorTeste = 1;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function mostrarResultado(message, tipo) {
            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.innerHTML = `<div class="resultado ${tipo}">${message}</div>`;
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Teste isolado carregado');
            
            setTimeout(() => {
                if (window.FirebaseDB) {
                    log('‚úÖ FirebaseDB conectado');
                    
                    if (typeof window.FirebaseDB.saveCartela === 'function') {
                        log('‚úÖ M√©todo saveCartela dispon√≠vel');
                    } else {
                        log('‚ùå M√©todo saveCartela n√£o encontrado');
                    }
                } else {
                    log('‚ùå FirebaseDB n√£o dispon√≠vel');
                }
            }, 2000);
        });
        
        async function testarGravacaoIsolada() {
            log('üéØ === TESTE GRAVA√á√ÉO ISOLADA ===');
            
            try {
                // Verificar Firebase
                if (!window.FirebaseDB) {
                    throw new Error('FirebaseDB n√£o dispon√≠vel');
                }
                
                // Obter dados do formul√°rio
                const nome = document.getElementById('nome').value;
                const telefone = document.getElementById('telefone').value;
                
                if (!nome || !telefone) {
                    throw new Error('Nome e telefone s√£o obrigat√≥rios');
                }
                
                // Criar cartela de teste
                const cartela = {
                    id: `ISOLADO-${Date.now()}-${contadorTeste}`,
                    numeros: Array.from({length: 15}, () => Math.floor(Math.random() * 75) + 1).sort((a, b) => a - b),
                    preco: 5.00,
                    status: 'vendida',
                    comprador: {
                        nome: nome,
                        telefone: telefone
                    },
                    nome: nome,
                    telefone: telefone,
                    dataCompra: new Date(),
                    timestamp: Date.now()
                };
                
                log(`üìã Cartela criada: ${cartela.id}`);
                log(`üë§ Comprador: ${cartela.comprador.nome}`);
                log(`üì± Telefone: ${cartela.comprador.telefone}`);
                log(`üî¢ N√∫meros: [${cartela.numeros.slice(0, 5).join(', ')}...]`);
                
                // Chamar m√©todo de grava√ß√£o
                log('üíæ Chamando FirebaseDB.saveCartela...');
                const resultado = await window.FirebaseDB.saveCartela(cartela);
                
                if (resultado.success) {
                    log(`‚úÖ SUCESSO! Cartela gravada com ID: ${resultado.id}`, 'success');
                    mostrarResultado(`‚úÖ Cartela gravada com sucesso! ID: ${resultado.id}`, 'sucesso');
                    
                    // Verificar no banco
                    setTimeout(async () => {
                        try {
                            const db = firebase.firestore();
                            const doc = await db.collection('cartelas').doc(resultado.id).get();
                            
                            if (doc.exists) {
                                const data = doc.data();
                                log('‚úÖ Cartela confirmada no Firebase!');
                                log(`üìã Dados salvos: Nome=${data.nome}, Tel=${data.telefone}, Nums=${data.numeros?.length}`);
                                log(`üìã Status: ${data.status}, Vendida: ${data.vendida}`);
                            } else {
                                log('‚ùå Cartela n√£o encontrada no Firebase ap√≥s grava√ß√£o!');
                            }
                        } catch (error) {
                            log(`‚ùå Erro ao verificar: ${error.message}`);
                        }
                    }, 2000);
                    
                    contadorTeste++;
                    
                } else {
                    throw new Error('Resultado indica falha na grava√ß√£o');
                }
                
            } catch (error) {
                log(`‚ùå ERRO: ${error.message}`);
                mostrarResultado(`‚ùå Erro: ${error.message}`, 'erro');
                console.error('Erro completo:', error);
            }
        }
        
        async function simularFluxoCompleto() {
            log('üéØ === SIMULANDO FLUXO COMPLETO ===');
            
            try {
                // Simular carrinho com m√∫ltiplas cartelas
                const carrinho = [];
                
                for (let i = 1; i <= 2; i++) {
                    const cartela = {
                        id: `FLUXO-${Date.now()}-${i}`,
                        numeros: Array.from({length: 15}, () => Math.floor(Math.random() * 75) + 1).sort((a, b) => a - b),
                        preco: 5.00,
                        status: 'no-carrinho'
                    };
                    carrinho.push(cartela);
                    log(`üõí Cartela ${i} adicionada ao carrinho: ${cartela.id}`);
                }
                
                // Obter dados do comprador
                const nome = document.getElementById('nome').value;
                const telefone = document.getElementById('telefone').value;
                
                log(`üë§ Dados do comprador: ${nome} - ${telefone}`);
                
                // Processar cada cartela
                let sucessos = 0;
                let erros = 0;
                
                for (let i = 0; i < carrinho.length; i++) {
                    const cartela = carrinho[i];
                    
                    // Preparar dados para salvar
                    const cartelaParaSalvar = {
                        ...cartela,
                        status: 'vendida',
                        comprador: {
                            nome: nome,
                            telefone: telefone
                        },
                        nome: nome,
                        telefone: telefone,
                        dataCompra: new Date(),
                        timestamp: Date.now()
                    };
                    
                    try {
                        log(`üíæ Salvando cartela ${i + 1}/${carrinho.length}: ${cartela.id}`);
                        const resultado = await window.FirebaseDB.saveCartela(cartelaParaSalvar);
                        
                        if (resultado.success) {
                            log(`‚úÖ Cartela ${i + 1} salva: ${resultado.id}`);
                            sucessos++;
                        } else {
                            throw new Error('Falha na grava√ß√£o');
                        }
                        
                        // Pequena pausa entre grava√ß√µes
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        log(`‚ùå Erro na cartela ${i + 1}: ${error.message}`);
                        erros++;
                    }
                }
                
                // Resultado final
                if (sucessos > 0) {
                    log(`üéâ FLUXO CONCLU√çDO: ${sucessos} sucessos, ${erros} erros`);
                    mostrarResultado(`üéâ Fluxo conclu√≠do: ${sucessos} cartelas salvas, ${erros} erros`, 'sucesso');
                } else {
                    log(`üí• FLUXO FALHOU: Nenhuma cartela foi salva`);
                    mostrarResultado(`üí• Fluxo falhou: Nenhuma cartela foi salva`, 'erro');
                }
                
            } catch (error) {
                log(`‚ùå ERRO NO FLUXO: ${error.message}`);
                mostrarResultado(`‚ùå Erro no fluxo: ${error.message}`, 'erro');
            }
        }
        
        function limparLogs() {
            document.getElementById('logs').innerHTML = 'Logs limpos...';
            document.getElementById('resultado').innerHTML = '';
        }
    </script>
</body>
</html>
