<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Teste Final - Fluxo Completo de Compra</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .resultado {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        .erro { background: #f44336; }
        .sucesso { background: #4CAF50; }
        .info { background: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Teste Final - Fluxo Completo de Compra</h1>
        <p>Este teste simula o fluxo completo de compra de cartelas, desde a geraÃ§Ã£o atÃ© a gravaÃ§Ã£o no Firebase.</p>
        
        <div>
            <button onclick="testarFluxoCompleto()">ğŸ¯ Testar Fluxo Completo</button>
            <button onclick="verificarCartelas()">ğŸ” Verificar Cartelas no Firebase</button>
            <button onclick="limparResultados()">ğŸ§¹ Limpar Resultados</button>
        </div>
        
        <div id="resultados"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <script>
        let resultadosDiv;
        let contadorTeste = 1;
        
        window.addEventListener('DOMContentLoaded', () => {
            resultadosDiv = document.getElementById('resultados');
            log('ğŸš€ PÃ¡gina carregada, aguardando Firebase...');
            
            // Aguardar Firebase
            setTimeout(() => {
                if (window.FirebaseDB) {
                    log('âœ… Firebase conectado com sucesso!');
                } else {
                    log('âŒ Firebase nÃ£o conectado!', 'erro');
                }
            }, 2000);
        });
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'erro' ? 'erro' : type === 'sucesso' ? 'sucesso' : 'info';
            
            resultadosDiv.innerHTML += `
                <div class="resultado ${className}">
                    [${timestamp}] ${message}
                </div>
            `;
            
            console.log(`[${timestamp}] ${message}`);
            resultadosDiv.scrollTop = resultadosDiv.scrollHeight;
        }
        
        function gerarCartela() {
            log('ğŸ² Gerando cartela de teste...');
            
            const numeros = [];
            for (let i = 0; i < 15; i++) {
                numeros.push(Math.floor(Math.random() * 75) + 1);
            }
            numeros.sort((a, b) => a - b);
            
            const cartela = {
                id: `TESTE-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                numeros: numeros,
                preco: 5.00,
                status: 'vendida',
                comprador: {
                    nome: `Teste Usuario ${contadorTeste}`,
                    telefone: `(11) 99999-${String(contadorTeste).padStart(4, '0')}`
                },
                dataCompra: new Date(),
                timestamp: Date.now()
            };
            
            log(`âœ… Cartela gerada: ${cartela.id}`);
            log(`ğŸ“± Comprador: ${cartela.comprador.nome} - ${cartela.comprador.telefone}`);
            log(`ğŸ”¢ NÃºmeros: [${cartela.numeros.join(', ')}]`);
            
            return cartela;
        }
        
        async function salvarCartela(cartela) {
            log(`ğŸ’¾ Tentando salvar cartela: ${cartela.id}`);
            
            try {
                if (!window.FirebaseDB) {
                    throw new Error('FirebaseDB nÃ£o disponÃ­vel');
                }
                
                log('ğŸ”¥ Chamando FirebaseDB.saveCartela...');
                const resultado = await window.FirebaseDB.saveCartela(cartela);
                
                if (resultado.success) {
                    log(`âœ… Cartela salva com sucesso! ID Firebase: ${resultado.id}`, 'sucesso');
                    return resultado;
                } else {
                    throw new Error('Resultado nÃ£o indicou sucesso');
                }
                
            } catch (error) {
                log(`âŒ Erro ao salvar cartela: ${error.message}`, 'erro');
                throw error;
            }
        }
        
        async function testarFluxoCompleto() {
            log('ğŸ¯ === INICIANDO TESTE FLUXO COMPLETO ===');
            log(`ğŸ“Š Teste nÃºmero: ${contadorTeste}`);
            
            try {
                // 1. Gerar cartela
                log('1ï¸âƒ£ Etapa 1: Gerar cartela');
                const cartela = gerarCartela();
                
                // 2. Simular adiÃ§Ã£o ao carrinho
                log('2ï¸âƒ£ Etapa 2: Simular adiÃ§Ã£o ao carrinho');
                log('ğŸ›’ Cartela adicionada ao carrinho (simulado)');
                
                // 3. Simular preenchimento de dados
                log('3ï¸âƒ£ Etapa 3: Dados do comprador preenchidos');
                log(`ğŸ‘¤ Nome: ${cartela.comprador.nome}`);
                log(`ğŸ“± Telefone: ${cartela.comprador.telefone}`);
                
                // 4. Finalizar compra (salvar no Firebase)
                log('4ï¸âƒ£ Etapa 4: Finalizar compra (salvar no Firebase)');
                await salvarCartela(cartela);
                
                log('ğŸ‰ === TESTE CONCLUÃDO COM SUCESSO ===', 'sucesso');
                contadorTeste++;
                
            } catch (error) {
                log(`ğŸ’¥ === TESTE FALHOU: ${error.message} ===`, 'erro');
            }
        }
        
        async function verificarCartelas() {
            log('ğŸ” === VERIFICANDO CARTELAS NO FIREBASE ===');
            
            try {
                if (!window.FirebaseDB) {
                    throw new Error('FirebaseDB nÃ£o disponÃ­vel');
                }
                
                log('ğŸ“Š Buscando todas as cartelas...');
                
                // Usar Firestore diretamente para buscar todas as cartelas
                const db = firebase.firestore();
                const snapshot = await db.collection('cartelas')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                log(`ğŸ“‹ Encontradas ${snapshot.size} cartelas:`);
                
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    log(`${index + 1}. ID: ${doc.id}`);
                    log(`   ğŸ‘¤ Comprador: ${data.nome || data.comprador?.nome || 'N/A'}`);
                    log(`   ğŸ“± Telefone: ${data.telefone || data.comprador?.telefone || 'N/A'}`);
                    log(`   ğŸ”¢ NÃºmeros: ${data.numeros?.length || 0} nÃºmeros`);
                    log(`   ğŸ’° PreÃ§o: R$ ${data.preco || 'N/A'}`);
                    log(`   ğŸ“… Data: ${data.dataCompra ? new Date(data.dataCompra.seconds * 1000).toLocaleString() : 'N/A'}`);
                    log(`   âœ… Status: ${data.status || 'N/A'}`);
                    log(`   ğŸ·ï¸ Vendida: ${data.vendida ? 'Sim' : 'NÃ£o'}`);
                    log('   ---');
                });
                
                log('âœ… VerificaÃ§Ã£o concluÃ­da', 'sucesso');
                
            } catch (error) {
                log(`âŒ Erro ao verificar cartelas: ${error.message}`, 'erro');
            }
        }
        
        function limparResultados() {
            resultadosDiv.innerHTML = '';
            log('ğŸ§¹ Resultados limpos');
        }
    </script>
</body>
</html>
