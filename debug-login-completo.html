<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è Debug Login - Bingo INEC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #ff9800, #ffc107);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .section {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .btn-test {
            background: #ff9800;
        }
        .btn-test:hover {
            background: #e68900;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .resultado {
            background: #e8f5e8;
            border-left: 5px solid #4CAF50;
            padding: 15px;
            margin: 15px 0;
        }
        .erro {
            background: #ffe8e8;
            border-left: 5px solid #f44336;
            padding: 15px;
            margin: 15px 0;
        }
        .info {
            background: #e8f4fd;
            border-left: 5px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Debug do Sistema de Login - Bingo INEC</h1>
        <p>Esta p√°gina ajuda a diagnosticar problemas com o login de cartelas.</p>
    </div>

    <div class="container">
        <div class="section">
            <h2>üîß Teste de Conex√£o Firebase</h2>
            <button onclick="testarFirebase()" class="btn-test">üî• Testar Firebase</button>
            <div id="firebase-result"></div>
        </div>

        <div class="section">
            <h2>üîç Buscar Cartelas por Telefone</h2>
            <div class="input-group">
                <label for="telefone-busca">üì± Telefone:</label>
                <input type="tel" id="telefone-busca" placeholder="(11) 99999-9999 ou 11999999999">
            </div>
            <button onclick="buscarPorTelefone()" class="btn-test">üìû Buscar por Telefone</button>
            <div id="telefone-result"></div>
        </div>

        <div class="section">
            <h2>üìß Buscar Cartelas por Email</h2>
            <div class="input-group">
                <label for="email-busca">üìß Email:</label>
                <input type="email" id="email-busca" placeholder="usuario@exemplo.com">
            </div>
            <button onclick="buscarPorEmail()" class="btn-test">üìß Buscar por Email</button>
            <div id="email-result"></div>
        </div>

        <div class="section">
            <h2>üìã Listar Todas as Cartelas Vendidas</h2>
            <button onclick="listarTodasCartelas()" class="btn-test">üìã Listar Todas</button>
            <div id="todas-result"></div>
        </div>

        <div class="section">
            <h2>üìä Estat√≠sticas do Sistema</h2>
            <button onclick="carregarEstatisticas()" class="btn-test">üìä Carregar Estat√≠sticas</button>
            <div id="stats-result"></div>
        </div>
    </div>

    <div class="container">
        <h2>üîç Log de Debug</h2>
        <button onclick="limparLog()" style="background: #6c757d;">üóëÔ∏è Limpar Log</button>
        <div id="debug-log" class="log-area">Aguardando testes...</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>

    <script>
        let debugLog = [];

        function log(mensagem) {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${mensagem}`;
            debugLog.push(logLine);
            document.getElementById('debug-log').textContent = debugLog.join('\n');
            console.log(logLine);
        }

        function limparLog() {
            debugLog = [];
            document.getElementById('debug-log').textContent = 'Log limpo...';
        }

        function mostrarResultado(elementId, conteudo, tipo = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${tipo}">${conteudo}</div>`;
        }

        async function testarFirebase() {
            log('üî• Testando conex√£o com Firebase...');
            
            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService n√£o carregado');
                }

                const conexao = await window.firebaseService.verificarConexao();
                
                if (conexao) {
                    log('‚úÖ Firebase conectado com sucesso!');
                    mostrarResultado('firebase-result', '‚úÖ Conex√£o com Firebase estabelecida!', 'resultado');
                } else {
                    log('‚ùå Falha na conex√£o com Firebase');
                    mostrarResultado('firebase-result', '‚ùå Falha na conex√£o com Firebase', 'erro');
                }
            } catch (error) {
                log(`‚ùå Erro ao testar Firebase: ${error.message}`);
                mostrarResultado('firebase-result', `‚ùå Erro: ${error.message}`, 'erro');
            }
        }

        function normalizarTelefone(telefone) {
            return telefone ? telefone.replace(/\D/g, '') : '';
        }

        async function buscarPorTelefone() {
            const telefone = document.getElementById('telefone-busca').value.trim();
            
            if (!telefone) {
                mostrarResultado('telefone-result', '‚ö†Ô∏è Informe um telefone para buscar', 'erro');
                return;
            }

            const telefoneNormalizado = normalizarTelefone(telefone);
            log(`üìû Buscando cartelas para telefone: ${telefone} (normalizado: ${telefoneNormalizado})`);

            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService n√£o carregado');
                }

                const cartelas = await window.firebaseService.carregarCartelasPorComprador(telefoneNormalizado, null);
                
                log(`üì¶ Encontradas ${cartelas.length} cartelas para o telefone`);
                
                if (cartelas.length > 0) {
                    let resultado = `‚úÖ Encontradas ${cartelas.length} cartelas:<br><br>`;
                    cartelas.forEach(cartela => {
                        resultado += `
                            <strong>ID:</strong> ${cartela.id}<br>
                            <strong>Comprador:</strong> ${cartela.comprador || 'N/A'}<br>
                            <strong>Telefone:</strong> ${cartela.telefone || 'N/A'}<br>
                            <strong>Email:</strong> ${cartela.email || 'N/A'}<br>
                            <strong>Pre√ßo:</strong> R$ ${(cartela.preco || 0).toFixed(2)}<br>
                            <strong>Data Venda:</strong> ${cartela.dataVenda ? new Date(cartela.dataVenda.toDate()).toLocaleString() : 'N/A'}<br>
                            <hr>
                        `;
                    });
                    mostrarResultado('telefone-result', resultado, 'resultado');
                } else {
                    mostrarResultado('telefone-result', `‚ùå Nenhuma cartela encontrada para o telefone: ${telefone}`, 'erro');
                }
            } catch (error) {
                log(`‚ùå Erro ao buscar por telefone: ${error.message}`);
                mostrarResultado('telefone-result', `‚ùå Erro: ${error.message}`, 'erro');
            }
        }

        async function buscarPorEmail() {
            const email = document.getElementById('email-busca').value.trim();
            
            if (!email) {
                mostrarResultado('email-result', '‚ö†Ô∏è Informe um email para buscar', 'erro');
                return;
            }

            log(`üìß Buscando cartelas para email: ${email}`);

            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService n√£o carregado');
                }

                const cartelas = await window.firebaseService.carregarCartelasPorComprador(null, email);
                
                log(`üì¶ Encontradas ${cartelas.length} cartelas para o email`);
                
                if (cartelas.length > 0) {
                    let resultado = `‚úÖ Encontradas ${cartelas.length} cartelas:<br><br>`;
                    cartelas.forEach(cartela => {
                        resultado += `
                            <strong>ID:</strong> ${cartela.id}<br>
                            <strong>Comprador:</strong> ${cartela.comprador || 'N/A'}<br>
                            <strong>Telefone:</strong> ${cartela.telefone || 'N/A'}<br>
                            <strong>Email:</strong> ${cartela.email || 'N/A'}<br>
                            <strong>Pre√ßo:</strong> R$ ${(cartela.preco || 0).toFixed(2)}<br>
                            <strong>Data Venda:</strong> ${cartela.dataVenda ? new Date(cartela.dataVenda.toDate()).toLocaleString() : 'N/A'}<br>
                            <hr>
                        `;
                    });
                    mostrarResultado('email-result', resultado, 'resultado');
                } else {
                    mostrarResultado('email-result', `‚ùå Nenhuma cartela encontrada para o email: ${email}`, 'erro');
                }
            } catch (error) {
                log(`‚ùå Erro ao buscar por email: ${error.message}`);
                mostrarResultado('email-result', `‚ùå Erro: ${error.message}`, 'erro');
            }
        }

        async function listarTodasCartelas() {
            log('üìã Carregando todas as cartelas vendidas...');

            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService n√£o carregado');
                }

                const cartelas = await window.firebaseService.carregarCartelas();
                const cartelasVendidas = cartelas.filter(cartela => cartela.vendida);
                
                log(`üì¶ Total de cartelas: ${cartelas.length}, Vendidas: ${cartelasVendidas.length}`);
                
                if (cartelasVendidas.length > 0) {
                    let resultado = `‚úÖ Total de ${cartelasVendidas.length} cartelas vendidas:<br><br>`;
                    
                    // Agrupar por comprador
                    const compradores = {};
                    cartelasVendidas.forEach(cartela => {
                        const key = cartela.comprador || 'SEM NOME';
                        if (!compradores[key]) {
                            compradores[key] = [];
                        }
                        compradores[key].push(cartela);
                    });

                    Object.keys(compradores).forEach(comprador => {
                        const cartelas = compradores[comprador];
                        resultado += `
                            <strong>üë§ ${comprador}</strong><br>
                            üìû ${cartelas[0].telefone || 'N/A'}<br>
                            üìß ${cartelas[0].email || 'N/A'}<br>
                            üé´ ${cartelas.length} cartela(s)<br>
                            üí∞ Total: R$ ${(cartelas.reduce((sum, c) => sum + (c.preco || 0), 0)).toFixed(2)}<br>
                            <hr>
                        `;
                    });
                    
                    mostrarResultado('todas-result', resultado, 'resultado');
                } else {
                    mostrarResultado('todas-result', '‚ùå Nenhuma cartela vendida encontrada', 'erro');
                }
            } catch (error) {
                log(`‚ùå Erro ao listar cartelas: ${error.message}`);
                mostrarResultado('todas-result', `‚ùå Erro: ${error.message}`, 'erro');
            }
        }

        async function carregarEstatisticas() {
            log('üìä Carregando estat√≠sticas do sistema...');

            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService n√£o carregado');
                }

                const cartelas = await window.firebaseService.carregarCartelas();
                const numerosSorteados = await window.firebaseService.carregarNumerosSorteados();
                
                const totalCartelas = cartelas.length;
                const cartelasVendidas = cartelas.filter(c => c.vendida).length;
                const cartelasLivres = totalCartelas - cartelasVendidas;
                const numerosSorteadosCount = numerosSorteados.length;

                // Calcular total de vendas
                const totalVendas = cartelas
                    .filter(c => c.vendida)
                    .reduce((sum, c) => sum + (c.preco || 0), 0);

                log(`üìä Estat√≠sticas carregadas: ${totalCartelas} cartelas, ${cartelasVendidas} vendidas`);

                const resultado = `
                    <h3>üìä Estat√≠sticas do Sistema</h3>
                    <strong>üé´ Total de Cartelas:</strong> ${totalCartelas}<br>
                    <strong>‚úÖ Cartelas Vendidas:</strong> ${cartelasVendidas}<br>
                    <strong>üÜì Cartelas Livres:</strong> ${cartelasLivres}<br>
                    <strong>üí∞ Total Arrecadado:</strong> R$ ${totalVendas.toFixed(2)}<br>
                    <strong>üé≤ N√∫meros Sorteados:</strong> ${numerosSorteadosCount}<br>
                    <strong>üìà Taxa de Vendas:</strong> ${totalCartelas > 0 ? ((cartelasVendidas/totalCartelas)*100).toFixed(1) : 0}%
                `;
                
                mostrarResultado('stats-result', resultado, 'resultado');
            } catch (error) {
                log(`‚ùå Erro ao carregar estat√≠sticas: ${error.message}`);
                mostrarResultado('stats-result', `‚ùå Erro: ${error.message}`, 'erro');
            }
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            log('üõ†Ô∏è P√°gina de debug carregada');
            log('‚è≥ Aguardando Firebase...');
            
            // Verificar Firebase periodicamente
            const verificarFirebase = setInterval(() => {
                if (typeof window.firebaseService !== 'undefined') {
                    log('‚úÖ Firebase Service carregado!');
                    clearInterval(verificarFirebase);
                    testarFirebase();
                }
            }, 1000);
        });
    </script>
</body>
</html>
