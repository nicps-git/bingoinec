<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Bot√£o Sorteio</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .container { background: white; padding: 20px; border-radius: 10px; }
        .status { padding: 10px; margin: 5px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        #logs { background: #000; color: #0f0; padding: 15px; border-radius: 5px; 
                font-family: monospace; height: 400px; overflow-y: auto; }
        button { padding: 10px 20px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug do Bot√£o de Sorteio</h1>
        
        <div id="status-elementos" class="status info">Verificando elementos...</div>
        <div id="status-firebase" class="status info">Verificando Firebase...</div>
        <div id="status-config" class="status info">Verificando configura√ß√£o...</div>
        <div id="status-funcoes" class="status info">Verificando fun√ß√µes...</div>
        
        <button id="test-button" onclick="testButton()">üß™ Testar Fun√ß√£o Sortear</button>
        <button onclick="clearLogs()">üßπ Limpar Logs</button>
        
        <h3>üìä Logs do Sistema:</h3>
        <div id="logs">Iniciando debug...\n</div>
    </div>

    <!-- Firebase SDK v8 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>

    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logs = document.getElementById('logs');
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function updateStatus(id, type, message) {
            const element = document.getElementById(id);
            element.className = `status ${type}`;
            element.textContent = type === 'success' ? `‚úÖ ${message}` : 
                                 type === 'error' ? `‚ùå ${message}` : `‚è≥ ${message}`;
        }

        function clearLogs() {
            document.getElementById('logs').textContent = 'Logs limpos...\n';
        }

        // Simular os elementos da p√°gina principal
        function createMockElements() {
            log('Criando elementos mock para simular index.html...');
            
            // Criar elementos que existem na p√°gina principal
            const sortearBtn = document.createElement('button');
            sortearBtn.id = 'sortear-btn';
            sortearBtn.textContent = 'üé≤ Sortear';
            sortearBtn.style.display = 'none'; // Invis√≠vel para este teste
            document.body.appendChild(sortearBtn);

            const numeroSorteado = document.createElement('div');
            numeroSorteado.id = 'numero-sorteado';
            numeroSorteado.style.display = 'none';
            document.body.appendChild(numeroSorteado);

            const numerosAnteriores = document.createElement('ul');
            numerosAnteriores.id = 'numeros-anteriores';
            numerosAnteriores.style.display = 'none';
            document.body.appendChild(numerosAnteriores);

            const contador = document.createElement('span');
            contador.id = 'contador-numeros';
            contador.style.display = 'none';
            document.body.appendChild(contador);

            const fogos = document.createElement('div');
            fogos.id = 'fogos';
            fogos.style.display = 'none';
            document.body.appendChild(fogos);

            log('Elementos mock criados com sucesso');
            return {
                sortearBtn,
                numeroSorteado,
                numerosAnteriores,
                contador,
                fogos
            };
        }

        // Testar a fun√ß√£o de sortear diretamente
        async function testButton() {
            log('=== INICIANDO TESTE DO BOT√ÉO ===');
            
            try {
                // Verificar se sortearNumero existe no escopo global
                if (typeof window.sortearNumero === 'function') {
                    log('‚úÖ Fun√ß√£o sortearNumero encontrada no escopo global');
                    window.sortearNumero();
                } else {
                    log('‚ùå Fun√ß√£o sortearNumero N√ÉO encontrada no escopo global');
                    log('Tentando executar o c√≥digo da p√°gina principal...');
                    
                    // Executar c√≥digo similar ao da p√°gina principal
                    await executeMainPageCode();
                }
            } catch (error) {
                log(`‚ùå Erro ao testar bot√£o: ${error.message}`);
                console.error('Erro completo:', error);
            }
        }

        async function executeMainPageCode() {
            log('Executando c√≥digo da p√°gina principal...');
            
            // Criar elementos mock
            const elements = createMockElements();
            
            // Verificar Firebase
            log('Verificando firebaseService...');
            if (typeof window.firebaseService === 'undefined') {
                throw new Error('firebaseService n√£o est√° dispon√≠vel');
            }
            
            log('Testando conex√£o com Firebase...');
            const conexaoOk = await firebaseService.verificarConexao();
            if (!conexaoOk) {
                throw new Error('Falha na conex√£o com Firebase');
            }
            log('‚úÖ Firebase conectado');

            // Carregar dados
            log('Carregando configura√ß√µes...');
            const configuracoes = await firebaseService.carregarConfiguracoes();
            log(`Configura√ß√µes: ${JSON.stringify(configuracoes)}`);

            log('Carregando n√∫meros sorteados...');
            const numerosSorteados = await firebaseService.carregarNumerosSorteados();
            log(`N√∫meros sorteados: ${numerosSorteados.length} encontrados`);

            // Calcular n√∫meros dispon√≠veis
            const numeroInicial = configuracoes.numeroInicial || 1;
            const numeroFinal = configuracoes.numeroFinal || 75;
            const todosNumeros = Array.from({ length: numeroFinal - numeroInicial + 1 }, (_, i) => i + numeroInicial);
            const numerosDisponiveis = todosNumeros.filter(num => !numerosSorteados.includes(num));
            
            log(`N√∫meros dispon√≠veis: ${numerosDisponiveis.length}`);

            if (numerosDisponiveis.length === 0) {
                log('‚ö†Ô∏è Nenhum n√∫mero dispon√≠vel para sortear');
                return;
            }

            // Simular sorteio
            log('üé≤ Simulando sorteio...');
            const randomIndex = Math.floor(Math.random() * numerosDisponiveis.length);
            const numero = numerosDisponiveis[randomIndex];
            
            log(`üéØ N√∫mero sorteado: ${numero}`);

            // Tentar salvar
            try {
                await firebaseService.salvarNumeroSorteado(numero);
                log(`‚úÖ N√∫mero ${numero} salvo no Firebase com sucesso!`);
            } catch (error) {
                log(`‚ùå Erro ao salvar: ${error.message}`);
            }

            log('=== TESTE CONCLU√çDO COM SUCESSO ===');
        }

        // Executar verifica√ß√µes ao carregar
        document.addEventListener('DOMContentLoaded', async () => {
            log('DOM carregado, iniciando verifica√ß√µes...');

            // 1. Verificar elementos
            log('1. Verificando elementos DOM...');
            const elementos = [
                'sortear-btn', 'numero-sorteado', 'numeros-anteriores', 
                'contador-numeros', 'fogos'
            ];
            
            let elementosEncontrados = 0;
            elementos.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    log(`  ‚úÖ Elemento ${id} encontrado`);
                    elementosEncontrados++;
                } else {
                    log(`  ‚ùå Elemento ${id} N√ÉO encontrado`);
                }
            });

            if (elementosEncontrados === elementos.length) {
                updateStatus('status-elementos', 'success', 'Todos os elementos encontrados');
            } else {
                updateStatus('status-elementos', 'error', `${elementosEncontrados}/${elementos.length} elementos encontrados`);
            }

            // 2. Verificar Firebase
            log('2. Verificando Firebase...');
            try {
                if (typeof window.firebaseConfig === 'undefined') {
                    throw new Error('firebaseConfig n√£o definido');
                }
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('firebaseService n√£o definido');
                }
                
                updateStatus('status-firebase', 'success', 'Firebase carregado');
                log('  ‚úÖ Firebase configurado corretamente');
            } catch (error) {
                updateStatus('status-firebase', 'error', error.message);
                log(`  ‚ùå Erro Firebase: ${error.message}`);
            }

            // 3. Verificar configura√ß√£o
            log('3. Verificando configura√ß√£o...');
            try {
                const config = await firebaseService.carregarConfiguracoes();
                updateStatus('status-config', 'success', 'Configura√ß√£o carregada');
                log(`  ‚úÖ Configura√ß√£o: ${JSON.stringify(config)}`);
            } catch (error) {
                updateStatus('status-config', 'error', error.message);
                log(`  ‚ùå Erro configura√ß√£o: ${error.message}`);
            }

            // 4. Verificar fun√ß√µes
            log('4. Verificando fun√ß√µes dispon√≠veis...');
            const funcoes = ['sortearNumero', 'carregarDados', 'verificarAcessoAdmin'];
            let funcoesEncontradas = 0;
            
            funcoes.forEach(func => {
                if (typeof window[func] === 'function') {
                    log(`  ‚úÖ Fun√ß√£o ${func} encontrada`);
                    funcoesEncontradas++;
                } else {
                    log(`  ‚ùå Fun√ß√£o ${func} N√ÉO encontrada`);
                }
            });

            if (funcoesEncontradas > 0) {
                updateStatus('status-funcoes', 'success', `${funcoesEncontradas} fun√ß√µes encontradas`);
            } else {
                updateStatus('status-funcoes', 'error', 'Nenhuma fun√ß√£o encontrada');
            }

            log('Verifica√ß√µes conclu√≠das. Use o bot√£o "Testar Fun√ß√£o Sortear" para testar o sorteio.');
        });
    </script>
</body>
</html>
