<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - GravaÃ§Ã£o no Firebase</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.success { background: #28a745; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; overflow-y: auto; }
        .log { height: 400px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Debug - GravaÃ§Ã£o no Firebase</h1>
        
        <div class="section warning">
            <h3>ğŸ¯ INVESTIGAÃ‡ÃƒO</h3>
            <p>Testando por que as cartelas nÃ£o estÃ£o sendo gravadas no Firebase apÃ³s compra</p>
        </div>

        <div class="section">
            <h3>ğŸ§ª Testes de GravaÃ§Ã£o</h3>
            <button onclick="testarConexaoFirebase()">ğŸ”¥ Testar ConexÃ£o</button>
            <button onclick="testarGravacaoSimples()">ğŸ’¾ Teste GravaÃ§Ã£o Simples</button>
            <button onclick="simularCompraCompleta()">ğŸ›’ Simular Compra Completa</button>
            <button onclick="verificarDadosFirebase()">ğŸ“Š Ver Dados Firebase</button>
            <button onclick="testarPermissoes()">ğŸ” Testar PermissÃµes</button>
            <button onclick="limparLog()" class="danger">ğŸ—‘ï¸ Limpar Log</button>
        </div>

        <div class="section">
            <h3>ğŸ« Simular Compra de Cartela</h3>
            <input type="text" id="nome-teste" placeholder="Nome do comprador" value="Teste Debug">
            <input type="text" id="telefone-teste" placeholder="Telefone" value="85999888777">
            <input type="email" id="email-teste" placeholder="Email" value="teste@debug.com">
            <button onclick="processarCompraDebug()" class="success">ğŸ’³ Processar Compra Debug</button>
        </div>

        <div class="section">
            <h3>ğŸ“Š Resultados</h3>
            <div id="resultados"></div>
        </div>

        <div class="section">
            <h3>ğŸ“‹ Log Detalhado</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
    
    <script>
        let firebaseService = null;
        let db = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function limparLog() {
            document.getElementById('log').innerHTML = '';
        }

        function exibirResultado(titulo, conteudo, tipo = 'info') {
            const resultadosDiv = document.getElementById('resultados');
            const classe = tipo === 'error' ? 'error' : tipo === 'success' ? 'success' : 'section';
            resultadosDiv.innerHTML += `
                <div class="${classe}">
                    <h4>${titulo}</h4>
                    <pre>${JSON.stringify(conteudo, null, 2)}</pre>
                </div>
            `;
        }

        async function testarConexaoFirebase() {
            log("ğŸ”¥ Testando conexÃ£o com Firebase...");
            
            try {
                // Verificar Firebase SDK
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK nÃ£o carregado');
                }
                log("âœ… Firebase SDK carregado");

                // Inicializar Firestore
                db = firebase.firestore();
                log("âœ… Firestore inicializado");

                // Teste de conectividade
                const testDoc = await db.doc('teste/conectividade').get();
                log("âœ… Conectividade OK");

                // Inicializar Firebase Service
                if (typeof FirebaseService !== 'undefined') {
                    firebaseService = new FirebaseService();
                    log("âœ… Firebase Service instanciado");
                } else {
                    log("âš ï¸ Classe FirebaseService nÃ£o encontrada, usando fallback");
                    firebaseService = {
                        db: db,
                        async salvarCartela(cartela) {
                            const docRef = await this.db.collection('cartelas').add(cartela);
                            return docRef.id;
                        }
                    };
                }

                exibirResultado("ConexÃ£o Firebase", {
                    status: "SUCESSO",
                    sdk: "carregado",
                    firestore: "conectado",
                    service: firebaseService ? "disponÃ­vel" : "fallback"
                }, 'success');

                return true;

            } catch (error) {
                log(`âŒ Erro na conexÃ£o: ${error.message}`);
                exibirResultado("Erro ConexÃ£o", { erro: error.message }, 'error');
                return false;
            }
        }

        async function testarGravacaoSimples() {
            log("ğŸ’¾ Testando gravaÃ§Ã£o simples...");
            
            try {
                if (!firebaseService) {
                    await testarConexaoFirebase();
                }

                const cartelaTestePorDr = {
                    id: `teste-debug-${Date.now()}`,
                    nome: "Teste Debug",
                    telefone: "85999888777",
                    email: "teste@debug.com",
                    numeros: [[1,2,3,4,5], [16,17,18,19,20], [31,'FREE',33,34,35], [46,47,48,49,50], [61,62,63,64,65]],
                    preco: 5.00,
                    vendida: true,
                    dataVenda: new Date().toISOString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    origem: "debug-teste"
                };

                log("ğŸ“ Dados para teste:");
                log(JSON.stringify(cartelaTestePorDr, null, 2));

                // MÃ©todo 1: Usando firebase-service
                log("ğŸ”¬ MÃ©todo 1: Usando firebase-service.salvarCartela()");
                try {
                    const id1 = await firebaseService.salvarCartela(cartelaTestePorDr);
                    log(`âœ… MÃ©todo 1 - Cartela salva com ID: ${id1}`);
                } catch (error1) {
                    log(`âŒ MÃ©todo 1 falhou: ${error1.message}`);
                }

                // MÃ©todo 2: Usando Firestore diretamente com .add()
                log("ğŸ”¬ MÃ©todo 2: Usando db.collection().add()");
                try {
                    const docRef2 = await db.collection('cartelas').add({
                        ...cartelaTestePorDr,
                        id: `teste-direct-add-${Date.now()}`,
                        metodo: 'direct-add'
                    });
                    log(`âœ… MÃ©todo 2 - Cartela salva com ID: ${docRef2.id}`);
                } catch (error2) {
                    log(`âŒ MÃ©todo 2 falhou: ${error2.message}`);
                }

                // MÃ©todo 3: Usando Firestore diretamente com .set()
                log("ğŸ”¬ MÃ©todo 3: Usando db.collection().doc().set()");
                try {
                    const docId3 = `teste-direct-set-${Date.now()}`;
                    await db.collection('cartelas').doc(docId3).set({
                        ...cartelaTestePorDr,
                        id: docId3,
                        metodo: 'direct-set'
                    });
                    log(`âœ… MÃ©todo 3 - Cartela salva com ID: ${docId3}`);
                } catch (error3) {
                    log(`âŒ MÃ©todo 3 falhou: ${error3.message}`);
                }

                // Verificar se foram salvas
                log("ğŸ” Verificando se as cartelas foram salvas...");
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const snapshot = await db.collection('cartelas').where('origem', '==', 'debug-teste').get();
                log(`ğŸ“Š Cartelas de teste encontradas: ${snapshot.size}`);

                exibirResultado("Teste GravaÃ§Ã£o Simples", {
                    cartelas_encontradas: snapshot.size,
                    metodos_testados: 3,
                    status: snapshot.size > 0 ? "SUCESSO" : "FALHA"
                }, snapshot.size > 0 ? 'success' : 'error');

            } catch (error) {
                log(`âŒ Erro no teste: ${error.message}`);
                exibirResultado("Erro Teste GravaÃ§Ã£o", { erro: error.message }, 'error');
            }
        }

        async function simularCompraCompleta() {
            log("ğŸ›’ Simulando compra completa como no sistema original...");
            
            try {
                if (!firebaseService) {
                    await testarConexaoFirebase();
                }

                // Dados do comprador
                const comprador = {
                    nome: "JoÃ£o Silva Debug",
                    telefone: "85987654321",
                    email: "joao@debug.com"
                };

                // Simular carrinho com 2 cartelas
                const carrinho = [
                    {
                        id: Date.now(),
                        numeros: [[1,2,3,4,5], [16,17,18,19,20], [31,'FREE',33,34,35], [46,47,48,49,50], [61,62,63,64,65]],
                        preco: 5.00
                    },
                    {
                        id: Date.now() + 1,
                        numeros: [[6,7,8,9,10], [21,22,23,24,25], [36,37,'FREE',38,39], [51,52,53,54,55], [66,67,68,69,70]],
                        preco: 5.00
                    }
                ];

                // FunÃ§Ã£o para normalizar telefone
                function normalizarTelefone(telefone) {
                    return telefone.toString().replace(/\D/g, '');
                }

                // Preparar cartelas para salvar (igual ao cartelas.js)
                const cartelasParaSalvar = carrinho.map(item => ({
                    id: `cartela_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    numeros: item.numeros,
                    preco: item.preco,
                    vendida: true,
                    comprador: comprador.nome,
                    telefone: normalizarTelefone(comprador.telefone),
                    email: comprador.email,
                    dataVenda: new Date().toISOString(),
                    timestamp: new Date(),
                    origem: "simulacao-completa"
                }));

                log(`ğŸ« Processando compra de ${cartelasParaSalvar.length} cartelas para ${comprador.nome}`);
                log(`ğŸ“± Telefone normalizado: ${normalizarTelefone(comprador.telefone)}`);

                // Salvar todas as cartelas
                const idsCartelas = [];
                for (let i = 0; i < cartelasParaSalvar.length; i++) {
                    const cartela = cartelasParaSalvar[i];
                    log(`ğŸ’¾ Salvando cartela ${i + 1}/${cartelasParaSalvar.length}: ${cartela.id}`);
                    
                    try {
                        const id = await firebaseService.salvarCartela(cartela);
                        idsCartelas.push(id);
                        log(`âœ… Cartela ${cartela.id} salva com sucesso`);
                    } catch (error) {
                        log(`âŒ Erro ao salvar cartela ${cartela.id}: ${error.message}`);
                    }
                }

                // VerificaÃ§Ã£o pÃ³s-gravaÃ§Ã£o
                log("ğŸ” Verificando cartelas apÃ³s gravaÃ§Ã£o...");
                await new Promise(resolve => setTimeout(resolve, 3000));

                const snapshot = await db.collection('cartelas').where('origem', '==', 'simulacao-completa').get();
                log(`ğŸ“Š Cartelas da simulaÃ§Ã£o encontradas: ${snapshot.size}`);

                exibirResultado("SimulaÃ§Ã£o Compra Completa", {
                    comprador: comprador,
                    cartelas_para_salvar: cartelasParaSalvar.length,
                    cartelas_salvas: idsCartelas.length,
                    cartelas_encontradas: snapshot.size,
                    ids_gerados: idsCartelas,
                    status: snapshot.size >= cartelasParaSalvar.length ? "SUCESSO" : "PARCIAL"
                }, snapshot.size >= cartelasParaSalvar.length ? 'success' : 'warning');

            } catch (error) {
                log(`âŒ Erro na simulaÃ§Ã£o: ${error.message}`);
                exibirResultado("Erro SimulaÃ§Ã£o", { erro: error.message }, 'error');
            }
        }

        async function verificarDadosFirebase() {
            log("ğŸ“Š Verificando dados no Firebase...");
            
            try {
                if (!db) {
                    await testarConexaoFirebase();
                }

                // Buscar todas as cartelas
                const snapshot = await db.collection('cartelas').get();
                log(`ğŸ“‹ Total de cartelas no Firebase: ${snapshot.size}`);

                const cartelas = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    cartelas.push({
                        id: doc.id,
                        comprador: data.comprador,
                        telefone: data.telefone,
                        dataVenda: data.dataVenda,
                        origem: data.origem || 'sistema',
                        preco: data.preco
                    });
                });

                // Agrupar por origem
                const porOrigem = {};
                cartelas.forEach(cartela => {
                    const origem = cartela.origem || 'sistema';
                    if (!porOrigem[origem]) porOrigem[origem] = [];
                    porOrigem[origem].push(cartela);
                });

                exibirResultado("Dados Firebase", {
                    total_cartelas: snapshot.size,
                    cartelas_por_origem: porOrigem,
                    ultimas_5: cartelas.slice(-5)
                });

                log("ğŸ“Š VerificaÃ§Ã£o concluÃ­da!");

            } catch (error) {
                log(`âŒ Erro na verificaÃ§Ã£o: ${error.message}`);
                exibirResultado("Erro VerificaÃ§Ã£o", { erro: error.message }, 'error');
            }
        }

        async function testarPermissoes() {
            log("ğŸ” Testando permissÃµes de escrita...");
            
            try {
                if (!db) {
                    await testarConexaoFirebase();
                }

                // Teste 1: Criar documento temporÃ¡rio
                const testId = `teste-permissao-${Date.now()}`;
                await db.collection('teste-permissoes').doc(testId).set({
                    teste: true,
                    timestamp: new Date()
                });
                log("âœ… PermissÃ£o de escrita OK");

                // Teste 2: Ler o documento
                const docRead = await db.collection('teste-permissoes').doc(testId).get();
                if (docRead.exists) {
                    log("âœ… PermissÃ£o de leitura OK");
                } else {
                    log("âŒ Documento nÃ£o encontrado apÃ³s criaÃ§Ã£o");
                }

                // Teste 3: Deletar o documento
                await db.collection('teste-permissoes').doc(testId).delete();
                log("âœ… PermissÃ£o de exclusÃ£o OK");

                exibirResultado("Teste PermissÃµes", {
                    escrita: "OK",
                    leitura: "OK",
                    exclusao: "OK",
                    status: "SUCESSO"
                }, 'success');

            } catch (error) {
                log(`âŒ Erro de permissÃ£o: ${error.message}`);
                exibirResultado("Erro PermissÃµes", { erro: error.message }, 'error');
            }
        }

        async function processarCompraDebug() {
            log("ğŸ’³ Processando compra debug com dados do formulÃ¡rio...");
            
            const nome = document.getElementById('nome-teste').value;
            const telefone = document.getElementById('telefone-teste').value;
            const email = document.getElementById('email-teste').value;

            if (!nome || !telefone) {
                alert("Preencha nome e telefone!");
                return;
            }

            try {
                if (!firebaseService) {
                    await testarConexaoFirebase();
                }

                const cartela = {
                    id: `compra-debug-${Date.now()}`,
                    comprador: nome,
                    telefone: telefone.replace(/\D/g, ''),
                    email: email,
                    numeros: [[1,2,3,4,5], [16,17,18,19,20], [31,'FREE',33,34,35], [46,47,48,49,50], [61,62,63,64,65]],
                    preco: 5.00,
                    vendida: true,
                    dataVenda: new Date().toISOString(),
                    origem: "compra-debug-form"
                };

                log("ğŸ’¾ Salvando cartela de compra debug...");
                const id = await firebaseService.salvarCartela(cartela);
                log(`âœ… Cartela salva com ID: ${id}`);

                // Verificar se foi salva
                await new Promise(resolve => setTimeout(resolve, 2000));
                const verificacao = await db.collection('cartelas').doc(id).get();
                
                if (verificacao.exists) {
                    log("âœ… Cartela confirmada no Firebase!");
                    alert("âœ… Compra processada com sucesso! Cartela salva no Firebase.");
                } else {
                    log("âŒ Cartela nÃ£o encontrada apÃ³s gravaÃ§Ã£o");
                    alert("âŒ Erro: Cartela nÃ£o encontrada apÃ³s gravaÃ§Ã£o");
                }

                exibirResultado("Compra Debug", {
                    cartela_id: id,
                    dados: cartela,
                    verificacao: verificacao.exists ? "ENCONTRADA" : "NÃƒO ENCONTRADA"
                }, verificacao.exists ? 'success' : 'error');

            } catch (error) {
                log(`âŒ Erro na compra debug: ${error.message}`);
                alert(`âŒ Erro: ${error.message}`);
                exibirResultado("Erro Compra Debug", { erro: error.message }, 'error');
            }
        }

        // Auto-inicializar
        window.addEventListener('load', () => {
            log("ğŸš€ Debug de gravaÃ§Ã£o Firebase iniciado");
            log("ğŸ“‹ Use os botÃµes para diagnosticar problema de gravaÃ§Ã£o");
        });

        // Capturar erros
        window.addEventListener('error', (e) => {
            log(`âŒ ERRO: ${e.message} em ${e.filename}:${e.lineno}`);
        });
    </script>
</body>
</html>
