<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBUG - Investiga√ß√£o de Grava√ß√£o Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .success { border-color: #4CAF50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .warning { border-color: #FF9800; background: #fff8e1; }
        .info { border-color: #2196F3; background: #f8f8ff; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-test { background: #2196F3; color: white; }
        .btn-fix { background: #FF9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .log {
            background: #2d2d2d;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.loading { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DEBUG - Investiga√ß√£o Firebase</h1>
        
        <div class="debug-section info">
            <h3>üìä Status do Sistema</h3>
            <div id="system-status" class="status loading">üîÑ Verificando sistema...</div>
        </div>
        
        <div class="debug-section">
            <h3>üß™ Testes de Diagn√≥stico</h3>
            <button class="btn-test" onclick="testarSDKFirebase()">1. Testar SDK Firebase</button>
            <button class="btn-test" onclick="testarInicializacao()">2. Testar Inicializa√ß√£o</button>
            <button class="btn-test" onclick="testarConexaoFirestore()">3. Testar Conex√£o Firestore</button>
            <button class="btn-test" onclick="testarGravacaoBasica()">4. Testar Grava√ß√£o B√°sica</button>
            <button class="btn-test" onclick="testarGravacaoCartela()">5. Testar Grava√ß√£o Cartela</button>
            <button class="btn-danger" onclick="limparLogs()">Limpar Logs</button>
        </div>
        
        <div class="debug-section">
            <h3>üìã Logs Detalhados</h3>
            <div id="debug-log" class="log">Iniciando diagn√≥stico...</div>
        </div>
        
        <div class="debug-section">
            <h3>üîß Informa√ß√µes do Sistema</h3>
            <div id="system-info">Coletando informa√ß√µes...</div>
        </div>
    </div>

    <!-- Firebase SDK v8 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            }[type] || '‚ÑπÔ∏è';
            
            const logMessage = `[${timestamp}] ${typeIcon} ${message}`;
            logs.push(logMessage);
            
            console.log(logMessage);
            
            const logDiv = document.getElementById('debug-log');
            logDiv.textContent = logs.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function limparLogs() {
            logs = [];
            document.getElementById('debug-log').textContent = 'Logs limpos...';
        }
        
        function updateStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('system-status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        async function coletarInformacoesBasicas() {
            const info = {
                'User Agent': navigator.userAgent,
                'URL Atual': window.location.href,
                'Firebase SDK Carregado': typeof firebase !== 'undefined',
                'Firebase App Dispon√≠vel': false,
                'FirebaseDB Dispon√≠vel': typeof window.FirebaseDB !== 'undefined',
                'Timestamp': new Date().toISOString()
            };
            
            try {
                if (typeof firebase !== 'undefined') {
                    info['Firebase App Dispon√≠vel'] = firebase.apps.length > 0;
                }
            } catch (e) {
                info['Erro Firebase Apps'] = e.message;
            }
            
            const infoDiv = document.getElementById('system-info');
            infoDiv.innerHTML = Object.entries(info)
                .map(([key, value]) => `<p><strong>${key}:</strong> ${value}</p>`)
                .join('');
            
            log('Informa√ß√µes b√°sicas coletadas');
        }
        
        async function testarSDKFirebase() {
            log('üî• Testando SDK Firebase...');
            
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o est√° carregado');
                }
                log('SDK Firebase encontrado', 'success');
                
                log(`Vers√£o do Firebase: ${firebase.SDK_VERSION || 'Desconhecida'}`);
                log(`Apps inicializados: ${firebase.apps.length}`);
                
                if (firebase.apps.length > 0) {
                    log(`Nome da app principal: ${firebase.apps[0].name}`, 'success');
                } else {
                    log('Nenhuma app Firebase inicializada', 'warning');
                }
                
            } catch (error) {
                log(`Erro no SDK Firebase: ${error.message}`, 'error');
            }
        }
        
        async function testarInicializacao() {
            log('‚öôÔ∏è Testando inicializa√ß√£o...');
            
            try {
                if (typeof initializeFirebaseUnified === 'function') {
                    log('Fun√ß√£o initializeFirebaseUnified encontrada');
                    await initializeFirebaseUnified();
                    log('Inicializa√ß√£o unificada executada', 'success');
                } else {
                    log('Fun√ß√£o initializeFirebaseUnified N√ÉO encontrada', 'warning');
                }
                
                if (window.FirebaseDB) {
                    log('FirebaseDB dispon√≠vel ap√≥s inicializa√ß√£o', 'success');
                    log(`M√©todos dispon√≠veis: ${Object.keys(window.FirebaseDB).join(', ')}`);
                } else {
                    log('FirebaseDB N√ÉO dispon√≠vel ap√≥s inicializa√ß√£o', 'error');
                }
                
            } catch (error) {
                log(`Erro na inicializa√ß√£o: ${error.message}`, 'error');
            }
        }
        
        async function testarConexaoFirestore() {
            log('üóÑÔ∏è Testando conex√£o Firestore...');
            
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o dispon√≠vel');
                }
                
                const db = firebase.firestore();
                log('Inst√¢ncia Firestore criada');
                
                // Testar acesso b√°sico
                const settings = db._settings || {};
                log(`Host Firestore: ${settings.host || 'padr√£o'}`);
                
                // Testar opera√ß√£o b√°sica
                const testRef = db.collection('teste-debug').doc('teste-conexao');
                await testRef.set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    teste: 'conexao-ok'
                });
                log('Grava√ß√£o de teste realizada com sucesso', 'success');
                
                // Testar leitura
                const doc = await testRef.get();
                if (doc.exists) {
                    log('Leitura de teste realizada com sucesso', 'success');
                } else {
                    log('Documento de teste n√£o encontrado', 'warning');
                }
                
            } catch (error) {
                log(`Erro na conex√£o Firestore: ${error.message}`, 'error');
                if (error.code) {
                    log(`C√≥digo do erro: ${error.code}`, 'error');
                }
            }
        }
        
        async function testarGravacaoBasica() {
            log('üíæ Testando grava√ß√£o b√°sica...');
            
            try {
                if (!window.FirebaseDB) {
                    throw new Error('FirebaseDB n√£o dispon√≠vel');
                }
                
                const db = firebase.firestore();
                
                // Dados de teste b√°sicos
                const dadosTeste = {
                    id: `teste-${Date.now()}`,
                    tipo: 'gravacao-basica',
                    timestamp: Date.now(),
                    timestampFirebase: firebase.firestore.FieldValue.serverTimestamp(),
                    dados: {
                        string: 'teste',
                        numero: 123,
                        booleano: true,
                        array: [1, 2, 3]
                    }
                };
                
                log('Dados preparados para teste');
                log(`ID do teste: ${dadosTeste.id}`);
                
                // Gravar usando add()
                const docRef = await db.collection('teste-gravacao').add(dadosTeste);
                log(`Grava√ß√£o b√°sica OK! Doc ID: ${docRef.id}`, 'success');
                
                // Verificar se foi gravado
                const doc = await docRef.get();
                if (doc.exists) {
                    log('Verifica√ß√£o: documento existe no banco', 'success');
                    const data = doc.data();
                    log(`Campos gravados: ${Object.keys(data).join(', ')}`);
                } else {
                    log('Verifica√ß√£o: documento N√ÉO existe no banco', 'error');
                }
                
            } catch (error) {
                log(`Erro na grava√ß√£o b√°sica: ${error.message}`, 'error');
                if (error.code) {
                    log(`C√≥digo do erro: ${error.code}`, 'error');
                }
            }
        }
        
        async function testarGravacaoCartela() {
            log('üéØ Testando grava√ß√£o de cartela...');
            
            try {
                if (!window.FirebaseDB || !window.FirebaseDB.saveCartela) {
                    throw new Error('M√©todo saveCartela n√£o dispon√≠vel');
                }
                
                // Gerar cartela de teste
                const cartela = {
                    id: `DEBUG-${Date.now()}`,
                    numeros: [1, 16, 31, 46, 61, 2, 17, 32, 47, 62, 3, 18, 33, 48, 63],
                    preco: 5.00,
                    status: 'vendida',
                    comprador: {
                        nome: 'Teste Debug',
                        telefone: '11999999999'
                    },
                    nome: 'Teste Debug',
                    telefone: '11999999999',
                    dataCompra: new Date(),
                    timestamp: Date.now()
                };
                
                log('Cartela de teste preparada');
                log(`ID da cartela: ${cartela.id}`);
                log(`N√∫meros: ${cartela.numeros.join(', ')}`);
                
                // Usar m√©todo saveCartela
                const resultado = await window.FirebaseDB.saveCartela(cartela);
                
                if (resultado && resultado.success) {
                    log(`Cartela salva com sucesso! ID Firebase: ${resultado.id}`, 'success');
                    
                    // Verificar se foi realmente salva
                    const db = firebase.firestore();
                    const doc = await db.collection('cartelas').doc(resultado.id).get();
                    
                    if (doc.exists) {
                        log('Verifica√ß√£o: cartela existe no banco', 'success');
                        const data = doc.data();
                        log(`Campos da cartela: ${Object.keys(data).join(', ')}`);
                        log(`Status da cartela: ${data.status}`);
                        log(`Nome comprador: ${data.nome || data.comprador?.nome}`);
                    } else {
                        log('Verifica√ß√£o: cartela N√ÉO existe no banco', 'error');
                    }
                } else {
                    throw new Error('M√©todo saveCartela retornou resultado inv√°lido');
                }
                
            } catch (error) {
                log(`Erro na grava√ß√£o de cartela: ${error.message}`, 'error');
                if (error.stack) {
                    log(`Stack trace: ${error.stack}`, 'error');
                }
            }
        }
        
        // Auto-inicializa√ß√£o
        window.addEventListener('load', async () => {
            updateStatus('üîÑ Carregando sistema...', 'loading');
            
            // Aguardar um pouco para carregamento completo
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            await coletarInformacoesBasicas();
            
            // Verificar status geral
            if (typeof firebase !== 'undefined' && window.FirebaseDB) {
                updateStatus('‚úÖ Sistema aparentemente funcionando', 'success');
                log('Sistema carregado - pronto para testes', 'success');
            } else {
                updateStatus('‚ö†Ô∏è Problemas detectados no sistema', 'error');
                log('Problemas detectados no carregamento', 'warning');
            }
        });
        
        // Escutar evento firebaseReady
        window.addEventListener('firebaseReady', () => {
            log('üéâ Evento firebaseReady detectado!', 'success');
            updateStatus('‚úÖ Firebase inicializado via evento', 'success');
        });
        
        log('Debug script carregado e pronto');
    </script>
</body>
</html>
