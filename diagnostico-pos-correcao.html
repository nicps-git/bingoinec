<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico P√≥s-Corre√ß√£o - Firebase</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .success { background: #28a745; }
        .error { background: #dc3545; }
        .warning { background: #ffc107; }
        .info { background: #17a2b8; }
        button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        .log-area {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .summary {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        h1, h2 { margin: 0 0 10px 0; }
        .big-status {
            font-size: 2em;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• Diagn√≥stico P√≥s-Corre√ß√£o Firebase</h1>
            <p>Verifica√ß√£o completa ap√≥s aplica√ß√£o das novas regras</p>
        </div>

        <div id="big-status" class="big-status">
            <span class="status-indicator info"></span>
            Aguardando verifica√ß√£o...
        </div>

        <div style="text-align: center;">
            <button onclick="executarDiagnosticoCompleto()">üöÄ Diagn√≥stico Completo</button>
            <button onclick="testarSistemaCompleto()">üéØ Testar Sistema Principal</button>
            <button onclick="limparTudo()">üßπ Limpar</button>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>üîó Conectividade</h3>
                <div id="status-conexao">
                    <span class="status-indicator info"></span>
                    Aguardando teste
                </div>
            </div>
            <div class="status-card">
                <h3>üîë Permiss√µes</h3>
                <div id="status-permissoes">
                    <span class="status-indicator info"></span>
                    Aguardando teste
                </div>
            </div>
            <div class="status-card">
                <h3>üìù CRUD</h3>
                <div id="status-crud">
                    <span class="status-indicator info"></span>
                    Aguardando teste
                </div>
            </div>
            <div class="status-card">
                <h3>üîÑ Sincroniza√ß√£o</h3>
                <div id="status-sync">
                    <span class="status-indicator info"></span>
                    Aguardando teste
                </div>
            </div>
        </div>

        <div class="summary">
            <h2>üìä Resumo dos Testes</h2>
            <div id="resumo">Nenhum teste executado ainda</div>
        </div>

        <div class="log-area" id="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCWcZMF4Yty2aX7vAHUs_LI5R6N0S8NRy4",
            authDomain: "bingoinec.firebaseapp.com",
            projectId: "bingoinec",
            storageBucket: "bingoinec.firebasestorage.app",
            messagingSenderId: "483007152008",
            appId: "1:483007152008:web:6347c02216e162c0a3c43d"
        };

        let db;
        let resultados = {};

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(categoria, status, message) {
            const statusEl = document.getElementById(`status-${categoria}`);
            const indicator = statusEl.querySelector('.status-indicator');
            
            indicator.className = `status-indicator ${status}`;
            statusEl.innerHTML = `<span class="status-indicator ${status}"></span>${message}`;
            
            resultados[categoria] = { status, message };
            atualizarResumo();
        }

        function atualizarResumo() {
            const total = Object.keys(resultados).length;
            const sucessos = Object.values(resultados).filter(r => r.status === 'success').length;
            const erros = Object.values(resultados).filter(r => r.status === 'error').length;
            
            const resumoEl = document.getElementById('resumo');
            resumoEl.innerHTML = `
                <strong>Testes Executados:</strong> ${total}/4<br>
                <span style="color: #28a745;">‚úÖ Sucessos: ${sucessos}</span> | 
                <span style="color: #dc3545;">‚ùå Erros: ${erros}</span>
            `;

            // Atualizar status geral
            const bigStatusEl = document.getElementById('big-status');
            if (total === 4) {
                if (erros === 0) {
                    bigStatusEl.innerHTML = '<span class="status-indicator success"></span>üéâ SISTEMA TOTALMENTE FUNCIONAL!';
                } else {
                    bigStatusEl.innerHTML = '<span class="status-indicator error"></span>‚ö†Ô∏è ALGUNS PROBLEMAS DETECTADOS';
                }
            }
        }

        async function inicializarFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                log('‚úÖ Firebase inicializado com sucesso');
                return true;
            } catch (error) {
                log('‚ùå Erro ao inicializar Firebase: ' + error.message);
                return false;
            }
        }

        async function testarConexao() {
            log('üîó Testando conectividade Firebase...');
            try {
                const testRef = db.collection('_diagnostico').doc('conexao');
                await testRef.set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    teste: 'conectividade'
                });
                
                const doc = await testRef.get();
                if (doc.exists) {
                    await testRef.delete();
                    updateStatus('conexao', 'success', 'Conectividade OK');
                    log('‚úÖ Teste de conectividade passou');
                    return true;
                }
            } catch (error) {
                updateStatus('conexao', 'error', 'Erro: ' + error.message);
                log('‚ùå Erro de conectividade: ' + error.message);
                return false;
            }
        }

        async function testarPermissoes() {
            log('üîë Testando permiss√µes espec√≠ficas...');
            try {
                const colecoes = ['configuracoes', 'cartelas', 'numeros-sorteados'];
                let sucessos = 0;
                
                for (const colecao of colecoes) {
                    const testRef = db.collection(colecao).doc('teste_permissao');
                    await testRef.set({ teste: true });
                    await testRef.delete();
                    sucessos++;
                    log(`‚úÖ Permiss√µes OK para ${colecao}`);
                }
                
                updateStatus('permissoes', 'success', `${sucessos}/${colecoes.length} cole√ß√µes OK`);
                log('‚úÖ Todas as permiss√µes funcionando');
                return true;
            } catch (error) {
                updateStatus('permissoes', 'error', 'Erro: ' + error.message);
                log('‚ùå Erro de permiss√µes: ' + error.message);
                return false;
            }
        }

        async function testarCRUD() {
            log('üìù Testando opera√ß√µes CRUD...');
            try {
                const testId = 'crud_test_' + Date.now();
                
                // Create
                await db.collection('_teste_crud').doc(testId).set({
                    nome: 'Teste CRUD',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                log('‚úÖ CREATE: Documento criado');
                
                // Read
                const doc = await db.collection('_teste_crud').doc(testId).get();
                if (!doc.exists) throw new Error('Documento n√£o encontrado');
                log('‚úÖ READ: Documento lido');
                
                // Update
                await db.collection('_teste_crud').doc(testId).update({
                    atualizado: true
                });
                log('‚úÖ UPDATE: Documento atualizado');
                
                // Delete
                await db.collection('_teste_crud').doc(testId).delete();
                log('‚úÖ DELETE: Documento removido');
                
                updateStatus('crud', 'success', 'Todas opera√ß√µes OK');
                return true;
            } catch (error) {
                updateStatus('crud', 'error', 'Erro: ' + error.message);
                log('‚ùå Erro CRUD: ' + error.message);
                return false;
            }
        }

        async function testarSincronizacao() {
            log('üîÑ Testando sincroniza√ß√£o em tempo real...');
            try {
                let changeDetected = false;
                const testRef = db.collection('_teste_sync').doc('sync_test');
                
                // Configurar listener
                const unsubscribe = testRef.onSnapshot((doc) => {
                    if (doc.exists && doc.data().teste) {
                        changeDetected = true;
                        log('‚úÖ Mudan√ßa detectada em tempo real');
                    }
                });
                
                // Aguardar configura√ß√£o do listener
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Criar mudan√ßa
                await testRef.set({
                    teste: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Aguardar detec√ß√£o
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Limpar
                unsubscribe();
                await testRef.delete();
                
                if (changeDetected) {
                    updateStatus('sync', 'success', 'Sincroniza√ß√£o funcionando');
                    log('‚úÖ Sincroniza√ß√£o em tempo real OK');
                    return true;
                } else {
                    updateStatus('sync', 'warning', 'Sincroniza√ß√£o lenta');
                    log('‚ö†Ô∏è Sincroniza√ß√£o detectada mas lenta');
                    return false;
                }
            } catch (error) {
                updateStatus('sync', 'error', 'Erro: ' + error.message);
                log('‚ùå Erro sincroniza√ß√£o: ' + error.message);
                return false;
            }
        }

        async function executarDiagnosticoCompleto() {
            log('üöÄ Iniciando diagn√≥stico completo p√≥s-corre√ß√£o...');
            
            // Resetar resultados
            resultados = {};
            
            if (!db) {
                const init = await inicializarFirebase();
                if (!init) return;
            }
            
            // Executar testes em sequ√™ncia
            const resultados = [
                await testarConexao(),
                await testarPermissoes(),
                await testarCRUD(),
                await testarSincronizacao()
            ];
            
            const sucessos = resultados.filter(r => r).length;
            
            if (sucessos === 4) {
                log('üéâ PERFEITO: Todos os testes passaram! O problema de permiss√µes foi resolvido.');
            } else {
                log(`‚ö†Ô∏è ATEN√á√ÉO: ${sucessos}/4 testes passaram. Ainda h√° problemas.`);
            }
        }

        async function testarSistemaCompleto() {
            log('üéØ Testando funcionalidades do sistema principal...');
            try {
                // Testar configura√ß√µes
                await db.collection('configuracoes').doc('principais').set({
                    numeroInicial: 1,
                    numeroFinal: 75,
                    precoCartela: 5.00,
                    teste: true
                });
                log('‚úÖ Configura√ß√µes: OK');
                
                // Testar cartela
                await db.collection('cartelas').doc('teste_sistema').set({
                    numeros: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],
                    vendida: true,
                    comprador: 'Teste Sistema'
                });
                log('‚úÖ Cartelas: OK');
                
                // Testar n√∫meros sorteados
                await db.collection('numeros-sorteados').doc('lista').set({
                    numeros: [1, 5, 10]
                });
                log('‚úÖ N√∫meros sorteados: OK');
                
                // Limpar testes
                await db.collection('configuracoes').doc('principais').delete();
                await db.collection('cartelas').doc('teste_sistema').delete();
                await db.collection('numeros-sorteados').doc('lista').delete();
                
                log('üéâ Sistema principal totalmente funcional!');
            } catch (error) {
                log('‚ùå Erro no sistema principal: ' + error.message);
            }
        }

        function limparTudo() {
            resultados = {};
            document.getElementById('log').innerHTML = '';
            document.getElementById('big-status').innerHTML = '<span class="status-indicator info"></span>Aguardando verifica√ß√£o...';
            
            ['conexao', 'permissoes', 'crud', 'sync'].forEach(cat => {
                updateStatus(cat, 'info', 'Aguardando teste');
            });
            
            document.getElementById('resumo').textContent = 'Nenhum teste executado ainda';
            log('üßπ Interface limpa e pronta para novos testes');
        }

        // Auto-inicializar
        window.addEventListener('load', () => {
            log('üî• Diagn√≥stico p√≥s-corre√ß√£o carregado');
            log('üí° As regras do Firestore foram atualizadas para permitir acesso total');
            log('üëÜ Clique em "Diagn√≥stico Completo" para verificar se tudo funciona');
        });
    </script>
</body>
</html>
