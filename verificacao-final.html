<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificação Final - Sistema Corrigido</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ok { background: #2ecc71; }
        .erro { background: #e74c3c; }
        .warning { background: #f39c12; }
        .info { background: #3498db; }
        button {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        button:hover { 
            background: #8e44ad; 
            transform: translateY(-2px);
        }
        .resultado {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .card:hover {
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-5px);
        }
        h1, h2 { text-align: center; }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .badge.ok { background: #2ecc71; }
        .badge.erro { background: #e74c3c; }
        .badge.warning { background: #f39c12; color: black; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Verificação Final - Sistema Corrigido</h1>
        <p style="text-align: center; opacity: 0.8;">Teste completo das correções aplicadas</p>
        
        <div class="grid">
            <div class="card">
                <h3>🔥 Status Firebase</h3>
                <div id="status-firebase" class="status warning">⏳ Verificando...</div>
                <div id="detalhes-firebase"></div>
            </div>
            
            <div class="card">
                <h3>⚙️ Status Funções</h3>
                <div id="status-funcoes" class="status warning">⏳ Verificando...</div>
                <div id="detalhes-funcoes"></div>
            </div>
        </div>
        
        <h2>🧪 Testes Funcionais</h2>
        <div style="text-align: center;">
            <button onclick="fluxoCompleto()">🔄 Teste Fluxo Completo</button>
            <button onclick="testarGeracao()">🎲 Só Geração</button>
            <button onclick="testarCarrinho()">🛒 Só Carrinho</button>
            <button onclick="testarCompra()">💳 Só Compra</button>
            <button onclick="limparTudo()">🗑️ Limpar</button>
        </div>
        
        <div id="resultado" class="resultado">Sistema carregando...</div>
    </div>

    <!-- Scripts obrigatórios -->
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
    <script src="cartelas.js"></script>

    <script>
        let log = (msg) => {
            console.log(msg);
            document.getElementById('resultado').innerHTML += msg + '\n';
            document.getElementById('resultado').scrollTop = document.getElementById('resultado').scrollHeight;
        };
        
        let limparLog = () => document.getElementById('resultado').innerHTML = '';
        
        async function verificarSistema() {
            // Firebase
            const firebaseOk = window.FirebaseDB && typeof firebase !== 'undefined' && firebase.firestore;
            const statusFirebase = document.getElementById('status-firebase');
            const detalhesFirebase = document.getElementById('detalhes-firebase');
            
            if (firebaseOk) {
                statusFirebase.innerHTML = '✅ Firebase Online';
                statusFirebase.className = 'status ok';
                detalhesFirebase.innerHTML = `
                    <small>
                        • Firebase SDK: ✅<br>
                        • Firestore: ✅<br>
                        • FirebaseDB: ✅
                    </small>`;
            } else {
                statusFirebase.innerHTML = '❌ Firebase Offline';
                statusFirebase.className = 'status erro';
                detalhesFirebase.innerHTML = `
                    <small>
                        • Firebase SDK: ${typeof firebase !== 'undefined' ? '✅' : '❌'}<br>
                        • Firestore: ${typeof firebase !== 'undefined' && firebase.firestore ? '✅' : '❌'}<br>
                        • FirebaseDB: ${window.FirebaseDB ? '✅' : '❌'}
                    </small>`;
            }
            
            // Funções
            const funcoes = {
                gerarCartelaCorrigida: typeof gerarCartelaCorrigida === 'function',
                adicionarAoCarrinhoCorrigida: typeof adicionarAoCarrinhoCorrigida === 'function',
                processarCompraCorrigida: typeof processarCompraCorrigida === 'function'
            };
            
            const funcoesOk = Object.values(funcoes).every(f => f);
            const statusFuncoes = document.getElementById('status-funcoes');
            const detalhesFuncoes = document.getElementById('detalhes-funcoes');
            
            if (funcoesOk) {
                statusFuncoes.innerHTML = '✅ Todas Disponíveis';
                statusFuncoes.className = 'status ok';
            } else {
                statusFuncoes.innerHTML = '❌ Problemas Detectados';
                statusFuncoes.className = 'status erro';
            }
            
            detalhesFuncoes.innerHTML = `
                <small>
                    • Geração: ${funcoes.gerarCartelaCorrigida ? '✅' : '❌'}<br>
                    • Carrinho: ${funcoes.adicionarAoCarrinhoCorrigida ? '✅' : '❌'}<br>
                    • Compra: ${funcoes.processarCompraCorrigida ? '✅' : '❌'}
                </small>`;
            
            return { firebaseOk, funcoesOk };
        }
        
        async function fluxoCompleto() {
            limparLog();
            log('🚀 === TESTE FLUXO COMPLETO ===\n');
            
            try {
                // 1. Verificar sistema
                log('1️⃣ Verificando sistema...');
                const { firebaseOk, funcoesOk } = await verificarSistema();
                
                if (!firebaseOk) {
                    throw new Error('Firebase não está disponível');
                }
                
                if (!funcoesOk) {
                    throw new Error('Nem todas as funções estão disponíveis');
                }
                
                log('✅ Sistema OK para prosseguir\n');
                
                // 2. Gerar cartela
                log('2️⃣ Gerando cartela com reserva temporária...');
                const cartela = await gerarCartelaCorrigida();
                
                if (!cartela) {
                    throw new Error('Falha na geração da cartela');
                }
                
                log(`✅ Cartela gerada: ${cartela.id}`);
                log(`📋 Números: [${cartela.numeros.join(', ')}]`);
                log(`💰 Preço: R$ ${cartela.preco.toFixed(2)}\n`);
                
                // 3. Adicionar ao carrinho
                log('3️⃣ Adicionando ao carrinho...');
                adicionarAoCarrinhoCorrigida();
                
                const carrinho = window.carrinho || [];
                if (carrinho.length === 0) {
                    throw new Error('Falha ao adicionar ao carrinho');
                }
                
                log(`✅ Carrinho: ${carrinho.length} item(s)`);
                log(`📋 Último item: ${carrinho[carrinho.length - 1].id}\n`);
                
                // 4. Simular compra
                log('4️⃣ Simulando processamento de compra...');
                
                // Mock do evento
                const mockEvent = {
                    preventDefault: () => {},
                    target: {
                        querySelector: () => ({ 
                            textContent: 'Processando...', 
                            disabled: false,
                            style: {}
                        }),
                        elements: {
                            nome: { value: 'Usuário Teste' },
                            telefone: { value: '(11) 99999-9999' }
                        }
                    }
                };
                
                // Mock do FormData
                const originalFormData = window.FormData;
                window.FormData = function(form) {
                    return {
                        get: (name) => {
                            const dados = {
                                nome: 'Usuário Teste',
                                telefone: '(11) 99999-9999'
                            };
                            return dados[name] || '';
                        }
                    };
                };
                
                await processarCompraCorrigida(mockEvent);
                
                // Restaurar FormData
                window.FormData = originalFormData;
                
                log('✅ Compra processada com sucesso!\n');
                log('🎉 FLUXO COMPLETO EXECUTADO COM SUCESSO!');
                
            } catch (error) {
                log(`❌ ERRO NO FLUXO: ${error.message}`);
                console.error('Erro completo:', error);
            }
        }
        
        async function testarGeracao() {
            limparLog();
            log('🎲 === TESTE: GERAÇÃO DE CARTELA ===\n');
            
            try {
                if (typeof gerarCartelaCorrigida !== 'function') {
                    throw new Error('gerarCartelaCorrigida não está disponível');
                }
                
                const cartela = await gerarCartelaCorrigida();
                
                log(`✅ Cartela gerada: ${cartela.id}`);
                log(`📋 Números: [${cartela.numeros.join(', ')}]`);
                log(`💰 Preço: R$ ${cartela.preco.toFixed(2)}`);
                log(`🔒 Reservada: ${window.cartelaReservada ? 'SIM' : 'NÃO'}`);
                
            } catch (error) {
                log(`❌ Erro: ${error.message}`);
            }
        }
        
        async function testarCarrinho() {
            limparLog();
            log('🛒 === TESTE: CARRINHO ===\n');
            
            try {
                if (!window.cartelaReservada) {
                    log('⚠️ Gerando cartela primeiro...');
                    await testarGeracao();
                    log('');
                }
                
                if (typeof adicionarAoCarrinhoCorrigida !== 'function') {
                    throw new Error('adicionarAoCarrinhoCorrigida não está disponível');
                }
                
                adicionarAoCarrinhoCorrigida();
                
                const carrinho = window.carrinho || [];
                log(`✅ Carrinho: ${carrinho.length} item(s)`);
                
                carrinho.forEach((item, i) => {
                    log(`   ${i + 1}. ${item.id} - [${item.numeros.join(', ')}]`);
                });
                
            } catch (error) {
                log(`❌ Erro: ${error.message}`);
            }
        }
        
        async function testarCompra() {
            limparLog();
            log('💳 === TESTE: COMPRA ===\n');
            
            try {
                const carrinho = window.carrinho || [];
                if (carrinho.length === 0) {
                    log('⚠️ Adicionando item ao carrinho...');
                    await testarCarrinho();
                    log('');
                }
                
                log('💳 Processando compra simulada...');
                
                // Simular compra conforme implementação real
                const mockEvent = {
                    preventDefault: () => {},
                    target: {
                        querySelector: () => ({ 
                            textContent: 'Processando...', 
                            disabled: false 
                        })
                    }
                };
                
                window.FormData = function() {
                    return {
                        get: (name) => name === 'nome' ? 'Teste Completo' : '(11) 88888-8888'
                    };
                };
                
                await processarCompraCorrigida(mockEvent);
                
                log('✅ Compra simulada executada!');
                
            } catch (error) {
                log(`❌ Erro: ${error.message}`);
            }
        }
        
        function limparTudo() {
            limparLog();
            log('🗑️ Limpando tudo...\n');
            
            window.carrinho = [];
            window.cartelaReservada = null;
            window.cartelaAtual = null;
            window.numerosCartelaAtual = null;
            localStorage.removeItem('bingo-carrinho');
            
            log('✅ Sistema limpo!');
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            limparLog();
            log('🚀 Sistema de verificação carregado!\n');
            log('Aguardando carregamento do Firebase e funções...\n');
            
            setTimeout(async () => {
                await verificarSistema();
                log('✅ Verificação inicial concluída.');
                log('Clique nos botões acima para testar o sistema.\n');
            }, 3000);
        });
        
        // Atualização periódica
        setInterval(verificarSistema, 15000);
    </script>
</body>
</html>
