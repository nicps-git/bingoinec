<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Investiga√ß√£o: Cartelas N√£o Salvam no Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .log-area {
            background: #000;
            color: #0f0;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #000; }
        .section-title {
            color: #333;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Investiga√ß√£o: Por que as Cartelas N√£o Salvam no Firebase?</h1>
        
        <div class="alert alert-danger">
            <strong>‚ùå PROBLEMA IDENTIFICADO:</strong> 
            N√£o existem cartelas salvas no Firebase! Apenas n√∫meros sorteados est√£o sendo salvos.
        </div>

        <div class="test-section">
            <h3 class="section-title">üîß Diagn√≥stico do Problema</h3>
            <button onclick="verificarColecoes()" class="btn-warning">1. Verificar Todas as Cole√ß√µes</button>
            <button onclick="testarSalvamentoCartela()" class="btn-danger">2. Testar Salvamento de Cartela</button>
            <button onclick="verificarErrosSalvamento()" class="btn-warning">3. Verificar Erros de Salvamento</button>
            <button onclick="debugFluxoCompra()" class="btn-success">4. Debug Fluxo de Compra</button>
        </div>

        <div class="test-section">
            <h3 class="section-title">üíæ Teste de Salvamento Manual</h3>
            <input type="text" id="nomeComprador" placeholder="Nome do comprador" value="Teste Manual">
            <input type="text" id="telefoneComprador" placeholder="Telefone" value="85966666666">
            <button onclick="criarCartelaManual()" class="btn-success">Criar Cartela Manualmente</button>
            <button onclick="verificarCartelaCriada()" class="btn-warning">Verificar se Foi Criada</button>
        </div>

        <div class="test-section">
            <h3 class="section-title">üîí Verifica√ß√£o de Regras e Permiss√µes</h3>
            <button onclick="verificarRegrasFirestore()" class="btn-warning">Verificar Regras do Firestore</button>
            <button onclick="testarPermissoes()" class="btn-warning">Testar Permiss√µes</button>
            <button onclick="verificarConfiguracaoFirebase()" class="btn-warning">Verificar Configura√ß√£o</button>
        </div>

        <div class="test-section">
            <h3 class="section-title">üìã Log de Diagn√≥stico</h3>
            <div id="logArea" class="log-area"></div>
            <button onclick="limparLog()">Limpar Log</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            const colors = {
                'error': '#ff6b6b',
                'success': '#51cf66',
                'warning': '#ffd43b',
                'info': '#74c0fc',
                'critical': '#ff0080'
            };
            
            logArea.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(`[DEBUG] ${message}`);
        }

        async function verificarColecoes() {
            log('üîç VERIFICANDO TODAS AS COLE√á√ïES NO FIREBASE...', 'critical');
            
            try {
                const db = firebase.firestore();
                
                // Lista de poss√≠veis nomes de cole√ß√µes
                const possiveisColecoes = [
                    'cartelas', 'cartela', 'bingo', 'rifas', 'vendas', 'compras',
                    'usuarios', 'config', 'numeros-sorteados', 'sorteios',
                    'participantes', 'clientes', 'tickets'
                ];
                
                log('üìä Testando cole√ß√µes poss√≠veis...', 'info');
                
                let colecoesEncontradas = 0;
                
                for (const nomeColecao of possiveisColecoes) {
                    try {
                        const snapshot = await db.collection(nomeColecao).limit(1).get();
                        if (!snapshot.empty) {
                            const count = await db.collection(nomeColecao).get();
                            log(`‚úÖ Cole√ß√£o "${nomeColecao}": ${count.size} documentos`, 'success');
                            colecoesEncontradas++;
                            
                            // Mostrar estrutura do primeiro documento
                            const primeiro = snapshot.docs[0];
                            const dados = primeiro.data();
                            log(`   üìÑ Exemplo: ${JSON.stringify(dados, null, 2)}`, 'info');
                        }
                    } catch (error) {
                        log(`‚ùå Cole√ß√£o "${nomeColecao}": n√£o existe`, 'warning');
                    }
                }
                
                if (colecoesEncontradas === 0) {
                    log('‚ùå NENHUMA COLE√á√ÉO ENCONTRADA!', 'error');
                } else {
                    log(`üìä Total de cole√ß√µes encontradas: ${colecoesEncontradas}`, 'info');
                }
                
                // Verificar especificamente a cole√ß√£o 'cartelas'
                try {
                    const cartelasSnapshot = await db.collection('cartelas').get();
                    if (cartelasSnapshot.empty) {
                        log('‚ùå CONFIRMADO: Cole√ß√£o "cartelas" est√° VAZIA!', 'error');
                    } else {
                        log(`‚úÖ Cole√ß√£o "cartelas" tem ${cartelasSnapshot.size} documentos`, 'success');
                    }
                } catch (error) {
                    log(`‚ùå Erro ao acessar cole√ß√£o "cartelas": ${error.message}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå ERRO CR√çTICO: ${error.message}`, 'error');
            }
        }

        async function testarSalvamentoCartela() {
            log('üíæ TESTANDO SALVAMENTO DE CARTELA...', 'critical');
            
            try {
                const db = firebase.firestore();
                
                const cartelaTeste = {
                    id: `teste_${Date.now()}`,
                    numeroCartela: 1,
                    numeros: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                    preco: 1.00,
                    vendida: true,
                    comprador: 'Teste Salvamento',
                    telefone: '85999999999',
                    email: 'teste@example.com',
                    dataVenda: new Date().toISOString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    testeSalvamento: true
                };
                
                log('üìù Dados da cartela a ser salva:', 'info');
                log(`${JSON.stringify(cartelaTeste, null, 2)}`, 'info');
                
                // Tentar salvar
                log('üíæ Salvando cartela...', 'info');
                await db.collection('cartelas').doc(cartelaTeste.id).set(cartelaTeste);
                log('‚úÖ Cartela salva com sucesso!', 'success');
                
                // Verificar se foi realmente salva
                log('üîç Verificando se foi salva...', 'info');
                const doc = await db.collection('cartelas').doc(cartelaTeste.id).get();
                
                if (doc.exists) {
                    log('‚úÖ CONFIRMADO: Cartela foi salva no Firebase!', 'success');
                    log(`üìÑ Dados salvos: ${JSON.stringify(doc.data(), null, 2)}`, 'info');
                } else {
                    log('‚ùå FALHA: Cartela n√£o foi salva!', 'error');
                }
                
                // Verificar se aparece na listagem da cole√ß√£o
                const colecaoSnapshot = await db.collection('cartelas').get();
                log(`üìä Total de cartelas na cole√ß√£o ap√≥s salvamento: ${colecaoSnapshot.size}`, 'info');
                
                // Limpeza
                await db.collection('cartelas').doc(cartelaTeste.id).delete();
                log('üóëÔ∏è Cartela de teste removida', 'info');
                
            } catch (error) {
                log(`‚ùå ERRO NO TESTE DE SALVAMENTO: ${error.message}`, 'error');
                log(`   C√≥digo do erro: ${error.code}`, 'error');
                log(`   Stack: ${error.stack}`, 'error');
            }
        }

        async function verificarErrosSalvamento() {
            log('üîç VERIFICANDO ERROS DE SALVAMENTO...', 'critical');
            
            // Verificar se firebaseService est√° carregado
            if (typeof firebaseService === 'undefined') {
                log('‚ùå firebaseService n√£o est√° carregado!', 'error');
                log('   Isso pode impedir o salvamento de cartelas', 'warning');
            } else {
                log('‚úÖ firebaseService est√° carregado', 'success');
                
                // Verificar se a fun√ß√£o salvarCartela existe
                if (typeof firebaseService.salvarCartela === 'function') {
                    log('‚úÖ Fun√ß√£o salvarCartela existe', 'success');
                } else {
                    log('‚ùå Fun√ß√£o salvarCartela N√ÉO existe!', 'error');
                }
            }
            
            // Verificar se firebase-config est√° funcionando
            try {
                if (typeof firebase !== 'undefined') {
                    log('‚úÖ Firebase SDK carregado', 'success');
                    
                    const db = firebase.firestore();
                    log('‚úÖ Firestore inicializado', 'success');
                    
                    // Verificar configura√ß√£o
                    const app = firebase.app();
                    log(`üìã Projeto ID: ${app.options.projectId}`, 'info');
                    log(`üìã Auth Domain: ${app.options.authDomain}`, 'info');
                    
                } else {
                    log('‚ùå Firebase SDK N√ÉO carregado!', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro na verifica√ß√£o do Firebase: ${error.message}`, 'error');
            }
            
            // Verificar localStorage para backup
            try {
                const cartelasLocais = localStorage.getItem('bingo_cartelas_vendidas');
                if (cartelasLocais) {
                    const cartelas = JSON.parse(cartelasLocais);
                    log(`üì¶ Cartelas no localStorage: ${cartelas.length}`, 'warning');
                    log('   Isso indica que as cartelas podem estar sendo salvas localmente', 'warning');
                } else {
                    log('üì¶ Nenhuma cartela no localStorage', 'info');
                }
            } catch (error) {
                log(`‚ùå Erro ao verificar localStorage: ${error.message}`, 'error');
            }
        }

        async function debugFluxoCompra() {
            log('üõí DEBUG DO FLUXO DE COMPRA...', 'critical');
            
            // Simular dados de uma compra
            const dadosCompra = {
                comprador: {
                    nome: 'Debug User',
                    telefone: '85999999999',
                    email: 'debug@test.com'
                },
                carrinho: [{
                    numeros: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                    preco: 1.00
                }]
            };
            
            log('üë§ Simulando compra com dados:', 'info');
            log(`${JSON.stringify(dadosCompra, null, 2)}`, 'info');
            
            // Verificar se o processo de prepara√ß√£o funciona
            try {
                // Fun√ß√£o de normaliza√ß√£o
                function normalizarTelefone(telefone) {
                    return telefone.replace(/\D/g, '');
                }
                
                const cartelasParaSalvar = dadosCompra.carrinho.map(item => ({
                    id: `debug_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    numeros: item.numeros,
                    preco: item.preco,
                    vendida: true,
                    comprador: dadosCompra.comprador.nome,
                    telefone: normalizarTelefone(dadosCompra.comprador.telefone),
                    email: dadosCompra.comprador.email,
                    dataVenda: new Date().toISOString(),
                    timestamp: new Date()
                }));
                
                log('üì¶ Cartelas preparadas para salvamento:', 'success');
                log(`${JSON.stringify(cartelasParaSalvar, null, 2)}`, 'info');
                
                // Tentar salvar usando diferentes m√©todos
                const db = firebase.firestore();
                
                // M√©todo 1: Salvamento direto
                log('üíæ M√©todo 1: Salvamento direto...', 'info');
                for (const cartela of cartelasParaSalvar) {
                    await db.collection('cartelas').doc(cartela.id).set(cartela);
                    log(`‚úÖ Cartela ${cartela.id} salva diretamente`, 'success');
                }
                
                // Verificar se foi salva
                const verificacao = await db.collection('cartelas').get();
                log(`üìä Cartelas na cole√ß√£o ap√≥s debug: ${verificacao.size}`, 'info');
                
                // M√©todo 2: Usando firebaseService (se existir)
                if (typeof firebaseService !== 'undefined' && firebaseService.salvarCartela) {
                    log('üíæ M√©todo 2: Usando firebaseService...', 'info');
                    try {
                        const cartelaFirebaseService = {
                            ...cartelasParaSalvar[0],
                            id: `service_${Date.now()}`
                        };
                        await firebaseService.salvarCartela(cartelaFirebaseService);
                        log('‚úÖ Cartela salva via firebaseService', 'success');
                    } catch (serviceError) {
                        log(`‚ùå Erro no firebaseService: ${serviceError.message}`, 'error');
                    }
                }
                
                // Limpeza
                for (const cartela of cartelasParaSalvar) {
                    try {
                        await db.collection('cartelas').doc(cartela.id).delete();
                    } catch (e) {
                        // Ignore cleanup errors
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro no debug do fluxo: ${error.message}`, 'error');
            }
        }

        async function criarCartelaManual() {
            const nome = document.getElementById('nomeComprador').value;
            const telefone = document.getElementById('telefoneComprador').value;
            
            log(`üíæ CRIANDO CARTELA MANUAL - Nome: ${nome}, Telefone: ${telefone}`, 'critical');
            
            try {
                const db = firebase.firestore();
                
                const cartela = {
                    id: `manual_${Date.now()}`,
                    numeroCartela: 999,
                    numeros: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                    preco: 1.00,
                    vendida: true,
                    comprador: nome,
                    telefone: telefone.replace(/\D/g, ''),
                    email: 'manual@test.com',
                    dataVenda: new Date().toISOString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    criacaoManual: true
                };
                
                log('üìù Salvando cartela manual...', 'info');
                await db.collection('cartelas').doc(cartela.id).set(cartela);
                log(`‚úÖ Cartela manual criada: ${cartela.id}`, 'success');
                
                // Salvar ID para verifica√ß√£o posterior
                window.ultimaCartelaManual = cartela.id;
                
            } catch (error) {
                log(`‚ùå Erro ao criar cartela manual: ${error.message}`, 'error');
            }
        }

        async function verificarCartelaCriada() {
            if (!window.ultimaCartelaManual) {
                log('‚ö†Ô∏è Nenhuma cartela manual foi criada ainda', 'warning');
                return;
            }
            
            log(`üîç VERIFICANDO CARTELA CRIADA: ${window.ultimaCartelaManual}`, 'info');
            
            try {
                const db = firebase.firestore();
                
                // Verificar por ID
                const doc = await db.collection('cartelas').doc(window.ultimaCartelaManual).get();
                
                if (doc.exists) {
                    log('‚úÖ Cartela encontrada por ID!', 'success');
                    log(`üìÑ Dados: ${JSON.stringify(doc.data(), null, 2)}`, 'info');
                } else {
                    log('‚ùå Cartela N√ÉO encontrada por ID!', 'error');
                }
                
                // Verificar na cole√ß√£o geral
                const colecao = await db.collection('cartelas').get();
                log(`üìä Total na cole√ß√£o: ${colecao.size} cartelas`, 'info');
                
                // Buscar por telefone
                const telefone = document.getElementById('telefoneComprador').value.replace(/\D/g, '');
                const porTelefone = await db.collection('cartelas')
                    .where('telefone', '==', telefone)
                    .get();
                
                log(`üì± Busca por telefone "${telefone}": ${porTelefone.size} resultados`, 'info');
                
            } catch (error) {
                log(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error');
            }
        }

        async function verificarRegrasFirestore() {
            log('üîí VERIFICANDO REGRAS DO FIRESTORE...', 'info');
            
            try {
                const db = firebase.firestore();
                
                // Teste de leitura
                log('üìñ Testando leitura...', 'info');
                try {
                    await db.collection('cartelas').limit(1).get();
                    log('‚úÖ Leitura: PERMITIDA', 'success');
                } catch (readError) {
                    log(`‚ùå Leitura: NEGADA - ${readError.message}`, 'error');
                }
                
                // Teste de escrita
                log('üìù Testando escrita...', 'info');
                try {
                    const testDoc = {
                        teste: true,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    const docRef = await db.collection('cartelas').add(testDoc);
                    log('‚úÖ Escrita: PERMITIDA', 'success');
                    
                    // Limpeza
                    await docRef.delete();
                    log('üóëÔ∏è Documento de teste removido', 'info');
                } catch (writeError) {
                    log(`‚ùå Escrita: NEGADA - ${writeError.message}`, 'error');
                    log(`   C√≥digo: ${writeError.code}`, 'error');
                    
                    if (writeError.code === 'permission-denied') {
                        log('üîí PROBLEMA IDENTIFICADO: Regras do Firestore bloqueiam escrita!', 'critical');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro ao verificar regras: ${error.message}`, 'error');
            }
        }

        async function testarPermissoes() {
            log('üîê TESTANDO PERMISS√ïES DETALHADAS...', 'info');
            
            try {
                const db = firebase.firestore();
                
                // Testar diferentes opera√ß√µes
                const testes = [
                    { nome: 'Listar cole√ß√µes', operacao: () => db.collection('cartelas').get() },
                    { nome: 'Criar documento', operacao: () => db.collection('cartelas').add({teste: true}) },
                    { nome: 'Atualizar documento', operacao: async () => {
                        const doc = await db.collection('cartelas').add({teste: true});
                        await doc.update({atualizado: true});
                        return doc;
                    }},
                    { nome: 'Deletar documento', operacao: async () => {
                        const doc = await db.collection('cartelas').add({teste: true});
                        await doc.delete();
                        return doc;
                    }}
                ];
                
                for (const teste of testes) {
                    try {
                        log(`üß™ Testando: ${teste.nome}...`, 'info');
                        await teste.operacao();
                        log(`‚úÖ ${teste.nome}: SUCESSO`, 'success');
                    } catch (error) {
                        log(`‚ùå ${teste.nome}: FALHA - ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro nos testes de permiss√£o: ${error.message}`, 'error');
            }
        }

        async function verificarConfiguracaoFirebase() {
            log('‚öôÔ∏è VERIFICANDO CONFIGURA√á√ÉO DO FIREBASE...', 'info');
            
            try {
                if (typeof firebase !== 'undefined') {
                    const app = firebase.app();
                    const config = app.options;
                    
                    log('üìã Configura√ß√£o atual:', 'info');
                    log(`   Project ID: ${config.projectId}`, 'info');
                    log(`   Auth Domain: ${config.authDomain}`, 'info');
                    log(`   API Key: ${config.apiKey.substring(0, 10)}...`, 'info');
                    
                    // Verificar se est√° usando o projeto correto
                    if (config.projectId !== 'bingoinec') {
                        log('‚ö†Ô∏è ATEN√á√ÉO: Project ID pode estar incorreto!', 'warning');
                    } else {
                        log('‚úÖ Project ID correto: bingoinec', 'success');
                    }
                    
                } else {
                    log('‚ùå Firebase n√£o inicializado!', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error');
            }
        }

        function limparLog() {
            document.getElementById('logArea').innerHTML = '';
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema de investiga√ß√£o carregado!', 'success');
            log('üîç PROBLEMA: Cartelas n√£o est√£o sendo salvas no Firebase', 'critical');
            log('üìã Use os bot√µes acima para diagnosticar o problema', 'info');
        });
    </script>
</body>
</html>
