<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiagnÃ³stico Completo Firebase</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .teste { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .sucesso { background: #d4edda; border-color: #c3e6cb; }
        .erro { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 10px; margin: 10px 0; border: 1px solid #dee2e6; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”¥ DiagnÃ³stico Completo Firebase</h1>
    
    <div id="status-container">
        <div id="status-firebase" class="teste">â³ Verificando Firebase...</div>
        <div id="status-config" class="teste">â³ Verificando configuraÃ§Ã£o...</div>
        <div id="status-conexao" class="teste">â³ Testando conexÃ£o...</div>
        <div id="status-escrita" class="teste">â³ Testando escrita...</div>
        <div id="status-leitura" class="teste">â³ Testando leitura...</div>
    </div>

    <div>
        <button onclick="executarTestes()">ğŸ”„ Executar Todos os Testes</button>
        <button onclick="testarEscrita()">âœï¸ Testar SÃ³ Escrita</button>
        <button onclick="testarLeitura()">ğŸ“– Testar SÃ³ Leitura</button>
        <button onclick="limparLogs()">ğŸ§¹ Limpar Logs</button>
    </div>

    <div id="logs" class="log"></div>

    <!-- Firebase SDK v8 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config-unified.js"></script>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);
            
            console.log(logMessage);
            
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = logs.join('\n');
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function updateStatus(elementId, message, success = null) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            
            if (success === true) {
                element.className = 'teste sucesso';
            } else if (success === false) {
                element.className = 'teste erro';
            } else {
                element.className = 'teste info';
            }
        }

        async function executarTestes() {
            log('ğŸš€ Iniciando diagnÃ³stico completo...');
            
            // Teste 1: Verificar se Firebase estÃ¡ carregado
            log('ğŸ“‹ Teste 1: Verificando carregamento do Firebase...');
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase nÃ£o estÃ¡ definido');
                }
                
                if (typeof firebase.firestore === 'undefined') {
                    throw new Error('Firebase Firestore nÃ£o estÃ¡ disponÃ­vel');
                }
                
                updateStatus('status-firebase', 'âœ… Firebase carregado corretamente', true);
                log('âœ… Firebase SDK carregado com sucesso');
            } catch (error) {
                updateStatus('status-firebase', 'âŒ Firebase nÃ£o carregado: ' + error.message, false);
                log('âŒ Erro no Firebase: ' + error.message);
                return;
            }

            // Teste 2: Verificar configuraÃ§Ã£o
            log('ğŸ“‹ Teste 2: Verificando configuraÃ§Ã£o...');
            try {
                const app = firebase.apps[0];
                if (!app) {
                    throw new Error('Firebase nÃ£o foi inicializado');
                }
                
                const config = app.options;
                log('ğŸ”§ ConfiguraÃ§Ã£o detectada:');
                log(`   ProjectID: ${config.projectId}`);
                log(`   AuthDomain: ${config.authDomain}`);
                log(`   API Key: ${config.apiKey ? 'Configurada' : 'NÃ£o configurada'}`);
                
                updateStatus('status-config', 'âœ… ConfiguraÃ§Ã£o vÃ¡lida', true);
            } catch (error) {
                updateStatus('status-config', 'âŒ ConfiguraÃ§Ã£o invÃ¡lida: ' + error.message, false);
                log('âŒ Erro na configuraÃ§Ã£o: ' + error.message);
                return;
            }

            // Teste 3: Testar conexÃ£o bÃ¡sica
            log('ğŸ“‹ Teste 3: Testando conexÃ£o...');
            try {
                const db = firebase.firestore();
                
                // Tentar fazer uma operaÃ§Ã£o simples de teste
                const testDoc = db.collection('_test').doc('connection');
                await testDoc.set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: 'connection_test'
                });
                
                // Limpar o documento de teste
                await testDoc.delete();
                
                updateStatus('status-conexao', 'âœ… ConexÃ£o estabelecida', true);
                log('âœ… ConexÃ£o com Firestore OK');
            } catch (error) {
                updateStatus('status-conexao', 'âŒ Erro de conexÃ£o: ' + error.message, false);
                log('âŒ Erro de conexÃ£o: ' + error.message);
                log('ğŸ” CÃ³digo do erro: ' + (error.code || 'N/A'));
                
                if (error.code === 'permission-denied') {
                    log('âš ï¸ Erro de permissÃ£o - verifique as regras do Firestore');
                } else if (error.code === 'unavailable') {
                    log('âš ï¸ ServiÃ§o indisponÃ­vel - problema de rede ou Firebase');
                }
            }

            // Teste 4: Testar escrita de dados
            await testarEscrita();

            // Teste 5: Testar leitura de dados
            await testarLeitura();

            log('ğŸ DiagnÃ³stico completo finalizado!');
        }

        async function testarEscrita() {
            log('ğŸ“‹ Teste 4: Testando escrita de dados...');
            try {
                const db = firebase.firestore();
                const testId = 'teste_' + Date.now();
                
                const cartelaTeste = {
                    id: testId,
                    numeros: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],
                    preco: 5.00,
                    vendida: true,
                    comprador: 'Teste DiagnÃ³stico',
                    telefone: '(11) 99999-9999',
                    email: 'teste@diagnostico.com',
                    dataVenda: new Date().toISOString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                log('ğŸ’¾ Tentando salvar cartela de teste...');
                await db.collection('cartelas').doc(testId).set(cartelaTeste);
                
                updateStatus('status-escrita', 'âœ… Escrita realizada com sucesso', true);
                log('âœ… Cartela de teste salva com ID: ' + testId);
                
                // Salvar o ID para o teste de leitura
                window.lastTestId = testId;
                
            } catch (error) {
                updateStatus('status-escrita', 'âŒ Erro na escrita: ' + error.message, false);
                log('âŒ Erro ao escrever: ' + error.message);
                log('ğŸ” CÃ³digo do erro: ' + (error.code || 'N/A'));
            }
        }

        async function testarLeitura() {
            log('ğŸ“‹ Teste 5: Testando leitura de dados...');
            try {
                const db = firebase.firestore();
                
                // Tentar ler a cartela que acabamos de criar
                if (window.lastTestId) {
                    log('ğŸ“– Tentando ler cartela criada no teste anterior...');
                    const doc = await db.collection('cartelas').doc(window.lastTestId).get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        log('âœ… Cartela lida com sucesso');
                        log('ğŸ“„ Dados: ' + JSON.stringify(data, null, 2));
                        
                        // Limpar a cartela de teste
                        await db.collection('cartelas').doc(window.lastTestId).delete();
                        log('ğŸ—‘ï¸ Cartela de teste removida');
                    } else {
                        log('âš ï¸ Cartela de teste nÃ£o encontrada');
                    }
                }
                
                // Tentar listar algumas cartelas existentes
                log('ğŸ“– Tentando listar cartelas existentes...');
                const snapshot = await db.collection('cartelas').limit(5).get();
                
                updateStatus('status-leitura', `âœ… Leitura OK - ${snapshot.size} documentos encontrados`, true);
                log(`âœ… Encontradas ${snapshot.size} cartelas no banco`);
                
                if (snapshot.size > 0) {
                    snapshot.forEach((doc, index) => {
                        log(`ğŸ“„ Cartela ${index + 1}: ${doc.id}`);
                    });
                }
                
            } catch (error) {
                updateStatus('status-leitura', 'âŒ Erro na leitura: ' + error.message, false);
                log('âŒ Erro ao ler: ' + error.message);
                log('ğŸ” CÃ³digo do erro: ' + (error.code || 'N/A'));
            }
        }

        function limparLogs() {
            logs = [];
            document.getElementById('logs').innerHTML = '';
        }

        // Executar teste automÃ¡tico quando a pÃ¡gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ”¥ PÃ¡gina carregada - aguardando Firebase...');
            
            // Aguardar um pouco para Firebase carregar completamente
            setTimeout(() => {
                executarTestes();
            }, 1000);
        });
    </script>
</body>
</html>
