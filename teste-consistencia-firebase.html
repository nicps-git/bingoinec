<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste de Consist√™ncia Firebase - Bingo INEC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        .success { border-left: 5px solid #28a745; }
        .error { border-left: 5px solid #dc3545; }
        .warning { border-left: 5px solid #ffc107; }
        .info { border-left: 5px solid #17a2b8; }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #218838; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log-area {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .cartela-display {
            background: white;
            color: black;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        .numeros-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            margin: 10px 0;
        }
        .numero {
            background: #4CAF50;
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
    
    <!-- Firebase SDK v8 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Consist√™ncia com Firebase</h1>
        <p>Este teste valida se o sistema de reserva tempor√°ria no Firebase est√° funcionando corretamente.</p>
        
        <!-- Status do Firebase -->
        <div id="firebase-status" class="test-section info">
            <h3>üî• Status do Firebase</h3>
            <p><strong>SDK Carregado:</strong> <span id="sdk-status">‚è≥ Verificando...</span></p>
            <p><strong>Conectado:</strong> <span id="connection-status">‚è≥ Verificando...</span></p>
            <p><strong>Firestore:</strong> <span id="firestore-status">‚è≥ Verificando...</span></p>
            <button onclick="verificarFirebase()">üîç Verificar Firebase</button>
        </div>
        
        <!-- Teste de Gera√ß√£o -->
        <div id="teste-geracao" class="test-section">
            <h3>üé≤ Teste 1: Gera√ß√£o com Reserva Tempor√°ria</h3>
            <p>Gera uma cartela e grava reserva tempor√°ria no Firestore</p>
            <button id="btn-gerar" onclick="testarGeracao()" disabled>‚è≥ Aguardando Firebase...</button>
            <div id="resultado-geracao"></div>
        </div>
        
        <!-- Teste de Consist√™ncia -->
        <div id="teste-consistencia" class="test-section">
            <h3>üîç Teste 2: Verifica√ß√£o de Consist√™ncia</h3>
            <p>Verifica se os n√∫meros exibidos s√£o id√™nticos aos salvos no banco</p>
            <button id="btn-consistencia" onclick="testarConsistencia()" disabled>‚ñ∂Ô∏è Executar Teste</button>
            <div id="resultado-consistencia"></div>
        </div>
        
        <!-- Teste de Confirma√ß√£o -->
        <div id="teste-confirmacao" class="test-section">
            <h3>‚úÖ Teste 3: Confirma√ß√£o de Reserva</h3>
            <p>Simula finaliza√ß√£o da compra confirmando a reserva tempor√°ria</p>
            <button id="btn-confirmar" onclick="testarConfirmacao()" disabled>‚ñ∂Ô∏è Executar Teste</button>
            <div id="resultado-confirmacao"></div>
        </div>
        
        <!-- Log de Atividades -->
        <div class="test-section">
            <h3>üìú Log de Atividades</h3>
            <div id="log-area" class="log-area"></div>
            <button onclick="limparLog()">üßπ Limpar Log</button>
        </div>
    </div>

    <!-- Firebase Config e Scripts -->
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
    
    <script>
        let ultimaCartelaTestada = null;
        let firebaseDisponivel = false;
        
        // Fun√ß√£o de log
        function log(mensagem) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${mensagem}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(mensagem);
        }
        
        function limparLog() {
            document.getElementById('log-area').innerHTML = '';
        }
        
        // Verificar Firebase
        async function verificarFirebase() {
            log('üîç Verificando status do Firebase...');
            
            const sdkStatus = document.getElementById('sdk-status');
            const connectionStatus = document.getElementById('connection-status');
            const firestoreStatus = document.getElementById('firestore-status');
            
            // Verificar SDK
            if (typeof firebase === 'undefined') {
                sdkStatus.textContent = '‚ùå SDK n√£o carregado';
                sdkStatus.style.color = '#dc3545';
                log('‚ùå Firebase SDK n√£o encontrado');
                return false;
            } else {
                sdkStatus.textContent = '‚úÖ SDK carregado';
                sdkStatus.style.color = '#28a745';
                log('‚úÖ Firebase SDK carregado');
            }
            
            try {
                // Aguardar inicializa√ß√£o
                let tentativas = 0;
                while (!window.FirebaseDB && tentativas < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    tentativas++;
                }
                
                if (window.FirebaseDB) {
                    connectionStatus.textContent = '‚úÖ Conectado via FirebaseDB';
                    connectionStatus.style.color = '#28a745';
                    log('‚úÖ FirebaseDB dispon√≠vel');
                } else {
                    // Tentar inicializar diretamente
                    if (!firebase.apps.length) {
                        await initializeFirebaseUnified();
                    }
                    
                    connectionStatus.textContent = '‚ö†Ô∏è Conectado direto';
                    connectionStatus.style.color = '#ffc107';
                    log('‚ö†Ô∏è Conectado diretamente ao Firebase');
                }
                
                // Testar Firestore
                const db = firebase.firestore();
                await db.collection('test').limit(1).get();
                
                firestoreStatus.textContent = '‚úÖ Firestore operacional';
                firestoreStatus.style.color = '#28a745';
                log('‚úÖ Firestore testado com sucesso');
                
                firebaseDisponivel = true;
                habilitarBotoes();
                
                return true;
                
            } catch (error) {
                connectionStatus.textContent = '‚ùå Erro de conex√£o';
                connectionStatus.style.color = '#dc3545';
                firestoreStatus.textContent = '‚ùå Firestore com problema';
                firestoreStatus.style.color = '#dc3545';
                
                log(`‚ùå Erro ao verificar Firebase: ${error.message}`);
                return false;
            }
        }
        
        function habilitarBotoes() {
            if (firebaseDisponivel) {
                document.getElementById('btn-gerar').disabled = false;
                document.getElementById('btn-gerar').textContent = 'üé≤ Gerar Cartela com Reserva';
                document.getElementById('btn-consistencia').disabled = false;
                document.getElementById('btn-confirmar').disabled = false;
                log('‚úÖ Bot√µes de teste habilitados');
            }
        }
        
        // Teste 1: Gera√ß√£o com reserva tempor√°ria
        async function testarGeracao() {
            log('üé≤ === INICIANDO TESTE DE GERA√á√ÉO ===');
            
            if (!firebaseDisponivel) {
                log('‚ùå Firebase n√£o dispon√≠vel');
                return;
            }
            
            const resultadoDiv = document.getElementById('resultado-geracao');
            resultadoDiv.innerHTML = '<p>‚è≥ Gerando cartela...</p>';
            
            try {
                // Gerar n√∫meros
                const numeros = [];
                const disponiveis = [];
                for (let i = 1; i <= 75; i++) {
                    disponiveis.push(i);
                }
                for (let i = 0; i < 24; i++) {
                    const indice = Math.floor(Math.random() * disponiveis.length);
                    numeros.push(disponiveis.splice(indice, 1)[0]);
                }
                numeros.sort((a, b) => a - b);
                
                const cartela = {
                    id: `TEST-${Date.now()}`,
                    numeros: numeros,
                    preco: 5.00,
                    status: 'preview'
                };
                
                log(`üìã Cartela gerada: ${cartela.id}`);
                log(`üî¢ N√∫meros: [${numeros.join(', ')}]`);
                
                // Gravar reserva tempor√°ria
                const db = firebase.firestore();
                const reservaTemporaria = {
                    id: cartela.id,
                    numeros: cartela.numeros,
                    preco: cartela.preco,
                    status: 'reservada-temporariamente',
                    dataReserva: firebase.firestore.FieldValue.serverTimestamp(),
                    expiracaoReserva: new Date(Date.now() + 30 * 60 * 1000),
                    sessao: `teste-${Date.now()}`,
                    teste: true
                };
                
                await db.collection('cartelas').doc(cartela.id).set(reservaTemporaria);
                log(`‚úÖ Reserva tempor√°ria gravada: ${cartela.id}`);
                
                // Verificar se foi salvo corretamente
                const doc = await db.collection('cartelas').doc(cartela.id).get();
                if (doc.exists) {
                    const dadosSalvos = doc.data();
                    log(`‚úÖ Dados verificados no banco`);
                    log(`üî¢ N√∫meros salvos: [${dadosSalvos.numeros.join(', ')}]`);
                    
                    // Verificar consist√™ncia
                    const numerosIguais = JSON.stringify(numeros.sort()) === JSON.stringify(dadosSalvos.numeros.sort());
                    
                    if (numerosIguais) {
                        log('‚úÖ CONSIST√äNCIA CONFIRMADA: N√∫meros id√™nticos!');
                        resultadoDiv.innerHTML = `
                            <div class="success">
                                <h4>‚úÖ Sucesso!</h4>
                                <p><strong>ID:</strong> ${cartela.id}</p>
                                <p><strong>Status:</strong> Reserva tempor√°ria criada</p>
                                <div class="cartela-display">
                                    <h5>üìã N√∫meros da Cartela (${numeros.length})</h5>
                                    <div class="numeros-grid">
                                        ${numeros.map(n => `<div class="numero">${n}</div>`).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        ultimaCartelaTestada = cartela;
                        
                    } else {
                        log('‚ùå INCONSIST√äNCIA DETECTADA: N√∫meros diferentes!');
                        resultadoDiv.innerHTML = `<div class="error"><h4>‚ùå Erro de Consist√™ncia</h4><p>Os n√∫meros salvos s√£o diferentes dos gerados.</p></div>`;
                    }
                } else {
                    log('‚ùå Documento n√£o encontrado no banco');
                    resultadoDiv.innerHTML = `<div class="error"><h4>‚ùå Erro</h4><p>Reserva n√£o foi salva no banco.</p></div>`;
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste de gera√ß√£o: ${error.message}`);
                resultadoDiv.innerHTML = `<div class="error"><h4>‚ùå Erro</h4><p>${error.message}</p></div>`;
            }
        }
        
        // Teste 2: Verifica√ß√£o de consist√™ncia
        async function testarConsistencia() {
            log('üîç === INICIANDO TESTE DE CONSIST√äNCIA ===');
            
            if (!ultimaCartelaTestada) {
                log('‚ùå Nenhuma cartela testada ainda');
                document.getElementById('resultado-consistencia').innerHTML = 
                    `<div class="warning"><h4>‚ö†Ô∏è Aviso</h4><p>Execute primeiro o teste de gera√ß√£o.</p></div>`;
                return;
            }
            
            const resultadoDiv = document.getElementById('resultado-consistencia');
            resultadoDiv.innerHTML = '<p>‚è≥ Verificando consist√™ncia...</p>';
            
            try {
                const db = firebase.firestore();
                const doc = await db.collection('cartelas').doc(ultimaCartelaTestada.id).get();
                
                if (!doc.exists) {
                    log('‚ùå Cartela n√£o encontrada no banco');
                    resultadoDiv.innerHTML = `<div class="error"><h4>‚ùå Erro</h4><p>Cartela n√£o encontrada no banco.</p></div>`;
                    return;
                }
                
                const dadosBanco = doc.data();
                const numerosLocal = ultimaCartelaTestada.numeros.sort((a, b) => a - b);
                const numerosBanco = dadosBanco.numeros.sort((a, b) => a - b);
                
                log(`üî¢ N√∫meros local: [${numerosLocal.join(', ')}]`);
                log(`üî¢ N√∫meros banco: [${numerosBanco.join(', ')}]`);
                
                const consistente = JSON.stringify(numerosLocal) === JSON.stringify(numerosBanco);
                
                if (consistente) {
                    log('‚úÖ CONSIST√äNCIA CONFIRMADA!');
                    resultadoDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Consist√™ncia Confirmada</h4>
                            <p>Os n√∫meros locais e do banco s√£o id√™nticos.</p>
                            <p><strong>Quantidade:</strong> ${numerosLocal.length} n√∫meros</p>
                            <p><strong>Identifica√ß√£o:</strong> ${JSON.stringify(numerosLocal) === JSON.stringify(numerosBanco) ? 'IGUAIS' : 'DIFERENTES'}</p>
                        </div>
                    `;
                } else {
                    log('‚ùå INCONSIST√äNCIA DETECTADA!');
                    resultadoDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Inconsist√™ncia Detectada</h4>
                            <p><strong>Local:</strong> [${numerosLocal.join(', ')}]</p>
                            <p><strong>Banco:</strong> [${numerosBanco.join(', ')}]</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste de consist√™ncia: ${error.message}`);
                resultadoDiv.innerHTML = `<div class="error"><h4>‚ùå Erro</h4><p>${error.message}</p></div>`;
            }
        }
        
        // Teste 3: Confirma√ß√£o de reserva
        async function testarConfirmacao() {
            log('‚úÖ === INICIANDO TESTE DE CONFIRMA√á√ÉO ===');
            
            if (!ultimaCartelaTestada) {
                log('‚ùå Nenhuma cartela testada ainda');
                document.getElementById('resultado-confirmacao').innerHTML = 
                    `<div class="warning"><h4>‚ö†Ô∏è Aviso</h4><p>Execute primeiro o teste de gera√ß√£o.</p></div>`;
                return;
            }
            
            const resultadoDiv = document.getElementById('resultado-confirmacao');
            resultadoDiv.innerHTML = '<p>‚è≥ Confirmando reserva...</p>';
            
            try {
                const db = firebase.firestore();
                const cartelaId = ultimaCartelaTestada.id;
                
                // Buscar reserva
                const doc = await db.collection('cartelas').doc(cartelaId).get();
                if (!doc.exists) {
                    throw new Error('Reserva n√£o encontrada');
                }
                
                const reservaData = doc.data();
                log(`üìã Reserva encontrada: ${cartelaId}`);
                
                // Confirmar venda
                const cartelaVendida = {
                    ...reservaData,
                    status: 'vendida',
                    comprador: {
                        nome: 'Teste Autom√°tico',
                        telefone: '(11) 99999-9999'
                    },
                    nome: 'Teste Autom√°tico',
                    telefone: '(11) 99999-9999',
                    dataVenda: firebase.firestore.FieldValue.serverTimestamp(),
                    dataCompra: new Date(),
                    timestamp: Date.now(),
                    numerosOriginais: reservaData.numeros,
                    numerosConfirmados: reservaData.numeros
                };
                
                await db.collection('cartelas').doc(cartelaId).set(cartelaVendida);
                log(`‚úÖ Reserva confirmada como venda: ${cartelaId}`);
                
                // Verificar consist√™ncia final
                const docFinal = await db.collection('cartelas').doc(cartelaId).get();
                const dadosFinais = docFinal.data();
                
                const numerosOriginais = ultimaCartelaTestada.numeros.sort((a, b) => a - b);
                const numerosFinais = dadosFinais.numerosConfirmados.sort((a, b) => a - b);
                
                const consistenciaFinal = JSON.stringify(numerosOriginais) === JSON.stringify(numerosFinais);
                
                if (consistenciaFinal) {
                    log('‚úÖ CONSIST√äNCIA FINAL CONFIRMADA!');
                    resultadoDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Reserva Confirmada com Sucesso</h4>
                            <p><strong>Status:</strong> ${dadosFinais.status}</p>
                            <p><strong>Comprador:</strong> ${dadosFinais.nome}</p>
                            <p><strong>Consist√™ncia:</strong> ‚úÖ N√∫meros preservados</p>
                            <p><strong>ID Final:</strong> ${cartelaId}</p>
                        </div>
                    `;
                } else {
                    log('‚ùå CONSIST√äNCIA FINAL FALHADA!');
                    resultadoDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Erro na Confirma√ß√£o</h4>
                            <p>Os n√∫meros n√£o foram preservados durante a confirma√ß√£o.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste de confirma√ß√£o: ${error.message}`);
                resultadoDiv.innerHTML = `<div class="error"><h4>‚ùå Erro</h4><p>${error.message}</p></div>`;
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            log('üöÄ Iniciando testes de consist√™ncia Firebase...');
            
            // Aguardar Firebase carregar
            let tentativas = 0;
            while (typeof firebase === 'undefined' && tentativas < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                tentativas++;
            }
            
            if (typeof firebase !== 'undefined') {
                log('‚úÖ Firebase SDK detectado');
                setTimeout(verificarFirebase, 1000);
            } else {
                log('‚ùå Firebase SDK n√£o carregou');
            }
        });
    </script>
</body>
</html>
