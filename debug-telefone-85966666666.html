<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Debug Telefone 85966666666</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #ff9800, #ffc107);
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .btn-danger {
            background: #f44336;
        }
        .btn-danger:hover {
            background: #da190b;
        }
        .resultado {
            background: #e8f5e8;
            border-left: 5px solid #4CAF50;
            padding: 15px;
            margin: 15px 0;
        }
        .erro {
            background: #ffe8e8;
            border-left: 5px solid #f44336;
            padding: 15px;
            margin: 15px 0;
        }
        .cartela {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .stat {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Debug Específico: Telefone 85966666666</h1>
        <p>Vamos investigar por que o login não está funcionando para este telefone específico.</p>
    </div>

    <div class="container">
        <h2>🚀 Testes Automáticos</h2>
        <button onclick="executarTodosOsTestes()">🔄 Executar Todos os Testes</button>
        <button onclick="limparLog()">🗑️ Limpar Log</button>
        
        <h3>Testes Individuais:</h3>
        <button onclick="listarTodasCartelas()">📋 1. Listar Todas as Cartelas</button>
        <button onclick="buscarTelefoneExato()">📞 2. Busca Exata por Telefone</button>
        <button onclick="buscarTelefoneVariacoes()">🔍 3. Buscar Variações</button>
        <button onclick="simularLoginMinhasCartelas()">🔐 4. Simular Login</button>
        <button onclick="corrigirCartelasProblematicas()">🔧 5. Corrigir Cartelas</button>
        
        <div id="resultado"></div>
    </div>

    <div class="container">
        <h2>📊 Log de Debug</h2>
        <div id="log" class="log">Aguardando testes...</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>

    <script>
        const telefoneAlvo = '85966666666';
        const logElement = document.getElementById('log');
        const resultadoElement = document.getElementById('resultado');

        function log(msg) {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${msg}`;
            logElement.textContent += logLine + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logLine);
        }

        function limparLog() {
            logElement.textContent = 'Log limpo...\n';
        }

        function mostrarResultado(conteudo) {
            resultadoElement.innerHTML = conteudo;
        }

        function normalizarTelefone(telefone) {
            return telefone ? telefone.replace(/\D/g, '') : '';
        }

        async function executarTodosOsTestes() {
            log('🚀 INICIANDO BATERIA COMPLETA DE TESTES');
            log('='.repeat(50));
            
            try {
                await listarTodasCartelas();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await buscarTelefoneExato();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await buscarTelefoneVariacoes();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await simularLoginMinhasCartelas();
                
                log('='.repeat(50));
                log('🎯 BATERIA DE TESTES CONCLUÍDA');
                
            } catch (error) {
                log(`❌ ERRO NA BATERIA DE TESTES: ${error.message}`);
            }
        }

        async function listarTodasCartelas() {
            log('📋 TESTE 1: Listando todas as cartelas no banco...');
            
            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService não carregado');
                }

                const cartelas = await window.firebaseService.carregarCartelas();
                log(`📊 Total de cartelas no banco: ${cartelas.length}`);
                
                const vendidas = cartelas.filter(c => c.vendida);
                log(`💰 Cartelas vendidas: ${vendidas.length}`);
                
                // Procurar cartelas com telefone similar
                const telefonesSimilares = cartelas.filter(c => {
                    const tel = c.telefone ? c.telefone.toString() : '';
                    return tel.includes('8596') || tel.includes('66666');
                });
                
                log(`🔍 Cartelas com números similares a "85966666666": ${telefonesSimilares.length}`);
                
                let resultado = `<h3>📊 Estatísticas do Banco:</h3>`;
                resultado += `<div class="stat">Total: ${cartelas.length}</div>`;
                resultado += `<div class="stat">Vendidas: ${vendidas.length}</div>`;
                resultado += `<div class="stat">Similares: ${telefonesSimilares.length}</div>`;
                
                if (telefonesSimilares.length > 0) {
                    resultado += `<h4>🔍 Cartelas com números similares:</h4>`;
                    telefonesSimilares.forEach((cartela, index) => {
                        resultado += `
                            <div class="cartela">
                                <strong>Cartela ${index + 1}:</strong><br>
                                <strong>ID:</strong> ${cartela.id}<br>
                                <strong>Comprador:</strong> "${cartela.comprador || 'N/A'}"<br>
                                <strong>Telefone:</strong> "${cartela.telefone || 'N/A'}"<br>
                                <strong>Email:</strong> "${cartela.email || 'N/A'}"<br>
                                <strong>Vendida:</strong> ${cartela.vendida ? 'Sim' : 'Não'}<br>
                                <strong>Data:</strong> ${cartela.dataVenda ? new Date(cartela.dataVenda).toLocaleString() : 'N/A'}
                            </div>
                        `;
                        
                        log(`📱 Cartela encontrada: ID=${cartela.id}, Tel="${cartela.telefone}", Comprador="${cartela.comprador}"`);
                    });
                }
                
                mostrarResultado(resultado);
                
            } catch (error) {
                log(`❌ Erro no teste 1: ${error.message}`);
                mostrarResultado(`<div class="erro">❌ Erro: ${error.message}</div>`);
            }
        }

        async function buscarTelefoneExato() {
            log('📞 TESTE 2: Busca exata pelo telefone 85966666666...');
            
            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService não carregado');
                }

                const telefoneNormalizado = normalizarTelefone(telefoneAlvo);
                log(`📱 Telefone original: ${telefoneAlvo}`);
                log(`📱 Telefone normalizado: ${telefoneNormalizado}`);
                
                const cartelas = await window.firebaseService.carregarCartelasPorComprador(telefoneNormalizado, null);
                
                log(`📦 Resultado da busca: ${cartelas.length} cartela(s)`);
                
                if (cartelas.length > 0) {
                    log('✅ SUCESSO: Cartelas encontradas!');
                    cartelas.forEach((cartela, index) => {
                        log(`🎫 Cartela ${index + 1}: ID=${cartela.id}, Comprador="${cartela.comprador}"`);
                    });
                } else {
                    log('❌ FALHA: Nenhuma cartela encontrada com busca exata');
                }
                
            } catch (error) {
                log(`❌ Erro no teste 2: ${error.message}`);
            }
        }

        async function buscarTelefoneVariacoes() {
            log('🔍 TESTE 3: Testando diferentes variações do telefone...');
            
            const variacoes = [
                '85966666666',
                '8596666666',  // sem último dígito
                '859666666666', // com dígito extra
                '5966666666',   // sem 8
                '085966666666', // com zero
                '+5585966666666' // com código país
            ];
            
            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService não carregado');
                }

                for (const variacao of variacoes) {
                    const normalizado = normalizarTelefone(variacao);
                    log(`🔍 Testando: "${variacao}" -> normalizado: "${normalizado}"`);
                    
                    const cartelas = await window.firebaseService.carregarCartelasPorComprador(normalizado, null);
                    
                    if (cartelas.length > 0) {
                        log(`✅ ENCONTROU ${cartelas.length} cartela(s) com "${variacao}"`);
                        cartelas.forEach(cartela => {
                            log(`   🎫 ${cartela.id} - ${cartela.comprador} - ${cartela.telefone}`);
                        });
                    } else {
                        log(`❌ Nada encontrado com "${variacao}"`);
                    }
                }
                
            } catch (error) {
                log(`❌ Erro no teste 3: ${error.message}`);
            }
        }

        async function simularLoginMinhasCartelas() {
            log('🔐 TESTE 4: Simulando exatamente o processo do "Minhas Cartelas"...');
            
            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService não carregado');
                }

                const telefoneInput = telefoneAlvo;
                const emailInput = '';
                
                log(`📝 Dados do formulário simulado:`);
                log(`   📱 Telefone: "${telefoneInput}"`);
                log(`   📧 Email: "${emailInput}"`);
                
                if (!telefoneInput && !emailInput) {
                    log('❌ Validação falhou: nenhum dado informado');
                    return;
                }
                
                // Normalizar telefone como no sistema real
                const telefoneNormalizado = telefoneInput ? normalizarTelefone(telefoneInput) : null;
                log(`📱 Telefone normalizado: "${telefoneNormalizado}"`);
                
                // Buscar cartelas exatamente como no sistema
                log('🔍 Chamando firebaseService.carregarCartelasPorComprador...');
                const cartelas = await window.firebaseService.carregarCartelasPorComprador(telefoneNormalizado, emailInput || null);
                
                log(`📦 Resultado: ${cartelas.length} cartela(s) encontrada(s)`);
                
                if (cartelas.length === 0) {
                    log('❌ FALHA: Login falharia - nenhuma cartela encontrada');
                    log('🔍 Investigando possíveis causas...');
                    
                    // Investigar
                    const todasCartelas = await window.firebaseService.carregarCartelas();
                    const cartelasVendidas = todasCartelas.filter(c => c.vendida);
                    
                    log(`📊 Debug: ${cartelasVendidas.length} cartelas vendidas no total`);
                    
                    // Procurar cartelas que poderiam corresponder
                    const possiveis = cartelasVendidas.filter(c => {
                        const telCartela = c.telefone ? c.telefone.toString().replace(/\D/g, '') : '';
                        return telCartela.includes('8596') || telCartela.includes('6666');
                    });
                    
                    if (possiveis.length > 0) {
                        log(`🔍 Encontradas ${possiveis.length} cartela(s) com números similares:`);
                        possiveis.forEach(cartela => {
                            log(`   📱 Tel: "${cartela.telefone}" | Comp: "${cartela.comprador}" | ID: ${cartela.id}`);
                        });
                    }
                    
                } else {
                    log('✅ SUCESSO: Login funcionaria!');
                    cartelas.forEach((cartela, index) => {
                        log(`🎫 Cartela ${index + 1}: ${cartela.comprador} (${cartela.telefone})`);
                    });
                }
                
            } catch (error) {
                log(`❌ Erro no teste 4: ${error.message}`);
            }
        }

        async function corrigirCartelasProblematicas() {
            log('🔧 TESTE 5: Procurando e corrigindo cartelas problemáticas...');
            
            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService não carregado');
                }

                const cartelas = await window.firebaseService.carregarCartelas();
                const cartelasVendidas = cartelas.filter(c => c.vendida);
                
                // Procurar cartelas com problemas
                const problematicas = cartelasVendidas.filter(c => {
                    const temTelSimilar = c.telefone && c.telefone.toString().includes('8596');
                    const compradorProblema = !c.comprador || c.comprador === 'N/A' || c.comprador.trim() === '';
                    return temTelSimilar || compradorProblema;
                });
                
                log(`🔍 Encontradas ${problematicas.length} cartela(s) problemática(s)`);
                
                if (problematicas.length > 0) {
                    let resultado = '<h3>🔧 Cartelas Problemáticas Encontradas:</h3>';
                    
                    for (let i = 0; i < problematicas.length; i++) {
                        const cartela = problematicas[i];
                        log(`🔧 Cartela ${i + 1}: ID=${cartela.id}, Tel="${cartela.telefone}", Comp="${cartela.comprador}"`);
                        
                        resultado += `
                            <div class="cartela">
                                <strong>Cartela Problemática ${i + 1}:</strong><br>
                                <strong>ID:</strong> ${cartela.id}<br>
                                <strong>Comprador:</strong> "${cartela.comprador || 'N/A'}"<br>
                                <strong>Telefone:</strong> "${cartela.telefone || 'N/A'}"<br>
                                <strong>Problema:</strong> ${!cartela.comprador || cartela.comprador === 'N/A' ? 'Comprador vazio/N/A' : 'Telefone similar'}
                                <br><br>
                                <button onclick="corrigirCartela('${cartela.id}')" class="btn-danger">🔧 Corrigir Esta Cartela</button>
                            </div>
                        `;
                    }
                    
                    mostrarResultado(resultado);
                }
                
            } catch (error) {
                log(`❌ Erro no teste 5: ${error.message}`);
            }
        }

        async function corrigirCartela(cartelaId) {
            const novoNome = prompt('Digite o nome correto do comprador:');
            const novoTelefone = prompt('Digite o telefone correto (apenas números):', '85966666666');
            
            if (!novoNome || !novoTelefone) {
                alert('Nome e telefone são obrigatórios!');
                return;
            }
            
            try {
                log(`🔧 Corrigindo cartela ${cartelaId}...`);
                
                const cartelas = await window.firebaseService.carregarCartelas();
                const cartela = cartelas.find(c => c.id === cartelaId);
                
                if (!cartela) {
                    throw new Error('Cartela não encontrada');
                }
                
                const cartelaCorrigida = {
                    ...cartela,
                    comprador: novoNome.trim(),
                    telefone: normalizarTelefone(novoTelefone),
                    email: cartela.email || null,
                    vendida: true,
                    dataCorrecao: new Date().toISOString()
                };
                
                await window.firebaseService.salvarCartela(cartelaCorrigida);
                
                log(`✅ Cartela ${cartelaId} corrigida com sucesso!`);
                log(`👤 Nome: ${cartelaCorrigida.comprador}`);
                log(`📱 Telefone: ${cartelaCorrigida.telefone}`);
                
                alert('✅ Cartela corrigida! Agora teste o login novamente.');
                
                // Atualizar lista
                setTimeout(() => {
                    corrigirCartelasProblematicas();
                }, 1000);
                
            } catch (error) {
                log(`❌ Erro ao corrigir cartela: ${error.message}`);
                alert(`❌ Erro: ${error.message}`);
            }
        }

        // Tornar função global
        window.corrigirCartela = corrigirCartela;

        // Auto-inicializar
        document.addEventListener('DOMContentLoaded', () => {
            log('🔍 Debug específico carregado para telefone: ' + telefoneAlvo);
            
            // Aguardar Firebase
            const checkFirebase = setInterval(() => {
                if (typeof window.firebaseService !== 'undefined') {
                    clearInterval(checkFirebase);
                    log('✅ Firebase pronto! Execute os testes ou use o botão de teste automático.');
                }
            }, 500);
        });
    </script>
</body>
</html>
