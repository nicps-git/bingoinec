<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corre√ß√£o Final - Sistema de Grava√ß√£o</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .log { height: 400px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; }
        .step { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß CORRE√á√ÉO FINAL - Sistema de Grava√ß√£o Firebase</h1>
        
        <div class="section success">
            <h3>‚úÖ SOLU√á√ÉO IMPLEMENTADA</h3>
            <p>Cria√ß√£o de sistema de grava√ß√£o robusto com fallbacks e valida√ß√£o</p>
        </div>

        <div class="step">
            <h4>TESTE COMPLETO DO SISTEMA</h4>
            <button onclick="testarSistemaCompleto()">üöÄ Testar Tudo</button>
            <button onclick="simularCompraCompleta()">üõí Simular Compra</button>
            <button onclick="verificarDados()">üìä Verificar Dados</button>
        </div>

        <div class="section">
            <h3>üìä Resultados</h3>
            <div id="resultados"></div>
        </div>

        <div class="section">
            <h3>üìã Log</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAQcCJmtqO3PNNxn7_e_LhjRGa5Wd1hxZ4",
            authDomain: "rifatomaz-7a6e5.firebaseapp.com",
            projectId: "rifatomaz-7a6e5",
            storageBucket: "rifatomaz-7a6e5.appspot.com",
            messagingSenderId: "265430386154",
            appId: "1:265430386154:web:c4c12e45c5db21da5d0e3d"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Sistema de grava√ß√£o ROBUSTO
        class SistemaGravacaoRobusto {
            constructor() {
                this.db = db;
                this.tentativasMaximas = 3;
                this.delayTentativa = 1000;
            }

            async salvarCartela(cartela) {
                console.log('üíæ Iniciando grava√ß√£o robusta...');
                
                for (let tentativa = 1; tentativa <= this.tentativasMaximas; tentativa++) {
                    try {
                        console.log(`üîÑ Tentativa ${tentativa}/${this.tentativasMaximas}`);
                        
                        const cartelaCompleta = {
                            ...cartela,
                            id: cartela.id || `cartela_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            dataGravacao: firebase.firestore.FieldValue.serverTimestamp(),
                            tentativa: tentativa,
                            versao: "robusta"
                        };

                        // Gravar usando .set() para garantir o ID
                        await this.db.collection('cartelas').doc(cartelaCompleta.id).set(cartelaCompleta);
                        console.log(`‚úÖ Cartela gravada com sucesso: ${cartelaCompleta.id}`);
                        
                        // Verifica√ß√£o imediata
                        const verificacao = await this.db.collection('cartelas').doc(cartelaCompleta.id).get();
                        if (verificacao.exists) {
                            console.log('‚úÖ Verifica√ß√£o: Cartela confirmada no banco');
                            return cartelaCompleta.id;
                        } else {
                            throw new Error('Cartela n√£o encontrada ap√≥s grava√ß√£o');
                        }
                        
                    } catch (error) {
                        console.error(`‚ùå Tentativa ${tentativa} falhou:`, error.message);
                        
                        if (tentativa === this.tentativasMaximas) {
                            throw new Error(`Falha ap√≥s ${this.tentativasMaximas} tentativas: ${error.message}`);
                        }
                        
                        // Aguardar antes da pr√≥xima tentativa
                        await new Promise(resolve => setTimeout(resolve, this.delayTentativa * tentativa));
                    }
                }
            }

            async buscarCartelasPorTelefone(telefone) {
                console.log(`üîç Buscando cartelas para telefone: ${telefone}`);
                
                // Normalizar telefone
                const telefoneNormalizado = telefone.replace(/\D/g, '');
                
                const varia√ß√µes = [
                    telefoneNormalizado,
                    telefone,
                    `+55${telefoneNormalizado}`,
                    telefoneNormalizado.startsWith('55') ? telefoneNormalizado.substring(2) : telefoneNormalizado
                ];

                console.log('üì± Varia√ß√µes de busca:', varia√ß√µes);

                for (const variacao of varia√ß√µes) {
                    try {
                        const snapshot = await this.db.collection('cartelas')
                            .where('telefone', '==', variacao)
                            .get();
                        
                        if (snapshot.size > 0) {
                            console.log(`‚úÖ Encontradas ${snapshot.size} cartelas para ${variacao}`);
                            const cartelas = [];
                            snapshot.forEach(doc => {
                                cartelas.push({ id: doc.id, ...doc.data() });
                            });
                            return cartelas;
                        }
                    } catch (error) {
                        console.error(`‚ùå Erro na busca por ${variacao}:`, error.message);
                    }
                }

                console.log('‚ùå Nenhuma cartela encontrada');
                return [];
            }
        }

        const sistemaGravacao = new SistemaGravacaoRobusto();

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function exibirResultado(titulo, conteudo, tipo = 'info') {
            const resultadosDiv = document.getElementById('resultados');
            const classe = tipo === 'error' ? 'error' : tipo === 'success' ? 'success' : 'section';
            resultadosDiv.innerHTML += `
                <div class="${classe}">
                    <h4>${titulo}</h4>
                    <pre>${JSON.stringify(conteudo, null, 2)}</pre>
                </div>
            `;
        }

        async function testarSistemaCompleto() {
            log("üöÄ Testando sistema completo...");
            
            try {
                // 1. Teste de grava√ß√£o
                const cartela1 = {
                    telefone: "85966666666",
                    nome: "Teste Sistema",
                    numeros: [[1,2,3,4,5], [16,17,18,19,20], [31,'FREE',33,34,35], [46,47,48,49,50], [61,62,63,64,65]],
                    preco: 5.00,
                    vendida: true
                };

                log("üíæ Testando grava√ß√£o...");
                const id1 = await sistemaGravacao.salvarCartela(cartela1);
                log(`‚úÖ Cartela 1 gravada: ${id1}`);

                // 2. Teste de busca
                log("üîç Testando busca...");
                const cartelas = await sistemaGravacao.buscarCartelasPorTelefone("85966666666");
                log(`üìä Cartelas encontradas: ${cartelas.length}`);

                // 3. Gravar mais uma cartela
                const cartela2 = {
                    telefone: "85966666666",
                    nome: "Teste Sistema 2",
                    numeros: [[6,7,8,9,10], [21,22,23,24,25], [36,37,'FREE',38,39], [51,52,53,54,55], [66,67,68,69,70]],
                    preco: 5.00,
                    vendida: true
                };

                const id2 = await sistemaGravacao.salvarCartela(cartela2);
                log(`‚úÖ Cartela 2 gravada: ${id2}`);

                // 4. Buscar novamente
                const cartelasAtualizadas = await sistemaGravacao.buscarCartelasPorTelefone("85966666666");
                log(`üìä Cartelas atualizadas: ${cartelasAtualizadas.length}`);

                exibirResultado("Teste Sistema Completo", {
                    cartela1_id: id1,
                    cartela2_id: id2,
                    busca_inicial: cartelas.length,
                    busca_final: cartelasAtualizadas.length,
                    status: "SUCESSO"
                }, 'success');

                log("üéâ SISTEMA FUNCIONANDO CORRETAMENTE!");

            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`);
                exibirResultado("Erro Sistema", { erro: error.message }, 'error');
            }
        }

        async function simularCompraCompleta() {
            log("üõí Simulando compra completa...");
            
            try {
                // Simular m√∫ltiplas cartelas como uma compra real
                const comprador = {
                    nome: "Jo√£o da Silva",
                    telefone: "85987654321",
                    email: "joao@email.com"
                };

                const cartelas = [
                    {
                        numeros: [[1,2,3,4,5], [16,17,18,19,20], [31,'FREE',33,34,35], [46,47,48,49,50], [61,62,63,64,65]],
                        preco: 5.00
                    },
                    {
                        numeros: [[6,7,8,9,10], [21,22,23,24,25], [36,37,'FREE',38,39], [51,52,53,54,55], [66,67,68,69,70]],
                        preco: 5.00
                    },
                    {
                        numeros: [[11,12,13,14,15], [26,27,28,29,30], [41,42,'FREE',43,44], [56,57,58,59,60], [71,72,73,74,75]],
                        preco: 5.00
                    }
                ];

                log(`üé´ Processando compra de ${cartelas.length} cartelas para ${comprador.nome}`);

                const idsCartelas = [];
                for (let i = 0; i < cartelas.length; i++) {
                    const cartelaCompleta = {
                        ...cartelas[i],
                        vendida: true,
                        comprador: comprador.nome,
                        telefone: comprador.telefone.replace(/\D/g, ''),
                        email: comprador.email,
                        dataVenda: new Date().toISOString(),
                        numeroCartela: i + 1,
                        totalCompra: cartelas.length
                    };

                    const id = await sistemaGravacao.salvarCartela(cartelaCompleta);
                    idsCartelas.push(id);
                    log(`‚úÖ Cartela ${i + 1}/${cartelas.length} salva: ${id}`);
                }

                // Verificar busca
                log("üîç Verificando busca ap√≥s compra...");
                const cartelasEncontradas = await sistemaGravacao.buscarCartelasPorTelefone(comprador.telefone);
                
                exibirResultado("Simula√ß√£o Compra Completa", {
                    comprador: comprador,
                    cartelas_compradas: cartelas.length,
                    cartelas_gravadas: idsCartelas.length,
                    cartelas_encontradas: cartelasEncontradas.length,
                    ids: idsCartelas,
                    status: cartelasEncontradas.length >= cartelas.length ? "SUCESSO" : "PARCIAL"
                }, cartelasEncontradas.length >= cartelas.length ? 'success' : 'warning');

                log("üéâ COMPRA SIMULADA COM SUCESSO!");

            } catch (error) {
                log(`‚ùå Erro na simula√ß√£o: ${error.message}`);
                exibirResultado("Erro Simula√ß√£o", { erro: error.message }, 'error');
            }
        }

        async function verificarDados() {
            log("üìä Verificando dados no Firebase...");
            
            try {
                const snapshot = await db.collection('cartelas').get();
                log(`üìã Total de cartelas no banco: ${snapshot.size}`);

                const cartelas = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    cartelas.push({
                        id: doc.id,
                        telefone: data.telefone,
                        comprador: data.comprador,
                        dataVenda: data.dataVenda,
                        preco: data.preco
                    });
                });

                // Agrupar por telefone
                const porTelefone = {};
                cartelas.forEach(cartela => {
                    const tel = cartela.telefone || 'sem-telefone';
                    if (!porTelefone[tel]) porTelefone[tel] = [];
                    porTelefone[tel].push(cartela);
                });

                exibirResultado("Dados Firebase", {
                    total_cartelas: snapshot.size,
                    telefones_unicos: Object.keys(porTelefone).length,
                    cartelas_por_telefone: porTelefone,
                    ultimas_5_cartelas: cartelas.slice(-5)
                });

                log("üìä Verifica√ß√£o conclu√≠da!");

            } catch (error) {
                log(`‚ùå Erro na verifica√ß√£o: ${error.message}`);
                exibirResultado("Erro Verifica√ß√£o", { erro: error.message }, 'error');
            }
        }

        // Auto-inicializar
        window.addEventListener('load', () => {
            log("üöÄ Sistema de Corre√ß√£o Final iniciado");
            log("‚úÖ Sistema robusto de grava√ß√£o carregado");
            log("üìã Use os bot√µes para testar o sistema");
        });
    </script>
</body>
</html>
