<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 Teste de Compra - Bingo INEC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #ff9800, #ffc107);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .section {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .btn-test {
            background: #ff9800;
        }
        .btn-test:hover {
            background: #e68900;
        }
        .btn-danger {
            background: #f44336;
        }
        .btn-danger:hover {
            background: #da190b;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .resultado {
            background: #e8f5e8;
            border-left: 5px solid #4CAF50;
            padding: 15px;
            margin: 15px 0;
        }
        .erro {
            background: #ffe8e8;
            border-left: 5px solid #f44336;
            padding: 15px;
            margin: 15px 0;
        }
        .info {
            background: #e8f4fd;
            border-left: 5px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Teste de Compra de Cartelas - Bingo INEC</h1>
        <p>Esta página testa o processo completo de compra e gravação de cartelas.</p>
    </div>

    <div class="container">
        <div class="section">
            <h2>🔧 Teste Rápido de Compra</h2>
            <div class="form-group">
                <label for="teste-nome">👤 Nome do Comprador:</label>
                <input type="text" id="teste-nome" value="João Teste" placeholder="Nome completo">
            </div>
            <div class="form-group">
                <label for="teste-telefone">📱 Telefone:</label>
                <input type="tel" id="teste-telefone" value="11987654321" placeholder="11987654321">
            </div>
            <div class="form-group">
                <label for="teste-email">📧 Email (opcional):</label>
                <input type="email" id="teste-email" value="joao@teste.com" placeholder="joao@teste.com">
            </div>
            <div class="form-group">
                <label for="teste-quantidade">🎫 Quantidade de Cartelas:</label>
                <input type="number" id="teste-quantidade" value="2" min="1" max="10">
            </div>
            <button onclick="testarCompra()" class="btn-test">🛒 Simular Compra</button>
            <div id="compra-result"></div>
        </div>

        <div class="section">
            <h2>🔍 Verificar Cartelas no Banco</h2>
            <div class="stats" id="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="total-cartelas">-</div>
                    <div>Total de Cartelas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="cartelas-vendidas">-</div>
                    <div>Cartelas Vendidas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="compradores-unicos">-</div>
                    <div>Compradores Únicos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-arrecadado">-</div>
                    <div>Total Arrecadado</div>
                </div>
            </div>
            <button onclick="verificarCartelas()" class="btn-test">📊 Atualizar Estatísticas</button>
            <button onclick="listarUltimas()" class="btn-test">📋 Últimas 10 Compras</button>
            <div id="verificacao-result"></div>
        </div>

        <div class="section">
            <h2>🔍 Buscar Cartelas por Comprador</h2>
            <div class="form-group">
                <label for="busca-telefone">📱 Telefone:</label>
                <input type="tel" id="busca-telefone" placeholder="11987654321">
            </div>
            <button onclick="buscarCartelas()" class="btn-test">🔍 Buscar</button>
            <div id="busca-result"></div>
        </div>

        <div class="section" style="border-color: #f44336;">
            <h2>⚠️ Zona de Perigo</h2>
            <p><strong>Atenção:</strong> As ações abaixo são irreversíveis!</p>
            <button onclick="limparTodosOsDados()" class="btn-danger">🗑️ Limpar TODOS os Dados</button>
            <button onclick="limparCartelasVendidas()" class="btn-danger">🗑️ Limpar Apenas Cartelas Vendidas</button>
        </div>
    </div>

    <div class="container">
        <h2>🔍 Log de Debug</h2>
        <button onclick="limparLog()" style="background: #6c757d;">🗑️ Limpar Log</button>
        <div id="debug-log" class="log-area">Aguardando testes...</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>

    <script>
        let debugLog = [];

        function log(mensagem) {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${mensagem}`;
            debugLog.push(logLine);
            document.getElementById('debug-log').textContent = debugLog.join('\n');
            console.log(logLine);
        }

        function limparLog() {
            debugLog = [];
            document.getElementById('debug-log').textContent = 'Log limpo...';
        }

        function mostrarResultado(elementId, conteudo, tipo = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${tipo}">${conteudo}</div>`;
        }

        // Gerar cartela de teste
        function gerarCartelaTeste() {
            const numeros = [[], [], [], [], []];
            const ranges = [
                [1, 15],   // B
                [16, 30],  // I
                [31, 45],  // N
                [46, 60],  // G
                [61, 75]   // O
            ];

            for (let col = 0; col < 5; col++) {
                const [min, max] = ranges[col];
                const availableNumbers = [];
                
                for (let i = min; i <= max; i++) {
                    availableNumbers.push(i);
                }
                
                for (let row = 0; row < 5; row++) {
                    if (col === 2 && row === 2) {
                        numeros[col].push('FREE');
                    } else {
                        const randomIndex = Math.floor(Math.random() * availableNumbers.length);
                        const number = availableNumbers.splice(randomIndex, 1)[0];
                        numeros[col].push(number);
                    }
                }
            }

            return {
                id: `teste_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                numeros: numeros,
                preco: 5.00,
                dataGeracao: new Date().toISOString()
            };
        }

        // Normalizar telefone
        function normalizarTelefone(telefone) {
            return telefone ? telefone.replace(/\D/g, '') : '';
        }

        // Testar compra completa
        async function testarCompra() {
            const nome = document.getElementById('teste-nome').value.trim();
            const telefone = document.getElementById('teste-telefone').value.trim();
            const email = document.getElementById('teste-email').value.trim();
            const quantidade = parseInt(document.getElementById('teste-quantidade').value) || 1;

            if (!nome || !telefone) {
                mostrarResultado('compra-result', '⚠️ Nome e telefone são obrigatórios!', 'erro');
                return;
            }

            log(`🛒 Iniciando teste de compra: ${nome}, ${telefone}, ${quantidade} cartela(s)`);

            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService não está disponível');
                }

                const cartelasParaSalvar = [];
                
                // Gerar cartelas de teste
                for (let i = 0; i < quantidade; i++) {
                    const cartela = gerarCartelaTeste();
                    cartela.vendida = true;
                    cartela.comprador = nome;
                    cartela.telefone = normalizarTelefone(telefone);
                    cartela.email = email || null;
                    cartela.dataVenda = new Date().toISOString();
                    cartela.timestamp = new Date();
                    
                    cartelasParaSalvar.push(cartela);
                }

                log(`🎫 Geradas ${cartelasParaSalvar.length} cartelas para salvar`);
                log(`👤 Dados do comprador: ${nome}, tel: ${normalizarTelefone(telefone)}, email: ${email}`);

                // Salvar no Firebase
                let sucessos = 0;
                let erros = 0;

                for (let i = 0; i < cartelasParaSalvar.length; i++) {
                    const cartela = cartelasParaSalvar[i];
                    try {
                        log(`💾 Salvando cartela ${i + 1}/${cartelasParaSalvar.length}: ${cartela.id}`);
                        
                        await window.firebaseService.salvarCartela(cartela);
                        sucessos++;
                        
                        log(`✅ Cartela ${cartela.id} salva com sucesso`);
                    } catch (error) {
                        erros++;
                        log(`❌ Erro ao salvar cartela ${cartela.id}: ${error.message}`);
                    }
                }

                if (sucessos > 0) {
                    const resultado = `
                        <h3>✅ Compra Simulada com Sucesso!</h3>
                        <strong>👤 Comprador:</strong> ${nome}<br>
                        <strong>📱 Telefone:</strong> ${telefone} (normalizado: ${normalizarTelefone(telefone)})<br>
                        <strong>📧 Email:</strong> ${email || 'Não informado'}<br>
                        <strong>🎫 Cartelas:</strong> ${sucessos} salva(s), ${erros} erro(s)<br>
                        <strong>💰 Total:</strong> R$ ${(sucessos * 5.00).toFixed(2)}
                    `;
                    mostrarResultado('compra-result', resultado, 'resultado');
                    
                    log(`🎉 Compra finalizada: ${sucessos} cartelas salvas, ${erros} erros`);
                    
                    // Atualizar estatísticas automaticamente
                    setTimeout(verificarCartelas, 1000);
                } else {
                    throw new Error('Nenhuma cartela foi salva com sucesso');
                }

            } catch (error) {
                log(`❌ Erro durante teste de compra: ${error.message}`);
                mostrarResultado('compra-result', `❌ Erro: ${error.message}`, 'erro');
            }
        }

        // Verificar cartelas no banco
        async function verificarCartelas() {
            log('📊 Verificando cartelas no banco...');

            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService não está disponível');
                }

                const cartelas = await window.firebaseService.carregarCartelas();
                
                const totalCartelas = cartelas.length;
                const cartelasVendidas = cartelas.filter(c => c.vendida).length;
                
                // Contar compradores únicos
                const telefones = new Set();
                cartelas.filter(c => c.vendida).forEach(c => {
                    if (c.telefone) telefones.add(c.telefone);
                });
                
                const compradoresUnicos = telefones.size;
                
                // Calcular total arrecadado
                const totalArrecadado = cartelas
                    .filter(c => c.vendida)
                    .reduce((sum, c) => sum + (c.preco || 5.00), 0);

                // Atualizar estatísticas na interface
                document.getElementById('total-cartelas').textContent = totalCartelas;
                document.getElementById('cartelas-vendidas').textContent = cartelasVendidas;
                document.getElementById('compradores-unicos').textContent = compradoresUnicos;
                document.getElementById('total-arrecadado').textContent = `R$ ${totalArrecadado.toFixed(2)}`;

                log(`📊 Estatísticas: ${totalCartelas} total, ${cartelasVendidas} vendidas, ${compradoresUnicos} compradores, R$ ${totalArrecadado.toFixed(2)} arrecadado`);

                const resultado = `
                    <h3>📊 Verificação Concluída</h3>
                    <strong>🎫 Total de Cartelas:</strong> ${totalCartelas}<br>
                    <strong>✅ Cartelas Vendidas:</strong> ${cartelasVendidas}<br>
                    <strong>👥 Compradores Únicos:</strong> ${compradoresUnicos}<br>
                    <strong>💰 Total Arrecadado:</strong> R$ ${totalArrecadado.toFixed(2)}
                `;
                mostrarResultado('verificacao-result', resultado, 'resultado');

            } catch (error) {
                log(`❌ Erro ao verificar cartelas: ${error.message}`);
                mostrarResultado('verificacao-result', `❌ Erro: ${error.message}`, 'erro');
            }
        }

        // Listar últimas compras
        async function listarUltimas() {
            log('📋 Listando últimas compras...');

            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService não está disponível');
                }

                const cartelas = await window.firebaseService.carregarCartelas();
                const cartelasVendidas = cartelas.filter(c => c.vendida);
                
                // Agrupar por comprador e ordenar por data
                const compras = {};
                cartelasVendidas.forEach(cartela => {
                    const key = `${cartela.comprador}_${cartela.telefone}`;
                    if (!compras[key]) {
                        compras[key] = {
                            comprador: cartela.comprador,
                            telefone: cartela.telefone,
                            email: cartela.email,
                            cartelas: [],
                            total: 0,
                            dataCompra: cartela.dataVenda
                        };
                    }
                    compras[key].cartelas.push(cartela);
                    compras[key].total += cartela.preco || 5.00;
                });

                const listaCompras = Object.values(compras)
                    .sort((a, b) => new Date(b.dataCompra) - new Date(a.dataCompra))
                    .slice(0, 10);

                if (listaCompras.length > 0) {
                    let resultado = '<h3>📋 Últimas 10 Compras:</h3>';
                    listaCompras.forEach((compra, index) => {
                        resultado += `
                            <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px;">
                                <strong>${index + 1}. ${compra.comprador}</strong><br>
                                📱 ${compra.telefone}<br>
                                📧 ${compra.email || 'Não informado'}<br>
                                🎫 ${compra.cartelas.length} cartela(s)<br>
                                💰 R$ ${compra.total.toFixed(2)}<br>
                                🕒 ${new Date(compra.dataCompra).toLocaleString()}
                            </div>
                        `;
                    });
                    mostrarResultado('verificacao-result', resultado, 'resultado');
                } else {
                    mostrarResultado('verificacao-result', '📭 Nenhuma compra encontrada', 'info');
                }

                log(`📋 Listadas ${listaCompras.length} compras recentes`);

            } catch (error) {
                log(`❌ Erro ao listar compras: ${error.message}`);
                mostrarResultado('verificacao-result', `❌ Erro: ${error.message}`, 'erro');
            }
        }

        // Buscar cartelas por telefone
        async function buscarCartelas() {
            const telefone = document.getElementById('busca-telefone').value.trim();
            
            if (!telefone) {
                mostrarResultado('busca-result', '⚠️ Informe um telefone para buscar', 'erro');
                return;
            }

            const telefoneNormalizado = normalizarTelefone(telefone);
            log(`🔍 Buscando cartelas para telefone: ${telefone} (normalizado: ${telefoneNormalizado})`);

            try {
                if (typeof window.firebaseService === 'undefined') {
                    throw new Error('FirebaseService não está disponível');
                }

                const cartelas = await window.firebaseService.carregarCartelasPorComprador(telefoneNormalizado, null);
                
                if (cartelas.length > 0) {
                    let resultado = `<h3>✅ Encontradas ${cartelas.length} cartela(s)</h3>`;
                    cartelas.forEach((cartela, index) => {
                        resultado += `
                            <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px;">
                                <strong>Cartela ${index + 1}: ${cartela.id}</strong><br>
                                👤 ${cartela.comprador}<br>
                                📱 ${cartela.telefone}<br>
                                📧 ${cartela.email || 'Não informado'}<br>
                                💰 R$ ${(cartela.preco || 5.00).toFixed(2)}<br>
                                🕒 ${cartela.dataVenda ? new Date(cartela.dataVenda).toLocaleString() : 'Data não disponível'}
                            </div>
                        `;
                    });
                    mostrarResultado('busca-result', resultado, 'resultado');
                    
                    log(`✅ Encontradas ${cartelas.length} cartelas para o telefone`);
                } else {
                    mostrarResultado('busca-result', `❌ Nenhuma cartela encontrada para o telefone: ${telefone}`, 'erro');
                    log(`❌ Nenhuma cartela encontrada para telefone: ${telefone}`);
                }

            } catch (error) {
                log(`❌ Erro ao buscar cartelas: ${error.message}`);
                mostrarResultado('busca-result', `❌ Erro: ${error.message}`, 'erro');
            }
        }

        // Funções de limpeza (zona de perigo)
        async function limparTodosOsDados() {
            if (confirm('⚠️ ATENÇÃO: Isso irá deletar TODOS os dados do Firebase!\n\nTem certeza absoluta?')) {
                if (confirm('🚨 ÚLTIMA CONFIRMAÇÃO: Esta ação é IRREVERSÍVEL!\n\nConfirma mesmo?')) {
                    log('🗑️ Iniciando limpeza completa dos dados...');
                    alert('🚫 Função desabilitada por segurança. Use o painel administrativo para esta ação.');
                }
            }
        }

        async function limparCartelasVendidas() {
            if (confirm('⚠️ Isso irá deletar apenas as cartelas vendidas.\n\nTem certeza?')) {
                log('🗑️ Iniciando limpeza das cartelas vendidas...');
                alert('🚫 Função desabilitada por segurança. Use o painel administrativo para esta ação.');
            }
        }

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', () => {
            log('🧪 Página de teste de compra carregada');
            log('⏳ Aguardando Firebase...');
            
            // Verificar Firebase periodicamente
            const verificarFirebase = setInterval(() => {
                if (typeof window.firebaseService !== 'undefined') {
                    log('✅ Firebase Service carregado!');
                    clearInterval(verificarFirebase);
                    verificarCartelas();
                }
            }, 1000);
        });
    </script>
</body>
</html>
