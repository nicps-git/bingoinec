<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Corre√ß√£o Busca Cartelas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .log-area {
            background: #000;
            color: #0f0;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success { background: #28a745; }
        .warning { background: #ffc107; color: #000; }
        .danger { background: #dc3545; }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-ok { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-error { background: #dc3545; }
        .section-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste da Corre√ß√£o de Busca de Cartelas</h1>
        
        <div class="test-section">
            <h3 class="section-title">üìä Status do Sistema</h3>
            <p id="statusFirebase"><span class="status-indicator status-warning"></span>Verificando conex√£o Firebase...</p>
            <p id="statusCorre√ß√£o"><span class="status-indicator status-warning"></span>Aplicando corre√ß√£o...</p>
            <button onclick="verificarStatus()">Verificar Status</button>
        </div>

        <div class="test-section">
            <h3 class="section-title">üß™ Teste de Busca Corrigida</h3>
            <input type="text" id="telefoneTesteBusca" placeholder="Digite o telefone" value="85966666666">
            <button onclick="testarBuscaCorrigida()">Testar Busca Corrigida</button>
            <button onclick="compararBuscas()">Comparar Busca Antiga vs Nova</button>
        </div>

        <div class="test-section">
            <h3 class="section-title">üì± Gerador de Varia√ß√µes</h3>
            <input type="text" id="telefoneVariacoes" placeholder="Digite o telefone" value="85966666666">
            <button onclick="gerarVariacoes()">Gerar Varia√ß√µes</button>
            <button onclick="testarTodasVariacoes()">Testar Todas as Varia√ß√µes</button>
        </div>

        <div class="test-section">
            <h3 class="section-title">üéØ Teste Completo de Grava√ß√£o + Busca</h3>
            <input type="text" id="nomeTestCompleto" placeholder="Nome do comprador" value="Teste Corre√ß√£o">
            <input type="text" id="telefoneTestCompleto" placeholder="Telefone" value="85966666666">
            <button onclick="testarGravacaoBuscaCompleta()" class="success">Teste Completo</button>
        </div>

        <div class="test-section">
            <h3 class="section-title">üìã Log de Execu√ß√£o</h3>
            <div id="logArea" class="log-area"></div>
            <button onclick="limparLog()">Limpar Log</button>
        </div>

        <div class="test-section">
            <h3 class="section-title">üìä Resultados da Compara√ß√£o</h3>
            <div id="resultadosComparacao"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
    <script src="correcao-busca-cartelas.js"></script>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            const colors = {
                'error': '#ff6b6b',
                'success': '#51cf66',
                'warning': '#ffd43b',
                'info': '#74c0fc'
            };
            
            logArea.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const indicator = element.querySelector('.status-indicator');
            
            indicator.className = `status-indicator status-${status}`;
            element.innerHTML = `<span class="status-indicator status-${status}"></span>${message}`;
        }

        async function verificarStatus() {
            log('üîç Verificando status do sistema...', 'info');
            
            // Verificar Firebase
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    await db.collection('cartelas').limit(1).get();
                    updateStatus('statusFirebase', 'ok', 'Firebase conectado e funcionando');
                    log('‚úÖ Firebase: OK', 'success');
                } else {
                    updateStatus('statusFirebase', 'error', 'Firebase n√£o dispon√≠vel');
                    log('‚ùå Firebase: ERRO', 'error');
                }
            } catch (error) {
                updateStatus('statusFirebase', 'error', `Firebase erro: ${error.message}`);
                log(`‚ùå Firebase erro: ${error.message}`, 'error');
            }
            
            // Verificar corre√ß√£o
            if (typeof buscarCartelasCorrigida !== 'undefined') {
                updateStatus('statusCorre√ß√£o', 'ok', 'Corre√ß√£o aplicada com sucesso');
                log('‚úÖ Corre√ß√£o: OK', 'success');
            } else {
                updateStatus('statusCorre√ß√£o', 'error', 'Corre√ß√£o n√£o carregada');
                log('‚ùå Corre√ß√£o: ERRO', 'error');
            }
        }

        async function testarBuscaCorrigida() {
            const telefone = document.getElementById('telefoneTesteBusca').value;
            
            log(`üîç TESTANDO BUSCA CORRIGIDA - Telefone: ${telefone}`, 'info');
            
            try {
                const resultados = await buscarCartelasCorrigida(telefone);
                log(`‚úÖ Busca corrigida encontrou: ${resultados.length} cartelas`, 'success');
                
                resultados.forEach((cartela, index) => {
                    log(`   üìÑ Cartela ${index + 1}: ${cartela.id} (${cartela.comprador || cartela.nomeComprador})`, 'info');
                });
                
                if (resultados.length === 0) {
                    log('‚ö†Ô∏è Nenhuma cartela encontrada - pode indicar problema', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erro na busca corrigida: ${error.message}`, 'error');
            }
        }

        async function compararBuscas() {
            const telefone = document.getElementById('telefoneTesteBusca').value;
            
            log(`üîç COMPARANDO BUSCA ANTIGA vs NOVA - Telefone: ${telefone}`, 'info');
            
            try {
                // Busca antiga (firebaseService original)
                let resultadosAntigos = [];
                try {
                    if (window.firebaseService && window.firebaseService.carregarCartelasPorComprador.toString().includes('DEBUG')) {
                        // M√©todo antigo ainda dispon√≠vel - simular chamada
                        const db = firebase.firestore();
                        const snapshot = await db.collection('cartelas')
                            .where('telefone', '==', telefone)
                            .get();
                        
                        snapshot.forEach(doc => {
                            resultadosAntigos.push({ id: doc.id, ...doc.data() });
                        });
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è Busca antiga falhou: ${error.message}`, 'warning');
                }
                
                // Busca nova (corrigida)
                const resultadosNovos = await buscarCartelasCorrigida(telefone);
                
                log(`üìä RESULTADOS DA COMPARA√á√ÉO:`, 'info');
                log(`   Busca Antiga: ${resultadosAntigos.length} cartelas`, 'info');
                log(`   Busca Nova: ${resultadosNovos.length} cartelas`, 'info');
                
                // Exibir compara√ß√£o visual
                const container = document.getElementById('resultadosComparacao');
                container.innerHTML = `
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>M√©todo</th>
                                <th>Resultados</th>
                                <th>Status</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Busca Antiga</td>
                                <td>${resultadosAntigos.length}</td>
                                <td>${resultadosAntigos.length > 0 ? '‚úÖ Sucesso' : '‚ùå Falhou'}</td>
                                <td>M√©todo original do sistema</td>
                            </tr>
                            <tr>
                                <td>Busca Corrigida</td>
                                <td>${resultadosNovos.length}</td>
                                <td>${resultadosNovos.length > 0 ? '‚úÖ Sucesso' : '‚ö†Ô∏è Vazio'}</td>
                                <td>M√©todo com m√∫ltiplas varia√ß√µes</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                
                if (resultadosNovos.length > resultadosAntigos.length) {
                    log('üéØ MELHORIA: Busca corrigida encontrou mais resultados!', 'success');
                } else if (resultadosNovos.length === 0 && resultadosAntigos.length === 0) {
                    log('‚ö†Ô∏è ATEN√á√ÉO: Ambas as buscas falharam - problema nos dados', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erro na compara√ß√£o: ${error.message}`, 'error');
            }
        }

        function gerarVariacoes() {
            const telefone = document.getElementById('telefoneVariacoes').value;
            
            log(`üì± GERANDO VARIA√á√ïES PARA: ${telefone}`, 'info');
            
            const variacoes = gerarVariacoesTelefone(telefone);
            
            log(`üìä ${variacoes.length} varia√ß√µes geradas:`, 'success');
            variacoes.forEach((variacao, index) => {
                log(`   ${index + 1}. ${variacao}`, 'info');
            });
        }

        async function testarTodasVariacoes() {
            const telefone = document.getElementById('telefoneVariacoes').value;
            
            log(`üß™ TESTANDO TODAS AS VARIA√á√ïES PARA: ${telefone}`, 'info');
            
            const variacoes = gerarVariacoesTelefone(telefone);
            
            for (const variacao of variacoes) {
                try {
                    const db = firebase.firestore();
                    const snapshot = await db.collection('cartelas')
                        .where('telefone', '==', variacao)
                        .get();
                    
                    if (snapshot.size > 0) {
                        log(`‚úÖ Varia√ß√£o "${variacao}": ${snapshot.size} resultados`, 'success');
                    } else {
                        log(`‚ö™ Varia√ß√£o "${variacao}": 0 resultados`, 'info');
                    }
                    
                } catch (error) {
                    log(`‚ùå Erro varia√ß√£o "${variacao}": ${error.message}`, 'error');
                }
            }
        }

        async function testarGravacaoBuscaCompleta() {
            const nome = document.getElementById('nomeTestCompleto').value;
            const telefone = document.getElementById('telefoneTestCompleto').value;
            
            log(`üß™ TESTE COMPLETO - Nome: ${nome}, Telefone: ${telefone}`, 'info');
            
            try {
                // 1. Gravar cartela de teste
                log('1Ô∏è‚É£ Gravando cartela de teste...', 'info');
                
                const db = firebase.firestore();
                const cartelaTeste = {
                    id: `teste_${Date.now()}`,
                    numeros: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                    preco: 1.00,
                    vendida: true,
                    comprador: nome,
                    telefone: normalizarTelefonePadrao(telefone),
                    email: null,
                    dataVenda: new Date().toISOString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    testeCompleto: true
                };
                
                await db.collection('cartelas').doc(cartelaTeste.id).set(cartelaTeste);
                log(`‚úÖ Cartela gravada: ${cartelaTeste.id}`, 'success');
                
                // 2. Aguardar propaga√ß√£o
                log('2Ô∏è‚É£ Aguardando propaga√ß√£o (3 segundos)...', 'info');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // 3. Buscar com m√©todo corrigido
                log('3Ô∏è‚É£ Buscando com m√©todo corrigido...', 'info');
                const resultados = await buscarCartelasCorrigida(telefone);
                
                const cartelaEncontrada = resultados.find(c => c.id === cartelaTeste.id);
                
                if (cartelaEncontrada) {
                    log('‚úÖ SUCESSO: Cartela encontrada ap√≥s grava√ß√£o!', 'success');
                    log(`   ID: ${cartelaEncontrada.id}`, 'success');
                    log(`   Comprador: ${cartelaEncontrada.comprador}`, 'success');
                    log(`   Telefone: ${cartelaEncontrada.telefone}`, 'success');
                } else {
                    log('‚ùå FALHA: Cartela n√£o encontrada ap√≥s grava√ß√£o!', 'error');
                    log(`   Total encontrado: ${resultados.length}`, 'warning');
                }
                
                // 4. Limpeza (opcional)
                log('4Ô∏è‚É£ Limpando cartela de teste...', 'info');
                await db.collection('cartelas').doc(cartelaTeste.id).delete();
                log('üóëÔ∏è Cartela de teste removida', 'info');
                
            } catch (error) {
                log(`‚ùå Erro no teste completo: ${error.message}`, 'error');
            }
        }

        function limparLog() {
            document.getElementById('logArea').innerHTML = '';
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema de teste carregado!', 'success');
            setTimeout(verificarStatus, 1000);
        });
    </script>
</body>
</html>
