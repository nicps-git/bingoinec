<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Modal Vendas - Direto</title>
    <link rel="stylesheet" href="admin.css">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 20%, #CD853F 40%, #F4A460 60%, #DEB887 80%, #F5DEB3 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .info {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }
        .success {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Modal de Vendas - Direto</h1>
        
        <div id="status" class="status info">
            <strong>Status:</strong> Aguardando teste...
        </div>
        
        <div class="actions">
            <button class="btn btn-success" onclick="testarModal()">
                üí∞ Abrir Modal de Vendas
            </button>
            <button class="btn" onclick="verificarElementos()">
                üîç Verificar Elementos
            </button>
            <button class="btn" onclick="mostrarEstatisticas()">
                üìä Mostrar Estat√≠sticas
            </button>
        </div>
        
        <!-- Campo de pre√ßo para teste -->
        <div style="margin: 20px 0; text-align: center;">
            <label for="preco-cartela">Pre√ßo por Cartela (R$):</label>
            <input type="number" id="preco-cartela" min="0" step="0.01" value="5.00" style="margin-left: 10px; padding: 5px;">
        </div>
    </div>

    <!-- Modal de Vendas (estrutura do admin.html) -->
    <div id="modal-vendas" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalVendas()">&times;</span>
            <h3>üìä Relat√≥rio de Vendas</h3>
            <div class="modal-header">
                <div class="resumo-vendas">
                    <div class="resumo-item">
                        <span class="numero" id="total-cartelas">0</span>
                        <span class="label">Cartelas Geradas</span>
                    </div>
                    <div class="resumo-item">
                        <span class="numero" id="cartelas-vendidas-modal">0</span>
                        <span class="label">Cartelas Vendidas</span>
                    </div>
                    <div class="resumo-item">
                        <span class="numero" id="cartelas-disponiveis">0</span>
                        <span class="label">Dispon√≠veis</span>
                    </div>
                    <div class="resumo-item">
                        <span class="numero" id="total-arrecadado-modal">R$ 0,00</span>
                        <span class="label">Total Arrecadado</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button onclick="exportarRelatorio()" class="btn-success">üìä Exportar Relat√≥rio</button>
                <button onclick="atualizarDados()" class="btn-secondary">üîÑ Atualizar Dados</button>
                <button onclick="criarCartelaTeste()" class="btn">üé´ Criar Cartela Teste</button>
            </div>
            
            <div id="lista-cartelas" class="lista-cartelas">
                <div style="text-align: center; padding: 20px;">
                    üìä Clique em "Abrir Modal de Vendas" para carregar dados...
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v9 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config-admin.js"></script>

    <script>
        let db;
        
        // Inicializar Firebase
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o carregado');
                }
                
                if (!firebase.apps.length) {
                    if (typeof firebaseConfig !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                    } else {
                        throw new Error('Configura√ß√£o do Firebase n√£o encontrada');
                    }
                }
                
                db = firebase.firestore();
                updateStatus('‚úÖ Sistema carregado e Firebase conectado!', 'success');
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                updateStatus('‚ùå Erro: ' + error.message, 'error');
            }
        });
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>Status:</strong> ${message}`;
        }
        
        function verificarElementos() {
            const modal = document.getElementById('modal-vendas');
            const lista = document.getElementById('lista-cartelas');
            const resumo = document.getElementById('total-cartelas');
            
            let resultado = '';
            resultado += modal ? '‚úÖ Modal encontrado<br>' : '‚ùå Modal n√£o encontrado<br>';
            resultado += lista ? '‚úÖ Lista encontrada<br>' : '‚ùå Lista n√£o encontrada<br>';
            resultado += resumo ? '‚úÖ Resumo encontrado<br>' : '‚ùå Resumo n√£o encontrado<br>';
            resultado += db ? '‚úÖ Firebase conectado<br>' : '‚ùå Firebase n√£o conectado<br>';
            
            updateStatus(resultado, modal && lista && resumo && db ? 'success' : 'error');
        }
        
        async function testarModal() {
            updateStatus('üîÑ Abrindo modal de vendas...', 'info');
            
            try {
                const modal = document.getElementById('modal-vendas');
                const listaDiv = document.getElementById('lista-cartelas');
                
                if (!modal || !listaDiv) {
                    throw new Error('Modal ou lista n√£o encontrados');
                }
                
                // Mostrar modal
                modal.style.display = 'block';
                listaDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 24px; margin-bottom: 10px;">üìä</div><p>Carregando dados das vendas...</p></div>';
                
                if (!db) {
                    throw new Error('Banco de dados n√£o conectado');
                }
                
                // Carregar cartelas
                const snapshot = await db.collection('cartelas').orderBy('dataGeracao', 'desc').get();
                
                const cartelas = [];
                snapshot.forEach(doc => {
                    cartelas.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Calcular estat√≠sticas
                const vendidas = cartelas.filter(c => c.vendida === true);
                const disponiveis = cartelas.filter(c => !c.vendida);
                const precoCartela = parseFloat(document.getElementById('preco-cartela').value) || 5.00;
                const totalArrecadado = vendidas.length * precoCartela;
                
                // Atualizar resumo
                document.getElementById('total-cartelas').textContent = cartelas.length;
                document.getElementById('cartelas-vendidas-modal').textContent = vendidas.length;
                document.getElementById('cartelas-disponiveis').textContent = disponiveis.length;
                document.getElementById('total-arrecadado-modal').textContent = `R$ ${totalArrecadado.toFixed(2).replace('.', ',')}`;
                
                // Renderizar lista
                if (cartelas.length === 0) {
                    listaDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üìù</div>
                            <h4>Nenhuma cartela encontrada</h4>
                            <p>Clique em "Criar Cartela Teste" para adicionar dados.</p>
                        </div>
                    `;
                } else {
                    let html = '<div style="margin: 20px 0;"><h4 style="color: #333; margin-bottom: 15px;">üìä Lista de Cartelas:</h4>';
                    
                    cartelas.forEach(cartela => {
                        const status = cartela.vendida ? '‚úÖ Vendida' : '‚è≥ Dispon√≠vel';
                        const cliente = cartela.nomeComprador || 'N√£o informado';
                        const cor = cartela.vendida ? '#4CAF50' : '#ff9800';
                        
                        html += `
                            <div style="background: white; margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid ${cor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>ID:</strong> ${cartela.id.substring(0, 12)}...<br>
                                        <strong>Status:</strong> <span style="color: ${cor};">${status}</span><br>
                                        <strong>Cliente:</strong> ${cliente}<br>
                                        <strong>Pre√ßo:</strong> R$ ${precoCartela.toFixed(2).replace('.', ',')}
                                    </div>
                                    <div>
                                        <button onclick="verDetalhes('${cartela.id}')" style="background: #2196F3; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">üëÅÔ∏è Ver</button>
                                        ${!cartela.vendida ? `<button onclick="marcarVendida('${cartela.id}')" style="background: #4CAF50; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">üí∞ Vender</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    listaDiv.innerHTML = html;
                }
                
                updateStatus(`‚úÖ Modal aberto! ${cartelas.length} cartelas encontradas.`, 'success');
                
            } catch (error) {
                console.error('Erro ao abrir modal:', error);
                updateStatus('‚ùå Erro ao abrir modal: ' + error.message, 'error');
                
                const listaDiv = document.getElementById('lista-cartelas');
                if (listaDiv) {
                    listaDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #d32f2f;">
                            <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                            <h4>Erro ao carregar vendas</h4>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        async function criarCartelaTeste() {
            if (!db) {
                alert('Banco de dados n√£o conectado!');
                return;
            }
            
            try {
                const cartela = {
                    numeros: [
                        [1, 16, 31, 46, 61],
                        [2, 17, 32, 47, 62],
                        [3, 18, 'FREE', 48, 63],
                        [4, 19, 34, 49, 64],
                        [5, 20, 35, 50, 65]
                    ],
                    dataGeracao: firebase.firestore.FieldValue.serverTimestamp(),
                    vendida: Math.random() > 0.5,
                    nomeComprador: Math.random() > 0.5 ? 'Cliente Teste' : null,
                    telefone: Math.random() > 0.5 ? '(11) 99999-0000' : null
                };
                
                await db.collection('cartelas').add(cartela);
                alert('‚úÖ Cartela de teste criada!');
                
                // Recarregar modal se estiver aberto
                const modal = document.getElementById('modal-vendas');
                if (modal.style.display === 'block') {
                    setTimeout(testarModal, 500);
                }
                
            } catch (error) {
                console.error('Erro ao criar cartela:', error);
                alert('‚ùå Erro ao criar cartela: ' + error.message);
            }
        }
        
        function fecharModalVendas() {
            const modal = document.getElementById('modal-vendas');
            if (modal) {
                modal.style.display = 'none';
                updateStatus('Modal fechado', 'info');
            }
        }
        
        function exportarRelatorio() {
            alert('üìä Funcionalidade de exporta√ß√£o ser√° implementada em breve!');
        }
        
        function atualizarDados() {
            testarModal();
        }
        
        function verDetalhes(id) {
            alert(`Ver detalhes da cartela: ${id}`);
        }
        
        function marcarVendida(id) {
            const nome = prompt('Nome do comprador:');
            if (nome) {
                db.collection('cartelas').doc(id).update({
                    vendida: true,
                    nomeComprador: nome,
                    dataVenda: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('‚úÖ Cartela marcada como vendida!');
                    testarModal(); // Recarregar
                }).catch(error => {
                    alert('‚ùå Erro: ' + error.message);
                });
            }
        }
        
        function mostrarEstatisticas() {
            if (!db) {
                updateStatus('‚ùå Banco de dados n√£o conectado', 'error');
                return;
            }
            
            db.collection('cartelas').get().then(snapshot => {
                const total = snapshot.size;
                let vendidas = 0;
                
                snapshot.forEach(doc => {
                    if (doc.data().vendida) vendidas++;
                });
                
                const disponiveis = total - vendidas;
                const precoCartela = parseFloat(document.getElementById('preco-cartela').value) || 5.00;
                const totalArrecadado = vendidas * precoCartela;
                
                const stats = `
                    üìä <strong>Estat√≠sticas:</strong><br>
                    ‚Ä¢ Total de cartelas: ${total}<br>
                    ‚Ä¢ Cartelas vendidas: ${vendidas}<br>
                    ‚Ä¢ Cartelas dispon√≠veis: ${disponiveis}<br>
                    ‚Ä¢ Total arrecadado: R$ ${totalArrecadado.toFixed(2).replace('.', ',')}
                `;
                
                updateStatus(stats, 'success');
            }).catch(error => {
                updateStatus('‚ùå Erro ao carregar estat√≠sticas: ' + error.message, 'error');
            });
        }
    </script>
</body>
</html>
