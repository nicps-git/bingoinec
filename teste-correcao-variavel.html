<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Corre√ß√£o Vari√°vel - Bingo INEC</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: bold;
        }
        button:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .log {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .test-cartela {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
    </style>

    <!-- Firebase App (compat version) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Firestore (compat version) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Corre√ß√£o Vari√°vel cartelasParaSalvar</h1>
        
        <div class="status info">
            <strong>Objetivo:</strong> Verificar se o erro "cartelasParaSalvar is not defined" foi corrigido
        </div>

        <div class="status info">
            <div><strong>Status Firebase:</strong> <span id="firebase-status">Verificando...</span></div>
            <div><strong>Status Conex√£o:</strong> <span id="conexao-status">Verificando...</span></div>
        </div>

        <h3>üé´ Simula√ß√£o de Compra</h3>
        
        <div class="test-cartela">
            <strong>Cartela de Teste:</strong>
            <div id="cartela-teste"></div>
            <button onclick="adicionarCartelaTesteCarrinho()" class="btn-success">‚ûï Adicionar ao Carrinho</button>
        </div>

        <div>
            <strong>Carrinho:</strong> <span id="carrinho-info">Vazio</span>
            <button onclick="simularCompra()" id="btn-comprar" disabled>üõí Simular Compra</button>
            <button onclick="limparTeste()">üóëÔ∏è Limpar</button>
        </div>

        <h3>üìù Log de Teste</h3>
        <div id="log" class="log"></div>

        <h3>üîÑ A√ß√µes</h3>
        <button onclick="iniciarTeste()">üöÄ Iniciar Teste</button>
        <button onclick="verificarErros()">üîç Verificar Erros</button>
        <button onclick="abrirPaginaCartelas()">üìÑ Abrir P√°gina de Cartelas</button>
    </div>

    <script>
        let logElement;
        let carrinhoTeste = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`${prefix} ${message}`);
        }

        function gerarCartelaTeste() {
            const numeros = [];
            const numerosSorteados = new Set();
            
            while (numeros.length < 25) {
                const num = Math.floor(Math.random() * 75) + 1;
                if (!numerosSorteados.has(num)) {
                    numerosSorteados.add(num);
                    numeros.push(num);
                }
            }
            
            return numeros.sort((a, b) => a - b);
        }

        function adicionarCartelaTesteCarrinho() {
            try {
                const cartela = {
                    id: `teste_${Date.now()}`,
                    numeros: gerarCartelaTeste(),
                    preco: 5.00,
                    timestamp: new Date()
                };
                
                carrinhoTeste.push(cartela);
                
                document.getElementById('carrinho-info').textContent = `${carrinhoTeste.length} cartela(s)`;
                document.getElementById('btn-comprar').disabled = false;
                
                log(`Cartela adicionada ao carrinho: ${cartela.id}`, 'success');
                log(`N√∫meros: ${cartela.numeros.join(', ')}`);
                
            } catch (error) {
                log(`Erro ao adicionar cartela: ${error.message}`, 'error');
            }
        }

        async function simularCompra() {
            try {
                log('üõí Iniciando simula√ß√£o de compra...', 'info');
                
                // Simular dados do comprador
                const comprador = {
                    nome: 'Jo√£o Teste Silva',
                    telefone: '(85) 99999-9999',
                    email: 'joao.teste@email.com'
                };
                
                log(`üë§ Comprador: ${comprador.nome}`);
                log(`üì± Telefone: ${comprador.telefone}`);
                log(`üõí Cartelas no carrinho: ${carrinhoTeste.length}`);
                
                // Esta √© a parte cr√≠tica onde o erro ocorria
                // Declarar vari√°vel cartelasParaSalvar no escopo correto
                let cartelasParaSalvar = [];
                
                try {
                    // Verificar se o carrinho n√£o est√° vazio
                    if (!carrinhoTeste || carrinhoTeste.length === 0) {
                        throw new Error('Carrinho est√° vazio');
                    }
                    
                    log('üìã Preparando cartelas para salvar...');
                    
                    // Preparar cartelas para salvar no formato correto
                    cartelasParaSalvar = carrinhoTeste.map(item => ({
                        id: `cartela_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        numeros: item.numeros,
                        preco: item.preco,
                        vendida: true,
                        comprador: comprador.nome,
                        telefone: comprador.telefone,
                        email: comprador.email,
                        dataVenda: new Date().toISOString(),
                        timestamp: new Date()
                    }));
                    
                    log(`‚úÖ ${cartelasParaSalvar.length} cartelas preparadas para salvar`, 'success');
                    
                    // Verificar se o Firebase est√° dispon√≠vel
                    let salvoComSucesso = false;
                    
                    if (typeof firebaseService !== 'undefined') {
                        try {
                            log('üî• Tentando salvar no Firebase...');
                            
                            // Salvar todas as cartelas no Firebase
                            for (let i = 0; i < cartelasParaSalvar.length; i++) {
                                const cartela = cartelasParaSalvar[i];
                                log(`üíæ Salvando cartela ${i + 1}/${cartelasParaSalvar.length}: ${cartela.id}`);
                                
                                await firebaseService.salvarCartela(cartela);
                                log(`‚úÖ Cartela ${cartela.id} salva com sucesso`, 'success');
                            }
                            
                            salvoComSucesso = true;
                            log('‚úÖ Todas as cartelas salvas no Firebase', 'success');
                            
                        } catch (firebaseError) {
                            log(`‚ùå Erro do Firebase: ${firebaseError.message}`, 'error');
                            log('üíæ Salvando localmente como backup...');
                            
                            // Salvar localmente como fallback
                            const cartelasLocais = JSON.parse(localStorage.getItem('bingo_cartelas_vendidas') || '[]');
                            cartelasLocais.push(...cartelasParaSalvar);
                            localStorage.setItem('bingo_cartelas_vendidas', JSON.stringify(cartelasLocais));
                            
                            salvoComSucesso = true;
                            log('‚úÖ Cartelas salvas localmente como backup', 'success');
                        }
                    } else {
                        log('üíæ Firebase n√£o dispon√≠vel, salvando localmente...');
                        
                        // Salvar localmente
                        const cartelasLocais = JSON.parse(localStorage.getItem('bingo_cartelas_vendidas') || '[]');
                        cartelasLocais.push(...cartelasParaSalvar);
                        localStorage.setItem('bingo_cartelas_vendidas', JSON.stringify(cartelasLocais));
                        
                        salvoComSucesso = true;
                        log('‚úÖ Cartelas salvas localmente', 'success');
                    }
                    
                    if (!salvoComSucesso) {
                        throw new Error('N√£o foi poss√≠vel salvar as cartelas');
                    }

                    // Limpar carrinho
                    carrinhoTeste = [];
                    document.getElementById('carrinho-info').textContent = 'Vazio';
                    document.getElementById('btn-comprar').disabled = true;

                    // Sucesso
                    log(`üéâ Compra realizada com sucesso!`, 'success');
                    log(`üë§ Comprador: ${comprador.nome}`);
                    log(`üì± Telefone: ${comprador.telefone}`);
                    log(`üé´ Cartelas: ${cartelasParaSalvar.length}`);
                    
                } catch (processingError) {
                    log(`‚ùå Erro ao processar cartelas: ${processingError.message}`, 'error');
                    throw processingError;
                }

            } catch (error) {
                log(`‚ùå Erro na simula√ß√£o de compra: ${error.message}`, 'error');
                log(`‚ùå Stack trace: ${error.stack}`, 'error');
            }
        }

        function limparTeste() {
            carrinhoTeste = [];
            document.getElementById('carrinho-info').textContent = 'Vazio';
            document.getElementById('btn-comprar').disabled = true;
            logElement.textContent = '';
            log('üóëÔ∏è Teste limpo');
        }

        function verificarErros() {
            log('üîç Verificando poss√≠veis erros...');
            
            // Verificar se Firebase est√° carregado
            if (typeof firebase === 'undefined') {
                log('‚ùå Firebase SDK n√£o carregado', 'error');
            } else {
                log('‚úÖ Firebase SDK carregado', 'success');
            }
            
            // Verificar se firebaseService est√° dispon√≠vel
            if (typeof firebaseService === 'undefined') {
                log('‚ùå Firebase Service n√£o dispon√≠vel', 'error');
            } else {
                log('‚úÖ Firebase Service dispon√≠vel', 'success');
            }
            
            // Verificar localStorage
            try {
                localStorage.setItem('teste', 'ok');
                localStorage.removeItem('teste');
                log('‚úÖ localStorage funcionando', 'success');
            } catch (e) {
                log('‚ùå Problema com localStorage', 'error');
            }
            
            log('üîç Verifica√ß√£o de erros conclu√≠da');
        }

        function abrirPaginaCartelas() {
            window.open('cartelas.html', '_blank');
        }

        async function iniciarTeste() {
            log('üöÄ Iniciando teste completo...');
            
            // Verificar conex√£o com Firebase
            try {
                if (typeof firebaseService !== 'undefined') {
                    const conexaoOk = await firebaseService.verificarConexao();
                    document.getElementById('conexao-status').textContent = conexaoOk ? 'Conectado' : 'Offline';
                    document.getElementById('conexao-status').className = conexaoOk ? 'success' : 'warning';
                    log(`üî• Status Firebase: ${conexaoOk ? 'conectado' : 'offline'}`);
                } else {
                    document.getElementById('conexao-status').textContent = 'Service n√£o dispon√≠vel';
                    document.getElementById('conexao-status').className = 'error';
                    log('‚ùå Firebase Service n√£o dispon√≠vel', 'error');
                }
            } catch (error) {
                document.getElementById('conexao-status').textContent = 'Erro';
                document.getElementById('conexao-status').className = 'error';
                log(`‚ùå Erro ao verificar conex√£o: ${error.message}`, 'error');
            }
            
            // Gerar cartela de teste
            const numerosCartela = gerarCartelaTeste();
            document.getElementById('cartela-teste').textContent = numerosCartela.join(', ');
            
            log('‚úÖ Teste inicializado');
            log('üìã Cartela de teste gerada');
            log('üéØ Pronto para testar compra');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            logElement = document.getElementById('log');
            
            log('üß™ P√°gina de teste carregada');
            
            // Verificar status do Firebase
            if (typeof firebase !== 'undefined') {
                document.getElementById('firebase-status').textContent = 'Carregado';
                document.getElementById('firebase-status').className = 'success';
            } else {
                document.getElementById('firebase-status').textContent = 'N√£o carregado';
                document.getElementById('firebase-status').className = 'error';
            }
            
            await iniciarTeste();
        });
    </script>
</body>
</html>
