<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração - Bingo Arraiá INEC</title>
    <link rel="stylesheet" href="admin.css">
    
    <!-- Firebase SDK v9 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config-admin.js"></script>
    
    <!-- Sistema de Autenticação Unificado -->
    <script src="auth-unified.js"></script>
    
    <!-- Admin Logic -->
    <script src="admin.js"></script>
</head>
<body>
    <script>
        // SISTEMA DE AUTENTICAÇÃO DEFINITIVO PARA ADMIN
        console.log('🔐 [ADMIN] Verificação de autenticação iniciada...');
        
        function verificarAutenticacaoRobusta() {
            console.log('🔍 [ADMIN] Verificando autenticação...');
            
            try {
                // Verificar se há sessão armazenada
                const sessionData = localStorage.getItem('bingoAdminSession');
                
                if (!sessionData) {
                    console.log('❌ [ADMIN] Nenhuma sessão encontrada');
                    redirecionarParaLogin();
                    return;
                }
                
                // Verificar validade da sessão
                let dadosSessao;
                try {
                    dadosSessao = JSON.parse(sessionData);
                } catch (error) {
                    console.log('❌ [ADMIN] Sessão corrompida');
                    localStorage.removeItem('bingoAdminSession');
                    redirecionarParaLogin();
                    return;
                }
                
                // Verificar expiração
                if (dadosSessao.expiryTime) {
                    const agora = new Date();
                    const expiracao = new Date(dadosSessao.expiryTime);
                    
                    if (agora >= expiracao) {
                        console.log('❌ [ADMIN] Sessão expirada');
                        localStorage.removeItem('bingoAdminSession');
                        redirecionarParaLogin();
                        return;
                    }
                }
                
                // Verificar se é o admin correto
                if (!dadosSessao.email || dadosSessao.email !== 'admin@bingoinec.org.br') {
                    console.log('❌ [ADMIN] Sessão inválida');
                    localStorage.removeItem('bingoAdminSession');
                    redirecionarParaLogin();
                    return;
                }
                
                console.log('✅ [ADMIN] Usuário autenticado, carregando painel...');
                mostrarMensagemBemVindo(dadosSessao.email);
                
            } catch (error) {
                console.error('❌ [ADMIN] Erro na verificação:', error);
                redirecionarParaLogin();
            }
        }
        
        function redirecionarParaLogin() {
            console.log('🔄 [ADMIN] Redirecionando para login...');
            
            // Mostrar mensagem de redirecionamento
            document.body.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-family: Arial, sans-serif;
                    z-index: 10000;
                ">
                    <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.1); border-radius: 15px;">
                        <h2>🔐 Acesso Restrito</h2>
                        <p>Redirecionando para o login...</p>
                        <div style="margin-top: 20px;">
                            <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            // Redirecionar após um delay
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500);
        }
        
        function mostrarMensagemBemVindo(email) {
            console.log('👋 [ADMIN] Mostrando mensagem de boas-vindas');
            
            // Criar toast de boas-vindas
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10001;
                font-weight: bold;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                font-family: Arial, sans-serif;
            `;
            toast.textContent = `✅ Bem-vindo, ${email}!`;
            document.body.appendChild(toast);
            
            // Animar entrada
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Remover após 3 segundos
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // Aguardar carregamento da página
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', verificarAutenticacaoRobusta);
        } else {
            verificarAutenticacaoRobusta();
        }
        
        // Também verificar quando a janela carregar completamente
        window.addEventListener('load', verificarAutenticacaoRobusta);
    </script>
    <!-- Bandeirolas -->
    <div class="bandeirolas">
        <div class="bandeirola bandeirola-1"></div>
        <div class="bandeirola bandeirola-2"></div>
        <div class="bandeirola bandeirola-3"></div>
        <div class="bandeirola bandeirola-4"></div>
        <div class="bandeirola bandeirola-5"></div>
        <div class="bandeirola bandeirola-6"></div>
        <div class="bandeirola bandeirola-7"></div>
        <div class="bandeirola bandeirola-8"></div>
        <div class="bandeirola bandeirola-9"></div>
        <div class="bandeirola bandeirola-10"></div>
    </div>

    <header>
        <div class="logo-empresa">
            <img src="inec.png" alt="Logo INEC" class="logo-inec">
        </div>
        <div class="nav-links">
            <a href="index.html" class="btn-nav">🎪 Bingo</a>
            <a href="cartelas.html" class="btn-nav">🎫 Cartelas</a>
            <a href="minhas-cartelas.html" class="btn-nav">👀 Minhas Cartelas</a>
            <button onclick="logout()" class="btn-logout">🚪 Sair</button>
        </div>
        <div class="chapeu-palha">👒</div>
        <h1>🔧 Administração do Bingo</h1>
        <p>⚙️ Configure o Arraiá INEC</p>
        <div class="user-info">
            <span id="admin-user">👤 Carregando...</span>
            <span id="session-time">⏰ Carregando...</span>
        </div>
    </header>

    <main>
        <div class="admin-panel">
            <h2>📊 Configurações do Sorteio</h2>
            
            <div class="config-section">
                <h3>🎯 Range de Números</h3>
                <div class="input-group">
                    <label for="numero-inicial">Número Inicial:</label>
                    <input type="number" id="numero-inicial" min="1" max="999" value="1">
                </div>
                <div class="input-group">
                    <label for="numero-final">Número Final:</label>
                    <input type="number" id="numero-final" min="1" max="999" value="75">
                </div>
                <div class="range-info">
                    <span id="total-numeros">Total de números: 75</span>
                </div>
            </div>

            <div class="config-section">
                <h3>🎮 Controles do Jogo</h3>
                <div class="button-group">
                    <button id="salvar-config" class="btn-primary">💾 Salvar Configurações</button>
                    <button id="resetar-jogo" class="btn-warning">🔄 Resetar Jogo</button>
                    <button id="ir-para-bingo" class="btn-success">🎪 Ir para o Bingo</button>
                </div>
            </div>

            <div class="config-section">
                <h3>📈 Status Atual</h3>
                <div class="status-info">
                    <div class="status-item">
                        <span class="label">Range Atual:</span>
                        <span id="range-atual">1 - 75</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Números Sorteados:</span>
                        <span id="numeros-sorteados-count">0</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Números Restantes:</span>
                        <span id="numeros-restantes">75</span>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3>🗂️ Histórico de Números Sorteados</h3>
                <div class="historico-container">
                    <div id="historico-numeros" class="historico-numeros">
                        <p class="sem-historico">Nenhum número sorteado ainda</p>
                    </div>
                    <div class="historico-actions">
                        <button id="atualizar-numeros" class="btn-secondary">🔄 Atualizar Números</button>
                        <button id="diagnosticar-numeros" class="btn-info">🔍 Diagnosticar</button>
                        <button id="limpar-historico" class="btn-danger">🗑️ Limpar Histórico</button>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3>🎫 Gerenciamento de Cartelas</h3>
                <div class="cartelas-controls">
                    <div class="input-group">
                        <label for="preco-cartela">Preço por Cartela (R$):</label>
                        <input type="number" id="preco-cartela" min="0" step="0.01" value="5.00">
                    </div>
                    <div class="button-group">
                        <button id="gerar-cartela" class="btn-primary">🎫 Gerar Nova Cartela</button>
                        <button id="ver-vendas" class="btn-success">💰 Ver Vendas</button>
                    </div>
                </div>
                
                <div class="vendas-info">
                    <div class="status-item">
                        <span class="label">Cartelas Geradas:</span>
                        <span id="cartelas-geradas">0</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Cartelas Vendidas:</span>
                        <span id="cartelas-vendidas">0</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Total Arrecadado:</span>
                        <span id="total-arrecadado">R$ 0,00</span>
                    </div>
                </div>

                <div id="modal-vendas" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="fecharModalVendas()">&times;</span>
                        <h3>� Relatório de Vendas</h3>
                        <div class="modal-header">
                            <div class="resumo-vendas">
                                <div class="resumo-item">
                                    <span class="numero" id="total-cartelas">0</span>
                                    <span class="label">Cartelas Geradas</span>
                                </div>
                                <div class="resumo-item">
                                    <span class="numero" id="cartelas-vendidas-modal">0</span>
                                    <span class="label">Cartelas Vendidas</span>
                                </div>
                                <div class="resumo-item">
                                    <span class="numero" id="cartelas-disponiveis">0</span>
                                    <span class="label">Disponíveis</span>
                                </div>
                                <div class="resumo-item">
                                    <span class="numero" id="total-arrecadado-modal">R$ 0,00</span>
                                    <span class="label">Total Arrecadado</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-actions">
                            <button onclick="exportarRelatorio()" class="btn-success">📊 Exportar Relatório</button>
                            <button onclick="atualizarDados()" class="btn-secondary">🔄 Atualizar Dados</button>
                        </div>
                        
                        <div id="lista-cartelas" class="lista-cartelas">
                            <div style="text-align: center; padding: 20px;">
                                📊 Carregando dados das vendas...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Elementos decorativos -->
    <div class="fogueira">
        <div class="fogo"></div>
        <div class="lenha"></div>
    </div>

    <div class="estrelas">
        <div class="estrela estrela-1">⭐</div>
        <div class="estrela estrela-2">✨</div>
        <div class="estrela estrela-3">⭐</div>
        <div class="estrela estrela-4">✨</div>
        <div class="estrela estrela-5">⭐</div>
    </div>

    <script>
        // FUNÇÃO DE LOGOUT
        function logout() {
            console.log('🚪 [LOGOUT] Iniciando logout...');
            
            // Confirmar logout
            if (confirm('🔐 Tem certeza que deseja sair do painel administrativo?')) {
                // Remover sessão
                localStorage.removeItem('bingoAdminSession');
                console.log('✅ [LOGOUT] Sessão removida');
                
                // Mostrar mensagem de saída
                document.body.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-family: Arial, sans-serif;
                        z-index: 10000;
                    ">
                        <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.1); border-radius: 15px;">
                            <h2>👋 Logout Realizado</h2>
                            <p>Redirecionando para o login...</p>
                            <div style="margin-top: 20px;">
                                <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                
                // Redirecionar para login após delay
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }

        // FUNÇÃO PARA ATUALIZAR INFO DO USUÁRIO
        function atualizarInfoUsuario() {
            const userSpan = document.getElementById('admin-user');
            if (userSpan) {
                try {
                    const sessionData = localStorage.getItem('bingoAdminSession');
                    if (sessionData) {
                        const dados = JSON.parse(sessionData);
                        userSpan.textContent = `👤 ${dados.email}`;
                    } else {
                        userSpan.textContent = '👤 Usuário não identificado';
                    }
                } catch (error) {
                    userSpan.textContent = '👤 Erro na sessão';
                }
            }
        }

        // Atualizar info do usuário quando carregar
        document.addEventListener('DOMContentLoaded', atualizarInfoUsuario);
        window.addEventListener('load', atualizarInfoUsuario);
    </script>
</body>
</html>
