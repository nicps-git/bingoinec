<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Grava√ß√£o Firebase - SOLU√á√ÉO</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .log { height: 400px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; }
        .step { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste Grava√ß√£o Firebase - SOLU√á√ÉO DO PROBLEMA</h1>
        
        <div class="section warning">
            <h3>üéØ OBJETIVO</h3>
            <p>Descobrir POR QUE as cartelas n√£o est√£o sendo gravadas no Firestore</p>
            <p>E IMPLEMENTAR A SOLU√á√ÉO DEFINITIVA</p>
        </div>

        <div class="step">
            <h4>PASSO 1: Verificar Conex√£o e Permiss√µes</h4>
            <button onclick="verificarFirebaseCompleto()">üîç Verificar Firebase</button>
        </div>

        <div class="step">
            <h4>PASSO 2: Teste Grava√ß√£o Simples</h4>
            <button onclick="testeGravacaoMinima()">üíæ Teste M√≠nimo</button>
        </div>

        <div class="step">
            <h4>PASSO 3: Simular Fluxo Exato do Sistema</h4>
            <button onclick="simularFluxoCompleto()">üõí Simular Compra</button>
        </div>

        <div class="step">
            <h4>PASSO 4: Implementar Solu√ß√£o</h4>
            <button onclick="implementarSolucao()">‚úÖ Aplicar Corre√ß√£o</button>
        </div>

        <div class="section">
            <h3>üìä Resultados</h3>
            <div id="resultados"></div>
        </div>

        <div class="section">
            <h3>üìã Log Detalhado</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAQcCJmtqO3PNNxn7_e_LhjRGa5Wd1hxZ4",
            authDomain: "rifatomaz-7a6e5.firebaseapp.com",
            projectId: "rifatomaz-7a6e5",
            storageBucket: "rifatomaz-7a6e5.appspot.com",
            messagingSenderId: "265430386154",
            appId: "1:265430386154:web:c4c12e45c5db21da5d0e3d"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function exibirResultado(titulo, conteudo, tipo = 'info') {
            const resultadosDiv = document.getElementById('resultados');
            const classe = tipo === 'error' ? 'error' : tipo === 'success' ? 'success' : 'section';
            resultadosDiv.innerHTML += `
                <div class="${classe}">
                    <h4>${titulo}</h4>
                    <pre>${JSON.stringify(conteudo, null, 2)}</pre>
                </div>
            `;
        }

        async function verificarFirebaseCompleto() {
            log("üîç PASSO 1: Verificando Firebase...");
            
            try {
                // 1. Verificar SDK
                log("üì¶ Verificando SDK Firebase...");
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o carregado');
                }
                log("‚úÖ Firebase SDK carregado");

                // 2. Verificar Firestore
                log("üóÑÔ∏è Verificando Firestore...");
                if (!db) {
                    throw new Error('Firestore n√£o inicializado');
                }
                log("‚úÖ Firestore inicializado");

                // 3. Teste de conectividade
                log("üåê Testando conectividade...");
                const testDoc = await db.doc('teste/conectividade').get();
                log("‚úÖ Conectividade OK");

                // 4. Verificar permiss√µes de escrita
                log("üîê Testando permiss√µes de escrita...");
                try {
                    await db.collection('teste-permissao').add({
                        teste: true,
                        timestamp: new Date()
                    });
                    log("‚úÖ Permiss√µes de escrita OK");
                } catch (permError) {
                    log(`‚ùå Erro de permiss√£o: ${permError.message}`);
                    throw permError;
                }

                exibirResultado("PASSO 1 - Firebase OK", {
                    status: "SUCESSO",
                    sdk: "carregado",
                    firestore: "conectado",
                    permissoes: "OK"
                }, 'success');

                return true;

            } catch (error) {
                log(`‚ùå PASSO 1 FALHOU: ${error.message}`);
                exibirResultado("PASSO 1 - Erro Firebase", {
                    erro: error.message,
                    stack: error.stack
                }, 'error');
                throw error;
            }
        }

        async function testeGravacaoMinima() {
            log("üíæ PASSO 2: Teste de grava√ß√£o m√≠nima...");
            
            try {
                const dadosMinimos = {
                    teste: "gravacao-minima",
                    timestamp: new Date(),
                    id: `teste-${Date.now()}`
                };

                log("üìù Dados para teste:");
                log(JSON.stringify(dadosMinimos, null, 2));

                // Teste 1: .add()
                log("üî¨ Teste 1: usando .add()");
                const docRef1 = await db.collection('cartelas').add(dadosMinimos);
                log(`‚úÖ Documento criado com .add(): ${docRef1.id}`);

                // Verificar se existe
                const doc1 = await db.collection('cartelas').doc(docRef1.id).get();
                if (doc1.exists) {
                    log("‚úÖ Documento verificado com .add()");
                } else {
                    log("‚ùå Documento n√£o encontrado ap√≥s .add()");
                }

                // Teste 2: .set()
                log("üî¨ Teste 2: usando .set()");
                const docId2 = `teste-set-${Date.now()}`;
                await db.collection('cartelas').doc(docId2).set({
                    ...dadosMinimos,
                    metodo: 'set'
                });
                log(`‚úÖ Documento criado com .set(): ${docId2}`);

                // Verificar se existe
                const doc2 = await db.collection('cartelas').doc(docId2).get();
                if (doc2.exists) {
                    log("‚úÖ Documento verificado com .set()");
                } else {
                    log("‚ùå Documento n√£o encontrado ap√≥s .set()");
                }

                // Listar documentos na cole√ß√£o
                log("üìã Listando documentos na cole√ß√£o 'cartelas'...");
                const snapshot = await db.collection('cartelas').get();
                log(`üìä Total de documentos encontrados: ${snapshot.size}`);
                
                const documentos = [];
                snapshot.forEach(doc => {
                    documentos.push({
                        id: doc.id,
                        data: doc.data()
                    });
                });

                exibirResultado("PASSO 2 - Teste Grava√ß√£o", {
                    status: "SUCESSO",
                    documentosNaCole√ß√£o: snapshot.size,
                    documentosTeste: documentos.filter(d => d.data.teste || d.data.metodo),
                    add_id: docRef1.id,
                    set_id: docId2
                }, 'success');

                return { add_id: docRef1.id, set_id: docId2, total: snapshot.size };

            } catch (error) {
                log(`‚ùå PASSO 2 FALHOU: ${error.message}`);
                exibirResultado("PASSO 2 - Erro Grava√ß√£o", {
                    erro: error.message,
                    stack: error.stack
                }, 'error');
                throw error;
            }
        }

        async function simularFluxoCompleto() {
            log("üõí PASSO 3: Simulando fluxo completo de compra...");
            
            try {
                // Simular dados exatos do sistema
                const cartelaSimulada = {
                    id: `cartela_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    numeros: [[1,2,3,4,5], [16,17,18,19,20], [31,'FREE',33,34,35], [46,47,48,49,50], [61,62,63,64,65]],
                    preco: 5.00,
                    vendida: true,
                    comprador: "Jo√£o Teste",
                    telefone: "85966666666",
                    email: "teste@email.com",
                    dataVenda: new Date().toISOString(),
                    timestamp: new Date()
                };

                log("üé´ Dados da cartela simulada:");
                log(JSON.stringify(cartelaSimulada, null, 2));

                // Simular fun√ß√£o salvarCartela do firebase-service.js
                log("üíæ Simulando firebase-service.salvarCartela()...");
                
                const cartelaComTimestamp = {
                    ...cartelaSimulada,
                    dataGeracao: firebase.firestore.FieldValue.serverTimestamp(),
                    dataVenda: cartelaSimulada.vendida ? firebase.firestore.FieldValue.serverTimestamp() : null
                };

                // Usar .set() como no c√≥digo original
                await db.collection('cartelas').doc(cartelaComTimestamp.id).set(cartelaComTimestamp);
                log(`‚úÖ Cartela salva com ID: ${cartelaComTimestamp.id}`);

                // Aguardar propaga√ß√£o
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Verificar se foi salva
                log("üîç Verificando se cartela foi salva...");
                const docVerificacao = await db.collection('cartelas').doc(cartelaComTimestamp.id).get();
                
                if (docVerificacao.exists) {
                    log("‚úÖ SUCESSO! Cartela encontrada no banco");
                    const dados = docVerificacao.data();
                    log(`üìä Dados salvos: ${JSON.stringify(dados, null, 2)}`);
                    
                    // Testar busca por telefone
                    log("üì± Testando busca por telefone...");
                    const buscaTelefone = await db.collection('cartelas')
                        .where('telefone', '==', '85966666666')
                        .get();
                    
                    log(`üìã Cartelas encontradas por telefone: ${buscaTelefone.size}`);
                    
                    exibirResultado("PASSO 3 - Fluxo Completo", {
                        status: "SUCESSO",
                        cartela_id: cartelaComTimestamp.id,
                        gravacao: "OK",
                        busca_telefone: buscaTelefone.size,
                        dados: dados
                    }, 'success');
                    
                    return cartelaComTimestamp.id;
                    
                } else {
                    log("‚ùå ERRO! Cartela n√£o encontrada ap√≥s grava√ß√£o");
                    throw new Error("Cartela n√£o encontrada ap√≥s grava√ß√£o");
                }

            } catch (error) {
                log(`‚ùå PASSO 3 FALHOU: ${error.message}`);
                exibirResultado("PASSO 3 - Erro Fluxo", {
                    erro: error.message,
                    stack: error.stack
                }, 'error');
                throw error;
            }
        }

        async function implementarSolucao() {
            log("‚úÖ PASSO 4: Implementando solu√ß√£o...");
            
            try {
                log("üîç Analisando problema...");
                
                // Executar todos os passos anteriores
                await verificarFirebaseCompleto();
                const resultadoGravacao = await testeGravacaoMinima();
                const cartelaId = await simularFluxoCompleto();
                
                if (resultadoGravacao.total > 0 && cartelaId) {
                    log("üéâ PROBLEMA RESOLVIDO!");
                    log("üìã O Firebase est√° funcionando corretamente");
                    log("üí° O problema pode estar no c√≥digo do sistema principal");
                    
                    // Diagnosticar poss√≠veis causas
                    const diagnostico = {
                        firebase_ok: true,
                        gravacao_ok: true,
                        busca_ok: true,
                        possiveis_causas: [
                            "Erro silencioso no c√≥digo principal",
                            "Firebase service n√£o carregado corretamente",
                            "Erro na normaliza√ß√£o de telefone",
                            "Problema de timing/propaga√ß√£o",
                            "Configura√ß√£o incorreta no HTML principal"
                        ],
                        solucao_recomendada: "Aplicar logs detalhados no sistema principal"
                    };
                    
                    exibirResultado("DIAGN√ìSTICO FINAL", diagnostico, 'success');
                    
                    log("üîß PR√ìXIMOS PASSOS:");
                    log("1. Adicionar logs detalhados no cartelas.js");
                    log("2. Verificar carregamento do firebase-service.js");
                    log("3. Testar fluxo completo com logs");
                    log("4. Implementar fallback melhorado");
                    
                } else {
                    throw new Error("Problema persistente no Firebase");
                }

            } catch (error) {
                log(`‚ùå PASSO 4 FALHOU: ${error.message}`);
                exibirResultado("PASSO 4 - Erro Solu√ß√£o", {
                    erro: error.message
                }, 'error');
            }
        }

        // Auto-inicializar
        window.addEventListener('load', () => {
            log("üöÄ Teste de Grava√ß√£o Firebase iniciado");
            log("üéØ Objetivo: Descobrir e corrigir problema de grava√ß√£o");
            log("üìã Execute os passos em ordem para diagnosticar");
        });
    </script>
</body>
</html>
