<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIAGN√ìSTICO CR√çTICO - Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(45deg, #ffebee, #fce4ec);
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .critical-test {
            margin: 15px 0;
            padding: 20px;
            border: 3px solid #f44336;
            border-radius: 10px;
            background: #ffebee;
        }
        .success-test {
            border-color: #4CAF50;
            background: #e8f5e8;
        }
        .warning-test {
            border-color: #FF9800;
            background: #fff8e1;
        }
        
        button {
            padding: 15px 30px;
            margin: 10px 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .btn-critical { background: #f44336; color: white; }
        .btn-test { background: #2196F3; color: white; }
        .btn-admin { background: #9C27B0; color: white; }
        
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 15px 0;
            border: 2px solid #333;
        }
        
        .error-highlight {
            color: #ff4444;
            font-weight: bold;
        }
        .success-highlight {
            color: #44ff44;
            font-weight: bold;
        }
        .warning-highlight {
            color: #ffff44;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® DIAGN√ìSTICO CR√çTICO - Firebase</h1>
        <p><strong>Investiga√ß√£o de falhas de grava√ß√£o no Firebase</strong></p>
        
        <div class="critical-test">
            <h3>üî• TESTES CR√çTICOS</h3>
            <button class="btn-critical" onclick="testeCriticoCompleto()">üö® DIAGN√ìSTICO COMPLETO</button>
            <button class="btn-test" onclick="testePermissoes()">üîê Testar Permiss√µes</button>
            <button class="btn-test" onclick="testeRedeConexao()">üåê Testar Rede/Conex√£o</button>
            <button class="btn-admin" onclick="compararComAdmin()">üëë Comparar com Admin</button>
            <button onclick="limparTudo()">üßπ Limpar</button>
        </div>
        
        <div class="critical-test warning-test">
            <h3>‚ö° GRAVA√á√ÉO FOR√áADA</h3>
            <p>Testa EXATAMENTE como a p√°gina admin faz</p>
            <button class="btn-critical" onclick="gravarComoAdmin()">‚ö° GRAVAR COMO ADMIN</button>
            <button class="btn-critical" onclick="gravarDiretoFirestore()">‚ö° DIRETO NO FIRESTORE</button>
        </div>
        
        <div class="critical-test">
            <h3>üìä Console de Diagn√≥stico</h3>
            <div id="diagnostic-console" class="console-output">Aguardando diagn√≥stico...</div>
        </div>
    </div>

    <!-- Firebase SDK v8 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <script>
        let diagnosticLogs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typePrefix = {
                'critical': '[CR√çTICO]',
                'error': '[ERRO]',
                'success': '[SUCESSO]',
                'warning': '[AVISO]',
                'info': '[INFO]',
                'debug': '[DEBUG]'
            }[type] || '[INFO]';
            
            const line = `${timestamp} ${typePrefix} ${message}`;
            diagnosticLogs.push({text: line, type: type});
            
            console.log(line);
            updateConsole();
        }
        
        function updateConsole() {
            const console_div = document.getElementById('diagnostic-console');
            console_div.innerHTML = diagnosticLogs.map(log => {
                const className = {
                    'critical': 'error-highlight',
                    'error': 'error-highlight',
                    'success': 'success-highlight',
                    'warning': 'warning-highlight'
                }[log.type] || '';
                
                return `<span class="${className}">${log.text}</span>`;
            }).join('\n');
            console_div.scrollTop = console_div.scrollHeight;
        }
        
        function limparTudo() {
            diagnosticLogs = [];
            updateConsole();
        }
        
        async function testeCriticoCompleto() {
            log('üö® === DIAGN√ìSTICO CR√çTICO COMPLETO ===', 'critical');
            
            try {
                // 1. Verificar Firebase SDK
                log('1Ô∏è‚É£ Verificando Firebase SDK...');
                if (typeof firebase === 'undefined') {
                    log('FALHA CR√çTICA: Firebase SDK n√£o carregado', 'critical');
                    return;
                }
                log(`‚úÖ Firebase SDK v${firebase.SDK_VERSION} carregado`, 'success');
                
                // 2. Verificar Apps
                log('2Ô∏è‚É£ Verificando apps Firebase...');
                log(`Apps inicializados: ${firebase.apps.length}`);
                if (firebase.apps.length === 0) {
                    log('FALHA: Nenhuma app Firebase inicializada', 'error');
                    return;
                }
                
                const app = firebase.apps[0];
                log(`‚úÖ App principal: ${app.name}`, 'success');
                log(`‚úÖ Projeto: ${app.options.projectId}`, 'success');
                
                // 3. Verificar Firestore
                log('3Ô∏è‚É£ Verificando Firestore...');
                const db = firebase.firestore();
                log('‚úÖ Inst√¢ncia Firestore criada', 'success');
                
                // 4. Verificar FirebaseDB
                log('4Ô∏è‚É£ Verificando FirebaseDB...');
                if (!window.FirebaseDB) {
                    log('FALHA CR√çTICA: window.FirebaseDB n√£o existe', 'critical');
                } else {
                    log('‚úÖ window.FirebaseDB existe', 'success');
                    log(`M√©todos dispon√≠veis: ${Object.keys(window.FirebaseDB).join(', ')}`, 'debug');
                    
                    if (typeof window.FirebaseDB.saveCartela === 'function') {
                        log('‚úÖ M√©todo saveCartela dispon√≠vel', 'success');
                    } else {
                        log('FALHA: M√©todo saveCartela n√£o √© fun√ß√£o', 'error');
                    }
                }
                
                // 5. Teste de conectividade b√°sica
                log('5Ô∏è‚É£ Testando conectividade b√°sica...');
                try {
                    const testRef = db.collection('teste-diagnostico').doc('conectividade');
                    await testRef.set({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        teste: 'conectividade-basica',
                        userAgent: navigator.userAgent.substring(0, 50)
                    });
                    log('‚úÖ CONECTIVIDADE OK - Grava√ß√£o b√°sica funcionou', 'success');
                    
                    // Verificar se foi gravado
                    const doc = await testRef.get();
                    if (doc.exists) {
                        log('‚úÖ VERIFICA√á√ÉO OK - Documento foi gravado e lido', 'success');
                    } else {
                        log('FALHA: Documento n√£o foi encontrado ap√≥s grava√ß√£o', 'error');
                    }
                } catch (connectError) {
                    log(`FALHA CR√çTICA na conectividade: ${connectError.message}`, 'critical');
                    log(`C√≥digo do erro: ${connectError.code}`, 'error');
                }
                
            } catch (error) {
                log(`ERRO CR√çTICO no diagn√≥stico: ${error.message}`, 'critical');
                log(`Stack: ${error.stack}`, 'debug');
            }
        }
        
        async function testePermissoes() {
            log('üîê === TESTE DE PERMISS√ïES ===', 'warning');
            
            try {
                const db = firebase.firestore();
                
                // Tentar gravar na cole√ß√£o 'cartelas'
                log('Testando permiss√µes na cole√ß√£o "cartelas"...');
                const cartelaRef = db.collection('cartelas').doc('teste-permissao');
                await cartelaRef.set({
                    teste: 'permissao',
                    timestamp: Date.now(),
                    timestampFirebase: firebase.firestore.FieldValue.serverTimestamp()
                });
                log('‚úÖ PERMISS√ÉO OK para cole√ß√£o "cartelas"', 'success');
                
                // Tentar ler
                const doc = await cartelaRef.get();
                if (doc.exists) {
                    log('‚úÖ LEITURA OK da cole√ß√£o "cartelas"', 'success');
                } else {
                    log('FALHA: N√£o conseguiu ler ap√≥s gravar', 'error');
                }
                
                // Tentar deletar
                await cartelaRef.delete();
                log('‚úÖ EXCLUS√ÉO OK da cole√ß√£o "cartelas"', 'success');
                
            } catch (permError) {
                log(`ERRO de permiss√£o: ${permError.message}`, 'error');
                log(`C√≥digo: ${permError.code}`, 'error');
            }
        }
        
        async function testeRedeConexao() {
            log('üåê === TESTE DE REDE/CONEX√ÉO ===', 'warning');
            
            try {
                // Verificar se est√° online
                log(`Status online: ${navigator.onLine}`);
                
                // Testar conectividade com Google
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 5000);
                
                try {
                    const response = await fetch('https://www.google.com', {
                        method: 'HEAD',
                        signal: controller.signal
                    });
                    log(`‚úÖ Conectividade externa OK (status: ${response.status})`, 'success');
                } catch (fetchError) {
                    log(`AVISO: Problema na conectividade externa: ${fetchError.message}`, 'warning');
                }
                
                // Testar conectividade espec√≠fica com Firebase
                try {
                    const db = firebase.firestore();
                    const startTime = Date.now();
                    await db.collection('teste-rede').doc('ping').set({ping: Date.now()});
                    const endTime = Date.now();
                    log(`‚úÖ Conectividade Firebase OK (${endTime - startTime}ms)`, 'success');
                } catch (firebaseError) {
                    log(`ERRO na conectividade Firebase: ${firebaseError.message}`, 'error');
                }
                
            } catch (error) {
                log(`ERRO no teste de rede: ${error.message}`, 'error');
            }
        }
        
        async function compararComAdmin() {
            log('üëë === COMPARA√á√ÉO COM ADMIN ===', 'warning');
            
            try {
                log('Tentando simular exatamente o que a p√°gina admin faz...');
                
                // Verificar se temos acesso aos mesmos recursos que o admin
                if (window.FirebaseDB && window.FirebaseDB.saveCartela) {
                    log('‚úÖ M√©todo saveCartela dispon√≠vel (mesmo que admin)', 'success');
                    
                    // Simular dados exatamente como admin geraria
                    const cartelaAdmin = {
                        id: `ADMIN-SIM-${Date.now()}`,
                        numeros: [1, 16, 31, 46, 61, 2, 17, 32, 47, 62, 3, 18, 33, 48, 63],
                        preco: 5.00,
                        status: 'vendida',
                        comprador: {
                            nome: 'Simula√ß√£o Admin',
                            telefone: '11999999999'
                        },
                        nome: 'Simula√ß√£o Admin',
                        telefone: '11999999999',
                        dataCompra: new Date(),
                        timestamp: Date.now()
                    };
                    
                    log('Tentando salvar usando o mesmo m√©todo que admin...');
                    const resultado = await window.FirebaseDB.saveCartela(cartelaAdmin);
                    
                    if (resultado && resultado.success) {
                        log(`‚úÖ SUCESSO! Salvou como admin: ${resultado.id}`, 'success');
                    } else {
                        log('FALHA: Mesmo m√©todo que admin n√£o funcionou', 'error');
                    }
                } else {
                    log('FALHA: M√©todo saveCartela n√£o dispon√≠vel', 'error');
                }
                
            } catch (error) {
                log(`ERRO na compara√ß√£o com admin: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'debug');
            }
        }
        
        async function gravarComoAdmin() {
            log('‚ö° === GRAVA√á√ÉO FOR√áADA COMO ADMIN ===', 'critical');
            
            try {
                // Usar exatamente a mesma configura√ß√£o que admin usa
                const firebaseConfig = {
                  apiKey: "AIzaSyC7CnYV9gkczJ8zIcmTLrvQlrFFKNVhJNw",
                  authDomain: "bingoinec.firebaseapp.com",
                  projectId: "bingoinec",
                  storageBucket: "bingoinec.firebasestorage.app",
                  messagingSenderId: "483007152008",
                  appId: "1:483007152008:web:6347c02216e162c0a3c43d"
                };
                
                log('Configura√ß√£o Firebase id√™ntica ao admin');
                
                // For√ßar reinicializa√ß√£o se necess√°rio
                let app;
                try {
                    app = firebase.app();
                } catch {
                    app = firebase.initializeApp(firebaseConfig);
                }
                
                const db = firebase.firestore();
                
                // Dados id√™nticos aos que admin criaria
                const cartelaFor√ßada = {
                    id: `FORCADA-ADMIN-${Date.now()}`,
                    numeros: [5, 20, 35, 50, 65, 6, 21, 36, 51, 66, 7, 22, 37, 52, 67],
                    preco: 5.00,
                    status: "vendida",
                    comprador: {
                        nome: "For√ßado Como Admin",
                        telefone: "11888888888"
                    },
                    nome: "For√ßado Como Admin",
                    telefone: "11888888888",
                    dataCompra: new Date(),
                    timestamp: Date.now(),
                    timestampFirebase: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                log('Executando grava√ß√£o for√ßada...');
                const docRef = await db.collection('cartelas').add(cartelaFor√ßada);
                log(`‚úÖ SUCESSO FOR√áADO! ID: ${docRef.id}`, 'success');
                
                // Verificar imediatamente
                const doc = await docRef.get();
                if (doc.exists) {
                    log('‚úÖ VERIFICA√á√ÉO: Cartela for√ßada foi gravada!', 'success');
                    const data = doc.data();
                    log(`Dados gravados: ${JSON.stringify(data, null, 2)}`, 'debug');
                } else {
                    log('FALHA: Cartela for√ßada n√£o foi encontrada', 'error');
                }
                
            } catch (error) {
                log(`ERRO na grava√ß√£o for√ßada: ${error.message}`, 'critical');
                log(`C√≥digo: ${error.code}`, 'error');
                log(`Stack: ${error.stack}`, 'debug');
            }
        }
        
        async function gravarDiretoFirestore() {
            log('‚ö° === GRAVA√á√ÉO DIRETA NO FIRESTORE ===', 'critical');
            
            try {
                // Bypass completo do sistema - usar s√≥ o Firestore
                const db = firebase.firestore();
                
                const dadosDiretos = {
                    teste: 'direto-firestore',
                    id: `DIRETO-${Date.now()}`,
                    timestamp: Date.now(),
                    timestampFirebase: firebase.firestore.FieldValue.serverTimestamp(),
                    dadosCompletos: {
                        numeros: [10, 25, 40, 55, 70, 11, 26, 41, 56, 71, 12, 27, 42, 57, 72],
                        preco: 5.00,
                        status: "vendida",
                        nome: "Direto Firestore",
                        telefone: "11777777777"
                    }
                };
                
                log('Executando grava√ß√£o 100% direta...');
                const docRef = await db.collection('cartelas').add(dadosDiretos);
                log(`‚úÖ GRAVA√á√ÉO DIRETA SUCESSO! ID: ${docRef.id}`, 'success');
                
                // Verificar
                const doc = await docRef.get();
                if (doc.exists) {
                    log('‚úÖ VERIFICA√á√ÉO DIRETA: Documento existe!', 'success');
                } else {
                    log('FALHA: Documento direto n√£o encontrado', 'error');
                }
                
            } catch (error) {
                log(`ERRO na grava√ß√£o direta: ${error.message}`, 'critical');
                log(`Isso indica problema fundamental no Firebase`, 'critical');
            }
        }
        
        // Auto-start
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('üöÄ Sistema de diagn√≥stico cr√≠tico carregado');
                log('Execute o DIAGN√ìSTICO COMPLETO primeiro');
            }, 1000);
        });
    </script>
</body>
</html>
