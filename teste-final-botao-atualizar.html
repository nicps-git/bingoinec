<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste Final Bot√£o Atualizar</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .btn-atualizar {
            background: #2196F3;
        }
        .btn-atualizar:hover {
            background: #1976D2;
        }
        .status {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #FF9800; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Final - Bot√£o Atualizar</h1>
        <p>Teste completo da funcionalidade do bot√£o "Atualizar" com corre√ß√µes aplicadas.</p>
        
        <div class="status">
            <h3>üìä Status do Sistema</h3>
            <div id="status-firebase">‚è≥ Verificando Firebase...</div>
            <div id="status-funcoes">‚è≥ Verificando fun√ß√µes...</div>
            <div id="status-dados">‚è≥ Verificando dados...</div>
        </div>
        
        <div class="controles">
            <button class="btn btn-atualizar" onclick="testarBotaoAtualizar()">üîÑ Testar Bot√£o Atualizar</button>
            <button class="btn" onclick="simularCompradorLogado()">üë§ Simular Comprador</button>
            <button class="btn" onclick="verificarSistema()">üîç Verificar Sistema</button>
            <button class="btn" onclick="limparTeste()">üßπ Limpar</button>
        </div>
        
        <div id="log-container" class="log">
            <div class="info">üöÄ Sistema iniciado - aguardando testes...</div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>

    <script>
        // Vari√°veis globais para simular o estado da aplica√ß√£o
        let compradorAtual = null;
        let cartelasComprador = [];
        let numerosSorteados = [];
        
        function log(mensagem, tipo = 'info') {
            const container = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = tipo;
            div.innerHTML = `[${timestamp}] ${mensagem}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            console.log(`[${tipo.toUpperCase()}] ${mensagem}`);
        }
        
        function limparTeste() {
            document.getElementById('log-container').innerHTML = '<div class="info">üßπ Log limpo...</div>';
        }
        
        // Simular fun√ß√µes que existem na aplica√ß√£o real
        function atualizarNumerosSorteados() {
            log('üîÑ atualizarNumerosSorteados() executada', 'info');
        }
        
        function atualizarCartelas() {
            log('üé´ atualizarCartelas() executada', 'info');
        }
        
        function verificarStatusCartelas() {
            log('üîç verificarStatusCartelas() executada', 'info');
        }
        
        // Fun√ß√£o de notifica√ß√£o melhorada
        function mostrarNotificacao(mensagem, tipo = 'info') {
            log(`üì¢ Notifica√ß√£o: ${mensagem} (${tipo})`, tipo);
            
            // Criar notifica√ß√£o visual
            const notificacao = document.createElement('div');
            notificacao.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${tipo === 'sucesso' ? '#4CAF50' : tipo === 'erro' ? '#f44336' : '#FF9800'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: bold;
                animation: slideIn 0.3s ease-out;
            `;
            notificacao.innerHTML = `
                ${mensagem}
                <button onclick="this.parentElement.remove()" style="
                    background: none;
                    border: none;
                    color: white;
                    font-size: 18px;
                    font-weight: bold;
                    cursor: pointer;
                    margin-left: 10px;
                ">√ó</button>
            `;
            document.body.appendChild(notificacao);
            
            setTimeout(() => {
                if (notificacao.parentNode) {
                    notificacao.remove();
                }
            }, 4000);
        }
        
        // Fun√ß√£o principal do teste - replica a fun√ß√£o corrigida
        async function testarBotaoAtualizar() {
            log('üß™ INICIANDO TESTE DO BOT√ÉO ATUALIZAR', 'info');
            
            const btnAtualizar = document.querySelector('.btn-atualizar');
            if (!btnAtualizar) {
                log('‚ùå Bot√£o atualizar n√£o encontrado', 'error');
                return;
            }
            
            const textoOriginal = btnAtualizar.textContent;
            btnAtualizar.textContent = 'üîÑ Testando...';
            btnAtualizar.disabled = true;
            
            try {
                // Aguardar Firebase estar pronto
                let servicoFirebase = window.firebaseService;
                
                if (!servicoFirebase) {
                    log('‚è≥ Aguardando Firebase estar pronto...', 'warning');
                    if (typeof window.waitForFirebase === 'function') {
                        servicoFirebase = await window.waitForFirebase(10000);
                        log('‚úÖ Firebase carregado com sucesso', 'success');
                    } else {
                        throw new Error('Firebase n√£o est√° dispon√≠vel');
                    }
                }
                
                if (!servicoFirebase) {
                    throw new Error('N√£o foi poss√≠vel conectar ao Firebase');
                }
                
                log('‚úÖ Firebase conectado, testando carregamento de dados...', 'success');
                
                // Testar carregamento de n√∫meros sorteados
                const numerosSorteadosCarregados = await servicoFirebase.carregarNumerosSorteados();
                log(`‚úÖ N√∫meros sorteados carregados: [${numerosSorteadosCarregados.join(', ')}]`, 'success');
                
                // Atualizar vari√°veis
                numerosSorteados = numerosSorteadosCarregados;
                atualizarNumerosSorteados();
                
                // Testar carregamento de cartelas se comprador estiver logado
                if (compradorAtual && compradorAtual.telefone) {
                    log(`üîÑ Testando carregamento de cartelas para ${compradorAtual.nome}...`, 'info');
                    const cartelas = await servicoFirebase.carregarCartelasPorComprador(
                        compradorAtual.telefone, 
                        compradorAtual.email
                    );
                    
                    if (cartelas && cartelas.length > 0) {
                        cartelasComprador = cartelas;
                        log(`‚úÖ ${cartelas.length} cartelas carregadas`, 'success');
                        atualizarCartelas();
                        verificarStatusCartelas();
                    } else {
                        log('‚ö†Ô∏è Nenhuma cartela encontrada para este comprador', 'warning');
                    }
                } else {
                    log('‚ö†Ô∏è Nenhum comprador logado para testar cartelas', 'warning');
                }
                
                log('üéâ TESTE CONCLU√çDO COM SUCESSO!', 'success');
                mostrarNotificacao('‚úÖ Teste do bot√£o atualizar passou!', 'sucesso');
                
            } catch (error) {
                log(`‚ùå ERRO NO TESTE: ${error.message}`, 'error');
                if (error.stack) {
                    log(`üìç Stack: ${error.stack}`, 'error');
                }
                mostrarNotificacao(`‚ùå Teste falhou: ${error.message}`, 'erro');
            } finally {
                setTimeout(() => {
                    btnAtualizar.textContent = textoOriginal;
                    btnAtualizar.disabled = false;
                    log('üîÑ Bot√£o restaurado', 'info');
                }, 1000);
            }
        }
        
        function simularCompradorLogado() {
            compradorAtual = {
                nome: 'Jo√£o da Silva',
                telefone: '85987654321',
                email: 'joao@teste.com'
            };
            
            log(`üë§ Comprador simulado: ${compradorAtual.nome} (${compradorAtual.telefone})`, 'info');
            mostrarNotificacao('üë§ Comprador simulado com sucesso', 'sucesso');
        }
        
        async function verificarSistema() {
            log('üîç VERIFICANDO SISTEMA COMPLETO...', 'info');
            
            // Verificar Firebase
            const statusFirebase = document.getElementById('status-firebase');
            if (typeof firebase !== 'undefined') {
                statusFirebase.innerHTML = '‚úÖ Firebase carregado';
                statusFirebase.className = 'success';
                log('‚úÖ Firebase SDK carregado', 'success');
            } else {
                statusFirebase.innerHTML = '‚ùå Firebase n√£o carregado';
                statusFirebase.className = 'error';
                log('‚ùå Firebase SDK n√£o encontrado', 'error');
            }
            
            // Verificar FirebaseService
            const statusFuncoes = document.getElementById('status-funcoes');
            setTimeout(() => {
                if (window.firebaseService) {
                    statusFuncoes.innerHTML = '‚úÖ FirebaseService pronto';
                    statusFuncoes.className = 'success';
                    log('‚úÖ FirebaseService dispon√≠vel', 'success');
                } else {
                    statusFuncoes.innerHTML = '‚è≥ Aguardando FirebaseService...';
                    statusFuncoes.className = 'warning';
                    log('‚ö†Ô∏è FirebaseService ainda n√£o est√° pronto', 'warning');
                }
            }, 2000);
            
            // Verificar dados
            const statusDados = document.getElementById('status-dados');
            if (compradorAtual) {
                statusDados.innerHTML = `‚úÖ Comprador: ${compradorAtual.nome}`;
                statusDados.className = 'success';
            } else {
                statusDados.innerHTML = '‚ö†Ô∏è Nenhum comprador logado';
                statusDados.className = 'warning';
            }
        }
        
        // Adicionar anima√ß√£o CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Inicializa√ß√£o autom√°tica
        document.addEventListener('DOMContentLoaded', () => {
            log('üìÑ P√°gina de teste carregada', 'info');
            setTimeout(verificarSistema, 1000);
        });
    </script>
</body>
</html>
