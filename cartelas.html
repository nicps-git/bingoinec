<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé´ Comprar Cartelas - Bingo Arrai√° INEC</title>
    <link rel="stylesheet" href="cartelas.css">
    
    <!-- Script inline para fun√ß√£o cr√≠tica -->
    <script>
        console.log('üéØ Definindo gerarCartela inline...');
        
        function gerarCartela() {
            console.log('üé≤ gerarCartela chamada (inline)!');
            
            // Se o script principal ainda n√£o carregou, usar fun√ß√£o simples
            if (typeof window.gerarCartelaCompleta === 'function') {
                window.gerarCartelaCompleta();
            } else {
                console.log('üìã Usando fun√ß√£o simples...');
                gerarCartelaSimples();
            }
        }
        
        function gerarCartelaSimples() {
            console.log('üé≤ Gerando cartela simples com 24 n√∫meros...');
            
            try {
                // Gerar 24 n√∫meros √∫nicos
                const numeros = [];
                const disponiveis = [];
                
                // Criar array de 1 a 75
                for (let i = 1; i <= 75; i++) {
                    disponiveis.push(i);
                }
                
                // Escolher 24 n√∫meros √∫nicos
                for (let i = 0; i < 24; i++) {
                    const indice = Math.floor(Math.random() * disponiveis.length);
                    numeros.push(disponiveis.splice(indice, 1)[0]);
                }
                numeros.sort((a, b) => a - b);
                
                const container = document.getElementById('cartela-preview');
                if (container) {
                    container.innerHTML = `
                        <div style="background: white; color: black; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            <h3 style="margin: 0 0 15px 0; text-align: center;">üé´ Cartela ${Date.now().toString().slice(-6)} (${numeros.length} n√∫meros)</h3>
                            
                            <!-- Header BINGO -->
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin: 10px 0;">
                                <div style="background: #e74c3c; color: white; text-align: center; font-size: 1.2em; font-weight: bold; padding: 8px; border-radius: 5px;">B</div>
                                <div style="background: #e74c3c; color: white; text-align: center; font-size: 1.2em; font-weight: bold; padding: 8px; border-radius: 5px;">I</div>
                                <div style="background: #e74c3c; color: white; text-align: center; font-size: 1.2em; font-weight: bold; padding: 8px; border-radius: 5px;">N</div>
                                <div style="background: #e74c3c; color: white; text-align: center; font-size: 1.2em; font-weight: bold; padding: 8px; border-radius: 5px;">G</div>
                                <div style="background: #e74c3c; color: white; text-align: center; font-size: 1.2em; font-weight: bold; padding: 8px; border-radius: 5px;">O</div>
                            </div>
                            
                            <!-- Grid de n√∫meros -->
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin: 15px 0;">
                                ${numeros.slice(0, 12).map(num => 
                                    `<div style="background: #4CAF50; color: white; padding: 12px; text-align: center; border-radius: 5px; font-weight: bold; font-size: 16px;">${num}</div>`
                                ).join('')}
                                <div style="background: #f39c12; color: white; padding: 12px; text-align: center; border-radius: 5px; font-weight: bold; font-size: 14px;">‚≠ê<br>LIVRE</div>
                                ${numeros.slice(12).map(num => 
                                    `<div style="background: #4CAF50; color: white; padding: 12px; text-align: center; border-radius: 5px; font-weight: bold; font-size: 16px;">${num}</div>`
                                ).join('')}
                            </div>
                            
                            <p style="text-align: center; margin: 15px 0 0 0; font-size: 18px; font-weight: bold;">
                                üí∞ Pre√ßo: R$ 5,00 | üéØ ${numeros.length} n√∫meros
                            </p>
                        </div>
                    `;
                    
                    // Habilitar bot√£o comprar
                    const btnComprar = document.getElementById('comprar-cartela');
                    if (btnComprar) {
                        btnComprar.disabled = false;
                        btnComprar.textContent = 'üõí Adicionar ao Carrinho';
                    }
                    
                    console.log('‚úÖ Cartela simples gerada com sucesso!');
                } else {
                    console.error('‚ùå Container n√£o encontrado');
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert('Erro: ' + error.message);
            }
        }
        
        function adicionarAoCarrinho() {
            console.log('üõí adicionarAoCarrinho chamada!');
            
            // Se o script principal carregou, usar fun√ß√£o completa
            if (typeof window.adicionarAoCarrinhoCompleta === 'function' && typeof window.carrinho !== 'undefined') {
                window.adicionarAoCarrinhoCompleta();
            } else {
                console.log('üìã Usando fun√ß√£o simples...');
                adicionarAoCarrinhoSimples();
            }
        }
        
        function adicionarAoCarrinhoSimples() {
            console.log('üõí Adicionando ao carrinho (simples)...');
            
            // Verificar se h√° cartela gerada
            const preview = document.getElementById('cartela-preview');
            if (!preview || !preview.innerHTML.includes('Cartela')) {
                alert('Gere uma cartela primeiro!');
                return;
            }
            
            // Simular adi√ß√£o ao carrinho
            const carrinhoCont = document.getElementById('carrinho-lista');
            const totalCont = document.getElementById('carrinho-total');
            
            if (carrinhoCont && totalCont) {
                // Contar cartelas no carrinho
                const itens = carrinhoCont.querySelectorAll('.item-carrinho').length;
                const novoItem = itens + 1;
                const novoTotal = novoItem * 5.00;
                
                // Adicionar item
                if (itens === 0 || carrinhoCont.innerHTML.includes('Carrinho vazio')) {
                    carrinhoCont.innerHTML = '';
                }
                
                carrinhoCont.innerHTML += `
                    <div class="item-carrinho" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                        <span>Cartela ${novoItem}</span>
                        <span>R$ 5,00</span>
                        <button onclick="removerItem(this)" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">‚ùå</button>
                    </div>
                `;
                
                // Atualizar total
                totalCont.textContent = `R$ ${novoTotal.toFixed(2)}`;
                
                // Habilitar bot√£o finalizar
                const btnFinalizar = document.getElementById('finalizar-compra');
                if (btnFinalizar) {
                    btnFinalizar.disabled = false;
                }
                
                // Limpar preview
                preview.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><p>Clique em "Gerar Cartela" para ver sua cartela</p></div>';
                
                // Desabilitar bot√£o comprar
                const btnComprar = document.getElementById('comprar-cartela');
                if (btnComprar) {
                    btnComprar.disabled = true;
                    btnComprar.textContent = 'üí≥ Comprar Esta Cartela';
                }
                
                console.log('‚úÖ Cartela adicionada ao carrinho!');
                
                // Sincronizar com carrinho global se dispon√≠vel
                if (typeof window.carrinho !== 'undefined' && typeof window.atualizarCarrinho === 'function') {
                    // Criar objeto cartela para o carrinho global
                    const cartela = {
                        id: `CART-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                        // Gerar 24 n√∫meros √∫nicos
                        numeros: (() => {
                            const numerosUnicos = [];
                            const disponiveis = Array.from({length: 75}, (_, i) => i + 1);
                            for (let j = 0; j < 24; j++) {
                                const indice = Math.floor(Math.random() * disponiveis.length);
                                numerosUnicos.push(disponiveis.splice(indice, 1)[0]);
                            }
                            return numerosUnicos.sort((a, b) => a - b);
                        })(),
                        preco: 5.00,
                        status: 'no-carrinho'
                    };
                    
                    window.carrinho.push(cartela);
                    window.atualizarCarrinho();
                }
            }
        }
        
        function removerItem(button) {
            console.log('üóëÔ∏è Removendo item...');
            const item = button.parentElement;
            item.remove();
            
            // Atualizar numera√ß√£o e total
            const carrinhoCont = document.getElementById('carrinho-lista');
            const totalCont = document.getElementById('carrinho-total');
            const itens = carrinhoCont.querySelectorAll('.item-carrinho');
            
            if (itens.length === 0) {
                carrinhoCont.innerHTML = '<p class="carrinho-vazio">Carrinho vazio</p>';
                totalCont.textContent = 'R$ 0,00';
                
                // Desabilitar bot√£o finalizar
                const btnFinalizar = document.getElementById('finalizar-compra');
                if (btnFinalizar) {
                    btnFinalizar.disabled = true;
                }
            } else {
                // Renumerar itens
                itens.forEach((item, index) => {
                    const span = item.querySelector('span:first-child');
                    span.textContent = `Cartela ${index + 1}`;
                });
                
                // Atualizar total
                const novoTotal = itens.length * 5.00;
                totalCont.textContent = `R$ ${novoTotal.toFixed(2)}`;
            }
        }
        
        function limparCarrinho() {
            console.log('üßπ Limpando carrinho...');
            
            const carrinhoCont = document.getElementById('carrinho-lista');
            const totalCont = document.getElementById('carrinho-total');
            
            if (carrinhoCont && totalCont) {
                carrinhoCont.innerHTML = '<p class="carrinho-vazio">Carrinho vazio</p>';
                totalCont.textContent = 'R$ 0,00';
                
                // Desabilitar bot√£o finalizar
                const btnFinalizar = document.getElementById('finalizar-compra');
                if (btnFinalizar) {
                    btnFinalizar.disabled = true;
                }
                
                // Sincronizar com carrinho global se dispon√≠vel
                if (typeof window.carrinho !== 'undefined') {
                    window.carrinho.length = 0; // Limpar array
                    if (typeof window.atualizarCarrinho === 'function') {
                        window.atualizarCarrinho();
                    }
                }
                
                console.log('‚úÖ Carrinho limpo!');
            }
        }
        
        function abrirModal() {
            console.log('üí≥ Abrindo modal...');
            
            // Verificar se h√° itens no carrinho
            const carrinhoCont = document.getElementById('carrinho-lista');
            const itens = carrinhoCont.querySelectorAll('.item-carrinho');
            
            if (itens.length === 0) {
                alert('Carrinho vazio!');
                return;
            }
            
            // Se fun√ß√£o completa dispon√≠vel, usar
            if (typeof window.abrirModalCompleto === 'function') {
                window.abrirModalCompleto();
            } else {
                // Vers√£o funcional do modal
                console.log('üí≥ Abrindo modal (vers√£o inline)...');
                
                const modal = document.getElementById('modal-checkout');
                if (modal) {
                    modal.style.display = 'block';
                    
                    // Atualizar resumo da compra
                    const resumoCartelas = document.getElementById('resumo-cartelas');
                    const totalFinal = document.getElementById('total-final');
                    
                    if (resumoCartelas && totalFinal) {
                        const numeroCartelas = itens.length;
                        const total = numeroCartelas * 5.00;
                        
                        resumoCartelas.innerHTML = `
                            <p>${numeroCartelas} cartela(s) selecionada(s)</p>
                            ${Array.from(itens).map((item, index) => 
                                `<p>Cartela ${index + 1}: R$ 5,00</p>`
                            ).join('')}
                        `;
                        
                        totalFinal.textContent = `R$ ${total.toFixed(2)}`;
                    }
                    
                    console.log('‚úÖ Modal aberto');
                }
            }
        }
        
        function fecharCheckout() {
            console.log('‚ùå Fechando modal...');
            const modal = document.getElementById('modal-checkout');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Configurar eventos do modal quando DOM carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Configurando eventos do modal...');
            
            // Fechar modal ao clicar no X
            const closeBtn = document.querySelector('.modal .close');
            if (closeBtn) {
                closeBtn.onclick = fecharCheckout;
            }
            
            // Fechar modal ao clicar fora
            const modal = document.getElementById('modal-checkout');
            if (modal) {
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        fecharCheckout();
                    }
                };
            }
            
            // Configurar form de checkout
            const form = document.getElementById('form-checkout');
            if (form) {
                form.onsubmit = function(e) {
                    e.preventDefault();
                    console.log('üìù Form submetido...');
                    console.log('üîç Verificando window.processarCompraCompleta:', typeof window.processarCompraCompleta);
                    
                    if (typeof window.processarCompraCompleta === 'function') {
                        console.log('‚úÖ Chamando window.processarCompraCompleta');
                        window.processarCompraCompleta(e);
                    } else {
                        console.log('‚ùå window.processarCompraCompleta n√£o dispon√≠vel, usando fallback');
                        processarCompraSimples(e);
                    }
                };
                console.log('‚úÖ Form configurado');
            }
        });
        
        // Fun√ß√£o para verificar acesso admin (inline para garantir disponibilidade)
        function verificarAcessoAdmin() {
            console.log('üîê Redirecionando para √°rea administrativa...');
            window.location.href = 'admin.html';
        }
        
        function processarCompraSimples(event) {
            console.log('üí∞ Processando compra (vers√£o simples)...');
            
            const form = event.target;
            const nome = form.querySelector('#nome-comprador').value;
            const telefone = form.querySelector('#telefone-comprador').value;
            
            if (!nome.trim()) {
                alert('Nome √© obrigat√≥rio!');
                return;
            }
            
            if (!telefone.trim()) {
                alert('Telefone √© obrigat√≥rio!');
                return;
            }
            
            // TENTAR USAR FIREBASE SE DISPON√çVEL
            if (window.FirebaseDB && typeof window.FirebaseDB.saveCartela === 'function') {
                console.log('üî• Firebase dispon√≠vel, tentando usar m√©todo real...');
                
                // Obter cartelas do carrinho (interface)
                const carrinhoCont = document.getElementById('carrinho-lista');
                const itens = carrinhoCont.querySelectorAll('.item-carrinho');
                
                if (itens.length === 0) {
                    alert('Carrinho vazio!');
                    return;
                }
                
                const btn = form.querySelector('button[type="submit"]');
                const textoOriginal = btn.textContent;
                btn.textContent = '‚è≥ Salvando no Firebase...';
                btn.disabled = true;
                
                // Processar cada cartela
                const promessas = [];
                
                itens.forEach((item, index) => {
                    const cartela = {
                        id: `SIMPLE-${Date.now()}-${index + 1}`,
                        // Gerar 24 n√∫meros √∫nicos
                        numeros: (() => {
                            const numerosUnicos = [];
                            const disponiveis = Array.from({length: 75}, (_, i) => i + 1);
                            for (let j = 0; j < 24; j++) {
                                const indice = Math.floor(Math.random() * disponiveis.length);
                                numerosUnicos.push(disponiveis.splice(indice, 1)[0]);
                            }
                            return numerosUnicos.sort((a, b) => a - b);
                        })(),
                        preco: 5.00,
                        status: 'vendida',
                        comprador: {
                            nome: nome.trim(),
                            telefone: telefone.trim()
                        },
                        nome: nome.trim(),
                        telefone: telefone.trim(),
                        dataCompra: new Date(),
                        timestamp: Date.now()
                    };
                    
                    promessas.push(window.FirebaseDB.saveCartela(cartela));
                });
                
                Promise.all(promessas)
                    .then(resultados => {
                        console.log('‚úÖ Todas as cartelas salvas:', resultados);
                        alert(`‚úÖ ${resultados.length} cartela(s) salva(s) no Firebase com sucesso!`);
                        
                        // Limpar carrinho
                        limparCarrinho();
                        
                        // Fechar modal
                        fecharCheckout();
                        
                        // Resetar form
                        form.reset();
                        btn.textContent = textoOriginal;
                        btn.disabled = false;
                    })
                    .catch(error => {
                        console.error('‚ùå Erro ao salvar cartelas:', error);
                        alert(`‚ùå Erro ao salvar no Firebase: ${error.message}`);
                        
                        btn.textContent = textoOriginal;
                        btn.disabled = false;
                    });
                
                return;
            }
            
            // Fallback: Simular processamento
            console.log('‚ö†Ô∏è Firebase n√£o dispon√≠vel, usando simula√ß√£o...');
            const btn = form.querySelector('button[type="submit"]');
            const textoOriginal = btn.textContent;
            btn.textContent = '‚è≥ Processando...';
            btn.disabled = true;
            
            setTimeout(() => {
                alert(`‚úÖ Compra registrada!\n\nDados:\nNome: ${nome}\nTelefone: ${telefone}\n\nObrigado pela compra!`);
                
                // Limpar carrinho
                limparCarrinho();
                
                // Fechar modal
                fecharCheckout();
                
                // Resetar form
                form.reset();
                btn.textContent = textoOriginal;
                btn.disabled = false;
            }, 2000);
        }
    </script>
    
    <!-- Firebase SDK v8 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
    
    <script src="login.js"></script>
    <script src="cartelas.js"></script>
</head>
<body>
    <!-- Bandeirolas -->
    <div class="bandeirolas">
        <div class="bandeirola bandeirola-1"></div>
        <div class="bandeirola bandeirola-2"></div>
        <div class="bandeirola bandeirola-3"></div>
        <div class="bandeirola bandeirola-4"></div>
        <div class="bandeirola bandeirola-5"></div>
        <div class="bandeirola bandeirola-6"></div>
        <div class="bandeirola bandeirola-7"></div>
        <div class="bandeirola bandeirola-8"></div>
        <div class="bandeirola bandeirola-9"></div>
        <div class="bandeirola bandeirola-10"></div>
    </div>

    <header>
        <div class="logo-empresa">
            <img src="inec.png" alt="Logo INEC" class="logo-inec">
        </div>
        <div class="nav-links">
            <a href="index.html" class="btn-nav">üé™ Bingo</a>
            <a href="minhas-cartelas.html" class="btn-nav">üëÄ Minhas Cartelas</a>
            <a href="#" onclick="verificarAcessoAdmin()" class="btn-nav">‚öôÔ∏è Admin</a>
        </div>
        <div class="chapeu-palha">üëí</div>
        <h1>üé´ Comprar Cartelas</h1>
        <p>üéä Adquira suas cartelas para o Arrai√° INEC!</p>
    </header>

    <main>
        <div class="compra-container">
            <div class="info-section">
                <h2>üí∞ Informa√ß√µes</h2>
                <div class="preco-info">
                    <span class="label">Pre√ßo por cartela:</span>
                    <span id="preco-cartela" class="preco">R$ 5,00</span>
                </div>
                <div class="disponibilidade">
                    <span class="label">Cartelas dispon√≠veis:</span>
                    <span id="cartelas-disponiveis" class="quantidade">‚àû</span>
                </div>
            </div>

            <div class="preview-section">
                <h2>üéØ Sua Cartela</h2>
                <div id="cartela-preview" class="cartela-preview">
                    <div class="cartela-vazia">
                        <p>Clique em "Gerar Cartela" para ver sua cartela</p>
                    </div>
                </div>
                <div class="preview-actions">
                    <button id="gerar-preview" class="btn-primary" onclick="gerarCartela(); return false;">üé≤ Gerar Nova Cartela</button>
                    <button id="comprar-cartela" class="btn-success" disabled onclick="adicionarAoCarrinho(); return false;">üí≥ Comprar Esta Cartela</button>
                </div>
            </div>

            <div class="carrinho-section">
                <h2>üõí Carrinho</h2>
                <div id="carrinho-lista" class="carrinho-lista">
                    <p class="carrinho-vazio">Carrinho vazio</p>
                </div>
                <div class="carrinho-total">
                    <span class="label">Total:</span>
                    <span id="carrinho-total" class="total">R$ 0,00</span>
                </div>
                <div class="carrinho-actions">
                    <button id="finalizar-compra" class="btn-success" disabled onclick="abrirModal(); return false;">üéâ Finalizar Compra</button>
                    <button id="limpar-carrinho" class="btn-danger" onclick="limparCarrinho(); return false;">üóëÔ∏è Limpar Carrinho</button>
                </div>
            </div>
        </div>

        <!-- Modal de Finaliza√ß√£o -->
        <div id="modal-checkout" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>üí≥ Finalizar Compra</h3>
                <form id="form-checkout">
                    <div class="input-group">
                        <label for="nome-comprador">Nome Completo:</label>
                        <input type="text" id="nome-comprador" name="nome" required>
                    </div>
                    <div class="input-group">
                        <label for="telefone-comprador">Telefone:</label>
                        <input type="tel" id="telefone-comprador" name="telefone" required>
                    </div>
                    <div class="resumo-compra">
                        <h4>Resumo da Compra:</h4>
                        <div id="resumo-cartelas"></div>
                        <div class="total-final">
                            <strong>Total: <span id="total-final">R$ 0,00</span></strong>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-success">‚úÖ Confirmar Compra</button>
                        <button type="button" class="btn-secondary" onclick="fecharCheckout()">‚ùå Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Elementos decorativos -->
    <div class="fogueira">
        <div class="fogo"></div>
        <div class="lenha"></div>
    </div>

    <div class="estrelas">
        <div class="estrela estrela-1">‚≠ê</div>
        <div class="estrela estrela-2">‚ú®</div>
        <div class="estrela estrela-3">‚≠ê</div>
        <div class="estrela estrela-4">‚ú®</div>
        <div class="estrela estrela-5">‚≠ê</div>
    </div>
</body>
</html>
