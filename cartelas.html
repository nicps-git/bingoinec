<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé´ Comprar Cartelas - Bingo Arrai√° INEC</title>
    <link rel="stylesheet" href="cartelas.css">
    <link rel="stylesheet" href="auth-styles.css">
    
    <!-- Script inline para fun√ß√£o cr√≠tica -->
    <script>
        console.log('üéØ Definindo gerarCartela inline...');
        
        // FUN√á√ÉO CR√çTICA: Extrair n√∫meros da cartela exibida na interface
        function extrairNumerosDoPreview() {
            console.log('üîç Extraindo n√∫meros da cartela exibida...');
            
            try {
                const container = document.getElementById('cartela-preview');
                if (!container) {
                    console.warn('‚ö†Ô∏è Container cartela-preview n√£o encontrado');
                    return window.numerosCartelaAtual || [];
                }
                
                // Buscar todos os elementos que cont√™m n√∫meros (exceto o LIVRE)
                const elementosNumeros = container.querySelectorAll('[style*="background: #4CAF50"]');
                const numeros = [];
                
                elementosNumeros.forEach(elemento => {
                    const numero = parseInt(elemento.textContent.trim());
                    if (!isNaN(numero) && numero >= 1 && numero <= 75) {
                        numeros.push(numero);
                    }
                });
                
                // Se n√£o conseguiu extrair da interface, usar vari√°vel global como fallback
                if (numeros.length === 0 && window.numerosCartelaAtual) {
                    console.log('üìã Usando n√∫meros da vari√°vel global como fallback');
                    return window.numerosCartelaAtual;
                }
                
                console.log(`üìã ${numeros.length} n√∫meros extra√≠dos:`, numeros.sort((a, b) => a - b));
                return numeros.sort((a, b) => a - b);
                
            } catch (error) {
                console.error('‚ùå Erro ao extrair n√∫meros:', error);
                return window.numerosCartelaAtual || [];
            }
        }
        
        async function gerarCartela() {
            console.log('üé≤ gerarCartela chamada (inline)!');
            
            try {
                // Verifica√ß√£o b√°sica do Firebase
                if (!window.FirebaseDB && typeof firebase === 'undefined') {
                    alert('‚ùå Sistema indispon√≠vel: Firebase n√£o est√° carregado. Aguarde um momento e tente novamente.');
                    console.error('‚ùå Firebase n√£o dispon√≠vel para gera√ß√£o de cartela');
                    return;
                }
                
                // Tentar usar fun√ß√£o corrigida primeiro
                if (typeof window.gerarCartelaCorrigida === 'function') {
                    console.log('‚úÖ Usando fun√ß√£o com reserva tempor√°ria no Firebase!');
                    await window.gerarCartelaCorrigida();
                    return;
                }
                
                // Aguardar fun√ß√£o carregar (m√°ximo 5 segundos)
                console.log('‚è≥ Fun√ß√£o corrigida n√£o encontrada, aguardando carregamento...');
                let tentativas = 0;
                const maxTentativas = 25; // 5 segundos (25 x 200ms)
                
                while (typeof window.gerarCartelaCorrigida !== 'function' && tentativas < maxTentativas) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    tentativas++;
                    console.log(`‚è≥ Aguardando... ${tentativas}/${maxTentativas}`);
                }
                
                if (typeof window.gerarCartelaCorrigida === 'function') {
                    console.log('‚úÖ Fun√ß√£o encontrada ap√≥s aguardar - executando...');
                    await window.gerarCartelaCorrigida();
                    return;
                }
                
                // Se ainda n√£o encontrou, usar fun√ß√£o simples como backup
                console.warn('‚ö†Ô∏è Fun√ß√£o principal n√£o carregou, usando gera√ß√£o simples');
                gerarCartelaSimples();
                
            } catch (error) {
                console.error('‚ùå Erro em gerarCartela:', error);
                alert(`‚ùå Erro ao gerar cartela: ${error.message}`);
            }
        }
        
        function gerarCartelaSimples() {
            console.log('üé≤ Gerando cartela com PADR√ÉO BINGO...');
            
            try {
                // Gerar n√∫meros seguindo o padr√£o BINGO tradicional
                const colunasBingo = {
                    'B': { min: 1, max: 15, count: 5, numeros: [] },
                    'I': { min: 16, max: 30, count: 5, numeros: [] },
                    'N': { min: 31, max: 45, count: 4, numeros: [] }, // 4 n√∫meros + LIVRE
                    'G': { min: 46, max: 60, count: 5, numeros: [] },
                    'O': { min: 61, max: 75, count: 5, numeros: [] }
                };
                
                // Gerar n√∫meros para cada coluna
                for (const [coluna, config] of Object.entries(colunasBingo)) {
                    const numerosDisponiveis = [];
                    for (let i = config.min; i <= config.max; i++) {
                        numerosDisponiveis.push(i);
                    }
                    
                    for (let i = 0; i < config.count; i++) {
                        const indice = Math.floor(Math.random() * numerosDisponiveis.length);
                        const numeroEscolhido = numerosDisponiveis.splice(indice, 1)[0];
                        config.numeros.push(numeroEscolhido);
                    }
                    
                    config.numeros.sort((a, b) => a - b);
                }
                
                // Criar grid 5x5 respeitando as posi√ß√µes corretas
                const grid = [];
                for (let linha = 0; linha < 5; linha++) {
                    const linhaGrid = [];
                    
                    // Coluna B
                    linhaGrid.push(colunasBingo.B.numeros[linha] || null);
                    
                    // Coluna I
                    linhaGrid.push(colunasBingo.I.numeros[linha] || null);
                    
                    // Coluna N (posi√ß√£o 2,2 √© sempre LIVRE)
                    if (linha === 2) {
                        linhaGrid.push('LIVRE');
                    } else if (linha < 2) {
                        linhaGrid.push(colunasBingo.N.numeros[linha] || null);
                    } else {
                        linhaGrid.push(colunasBingo.N.numeros[linha - 1] || null);
                    }
                    
                    // Coluna G
                    linhaGrid.push(colunasBingo.G.numeros[linha] || null);
                    
                    // Coluna O
                    linhaGrid.push(colunasBingo.O.numeros[linha] || null);
                    
                    grid.push(linhaGrid);
                }
                
                // Criar array dos n√∫meros para compatibilidade
                const numerosCartela = [];
                Object.values(colunasBingo).forEach(coluna => {
                    numerosCartela.push(...coluna.numeros);
                });
                numerosCartela.sort((a, b) => a - b);
                
                // Criar cartela
                const cartela = {
                    id: `SIMPL-${Date.now()}`,
                    numeros: numerosCartela,
                    colunasBingo: colunasBingo,
                    grid: grid,
                    preco: 5.00,
                    status: 'preview'
                };
                
                // Armazenar globalmente
                window.numerosCartelaAtual = numerosCartela;
                window.cartelaAtual = cartela;
                console.log('üíæ Cartela simples armazenada:', cartela);
                
                // Gerar HTML da cartela
                const gridHTML = grid.map(linha => 
                    linha.map(celula => {
                        if (celula === 'LIVRE') {
                            return `<div style="background: #f39c12; color: white; padding: 12px; text-align: center; border-radius: 5px; font-weight: bold; font-size: 14px;">‚≠ê<br>LIVRE</div>`;
                        } else if (celula !== null) {
                            return `<div style="background: #4CAF50; color: white; padding: 12px; text-align: center; border-radius: 5px; font-weight: bold; font-size: 16px;">${celula}</div>`;
                        } else {
                            return `<div style="background: #ccc; color: #666; padding: 12px; text-align: center; border-radius: 5px; font-weight: bold; font-size: 16px;">-</div>`;
                        }
                    }).join('')
                ).join('');
                
                const container = document.getElementById('cartela-preview');
                if (container) {
                    container.innerHTML = `
                        <div style="background: white; color: black; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            <h3 style="margin: 0 0 15px 0; text-align: center;">üé´ Cartela ${cartela.id.substring(6, 12)}</h3>
                            
                            <!-- Status -->
                            <div style="background: #17a2b8; color: white; padding: 8px; border-radius: 5px; text-align: center; margin-bottom: 15px; font-weight: bold;">
                                üéØ Padr√£o BINGO Simplificado
                            </div>
                            
                            <!-- Header BINGO -->
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin: 10px 0;">
                                <div style="background: #e74c3c; color: white; text-align: center; font-size: 1.2em; font-weight: bold; padding: 8px; border-radius: 5px;">B</div>
                                <div style="background: #e74c3c; color: white; text-align: center; font-size: 1.2em; font-weight: bold; padding: 8px; border-radius: 5px;">I</div>
                                <div style="background: #e74c3c; color: white; text-align: center; font-size: 1.2em; font-weight: bold; padding: 8px; border-radius: 5px;">N</div>
                                <div style="background: #e74c3c; color: white; text-align: center; font-size: 1.2em; font-weight: bold; padding: 8px; border-radius: 5px;">G</div>
                                <div style="background: #e74c3c; color: white; text-align: center; font-size: 1.2em; font-weight: bold; padding: 8px; border-radius: 5px;">O</div>
                            </div>
                            
                            <!-- Grid de n√∫meros -->
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin: 15px 0;">
                                ${gridHTML}
                            </div>
                            
                            <p style="text-align: center; margin: 15px 0 0 0; font-size: 18px; font-weight: bold;">
                                üí∞ Pre√ßo: R$ ${cartela.preco.toFixed(2)} | üéØ ${cartela.numeros.length} n√∫meros
                            </p>
                            
                            <!-- Informa√ß√µes das colunas -->
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; text-align: center;">
                                <strong>Distribui√ß√£o:</strong> 
                                B(1-15): ${colunasBingo.B.numeros.length} | 
                                I(16-30): ${colunasBingo.I.numeros.length} | 
                                N(31-45): ${colunasBingo.N.numeros.length} | 
                                G(46-60): ${colunasBingo.G.numeros.length} | 
                                O(61-75): ${colunasBingo.O.numeros.length}
                            </div>
                        </div>
                    `;
                    
                    // Habilitar bot√µes
                    const btnComprar = document.getElementById('comprar-cartela');
                    if (btnComprar) {
                        btnComprar.disabled = false;
                        btnComprar.textContent = 'üõí Adicionar ao Carrinho';
                    }
                    
                    const btnGerar = document.getElementById('gerar-cartela');
                    if (btnGerar) {
                        btnGerar.disabled = false;
                        btnGerar.textContent = 'üé≤ Gerar Nova Cartela';
                    }
                    
                    console.log('‚úÖ Cartela simples gerada com sucesso!');
                } else {
                    console.error('‚ùå Container n√£o encontrado');
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert('Erro: ' + error.message);
            }
        }
        
        async function adicionarAoCarrinho() {
            console.log('üõí adicionarAoCarrinho chamada!');
            
            try {
                // Verifica√ß√£o b√°sica
                if (!window.FirebaseDB && typeof firebase === 'undefined') {
                    alert('‚ùå Sistema indispon√≠vel: Firebase n√£o est√° carregado. Aguarde um momento e tente novamente.');
                    console.error('‚ùå Firebase n√£o dispon√≠vel para adi√ß√£o ao carrinho');
                    return;
                }
                
                // Verificar se h√° cartela
                if (!window.cartelaReservada && !window.numerosCartelaAtual) {
                    alert('‚ùå Nenhuma cartela foi gerada. Gere uma cartela primeiro.');
                    console.error('‚ùå Nenhuma cartela dispon√≠vel para adicionar ao carrinho');
                    return;
                }
                
                // Tentar usar fun√ß√£o corrigida primeiro
                if (typeof window.adicionarAoCarrinhoCorrigida === 'function') {
                    console.log('‚úÖ Usando fun√ß√£o de carrinho com reserva tempor√°ria!');
                    window.adicionarAoCarrinhoCorrigida();
                    return;
                }
                
                // Fallback: adicionar ao carrinho simples
                console.warn('‚ö†Ô∏è Usando fallback para adicionar ao carrinho...');
                adicionarAoCarrinhoFallback();
                
            } catch (error) {
                console.error('‚ùå Erro em adicionarAoCarrinho:', error);
                alert(`‚ùå Erro ao adicionar ao carrinho: ${error.message}`);
            }
        }
        
        function adicionarAoCarrinhoFallback() {
            console.log('üõí Adicionando ao carrinho (fallback)...');
            
            // Usar cartela reservada ou criar uma nova baseada nos n√∫meros atuais
            let cartela;
            if (window.cartelaReservada) {
                cartela = window.cartelaReservada;
            } else if (window.numerosCartelaAtual) {
                cartela = {
                    id: `CARR-${Date.now()}`,
                    numeros: window.numerosCartelaAtual,
                    preco: 5.00,
                    status: 'no-carrinho'
                };
            } else {
                alert('‚ùå Nenhuma cartela dispon√≠vel');
                return;
            }
            
            console.log('üíæ Cartela para carrinho:', cartela);
            
            // Adicionar ao carrinho global
            if (!window.carrinho) window.carrinho = [];
            window.carrinho.push(cartela);
            
            // Atualizar interface do carrinho
            atualizarCarrinhoInterface();
            
            // Limpar preview
            const container = document.getElementById('cartela-preview');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>üé´ Cartela adicionada ao carrinho!</p>
                        <p style="font-size: 12px; color: #28a745;">‚úÖ N√∫meros: [${cartela.numeros.join(', ')}]</p>
                        <p style="font-size: 12px;">Clique em "Gerar Cartela" para ver uma nova cartela</p>
                    </div>
                `;
            }
            
            // Desabilitar bot√£o
            const btnComprar = document.getElementById('comprar-cartela');
            if (btnComprar) {
                btnComprar.disabled = true;
                btnComprar.textContent = 'üí≥ Comprar Esta Cartela';
            }
            
            console.log('‚úÖ Cartela adicionada ao carrinho (fallback)');
        }
        
        function atualizarCarrinhoInterface() {
            const carrinhoCont = document.getElementById('carrinho-lista');
            const totalCont = document.getElementById('carrinho-total');
            
            if (!carrinhoCont || !totalCont || !window.carrinho) return;
            
            // Limpar carrinho vazio
            if (window.carrinho.length === 0) {
                carrinhoCont.innerHTML = '<p class="carrinho-vazio">Carrinho vazio</p>';
                totalCont.textContent = 'R$ 0,00';
                return;
            }
            
            // Atualizar itens
            carrinhoCont.innerHTML = '';
            window.carrinho.forEach((cartela, index) => {
                carrinhoCont.innerHTML += `
                    <div class="item-carrinho" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                        <span>Cartela ${index + 1}</span>
                        <span>R$ ${cartela.preco.toFixed(2)}</span>
                        <button onclick="removerItemCarrinho(${index})" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">‚ùå</button>
                    </div>
                `;
            });
            
            // Atualizar total
            const total = window.carrinho.reduce((sum, cartela) => sum + cartela.preco, 0);
            totalCont.textContent = `R$ ${total.toFixed(2)}`;
            
            // Habilitar bot√£o finalizar
            const btnFinalizar = document.getElementById('finalizar-compra');
            if (btnFinalizar) {
                btnFinalizar.disabled = false;
            }
        }
        
        function removerItemCarrinho(index) {
            if (window.carrinho && window.carrinho[index]) {
                window.carrinho.splice(index, 1);
                atualizarCarrinhoInterface();
                console.log(`üóëÔ∏è Item ${index} removido do carrinho`);
            }
        }
        
        function adicionarAoCarrinhoSimples() {
            console.log('üõí Adicionando ao carrinho (simples)...');
            
            // Verificar se h√° cartela gerada
            const preview = document.getElementById('cartela-preview');
            if (!preview || !preview.innerHTML.includes('Cartela')) {
                alert('Gere uma cartela primeiro!');
                return;
            }
            
            // Simular adi√ß√£o ao carrinho
            const carrinhoCont = document.getElementById('carrinho-lista');
            const totalCont = document.getElementById('carrinho-total');
            
            if (carrinhoCont && totalCont) {
                // Contar cartelas no carrinho
                const itens = carrinhoCont.querySelectorAll('.item-carrinho').length;
                const novoItem = itens + 1;
                const novoTotal = novoItem * 5.00;
                
                // Adicionar item
                if (itens === 0 || carrinhoCont.innerHTML.includes('Carrinho vazio')) {
                    carrinhoCont.innerHTML = '';
                }
                
                carrinhoCont.innerHTML += `
                    <div class="item-carrinho" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                        <span>Cartela ${novoItem}</span>
                        <span>R$ 5,00</span>
                        <button onclick="removerItem(this)" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">‚ùå</button>
                    </div>
                `;
                
                // Atualizar total
                totalCont.textContent = `R$ ${novoTotal.toFixed(2)}`;
                
                // Habilitar bot√£o finalizar
                const btnFinalizar = document.getElementById('finalizar-compra');
                if (btnFinalizar) {
                    btnFinalizar.disabled = false;
                }
                
                // Limpar preview
                preview.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><p>Clique em "Gerar Cartela" para ver sua cartela</p></div>';
                
                // Desabilitar bot√£o comprar
                const btnComprar = document.getElementById('comprar-cartela');
                if (btnComprar) {
                    btnComprar.disabled = true;
                    btnComprar.textContent = 'üí≥ Comprar Esta Cartela';
                }
                
                console.log('‚úÖ Cartela adicionada ao carrinho!');
                
                // CORRE√á√ÉO: Extrair n√∫meros reais da cartela exibida
                console.log('üîç Extraindo n√∫meros da cartela exibida...');
                
                // Extrair n√∫meros da interface exibida
                const numerosExibidos = extrairNumerosDoPreview();
                console.log('üìã N√∫meros extra√≠dos da interface:', numerosExibidos);
                
                // Sincronizar com carrinho global se dispon√≠vel
                if (typeof window.carrinho !== 'undefined' && typeof window.atualizarCarrinho === 'function') {
                    // Criar objeto cartela para o carrinho global usando os n√∫meros REAIS exibidos
                    const cartela = {
                        id: `CART-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                        numeros: numerosExibidos.length > 0 ? numerosExibidos : [], // Usar n√∫meros extra√≠dos
                        preco: 5.00,
                        status: 'no-carrinho'
                    };
                    
                    console.log('üíæ Cartela preparada para carrinho global:', cartela);
                    window.carrinho.push(cartela);
                    window.atualizarCarrinho();
                } else {
                    console.log('‚ö†Ô∏è Carrinho global n√£o dispon√≠vel, usando apenas interface simples');
                }
            }
        }
        
        function removerItem(button) {
            console.log('üóëÔ∏è Removendo item...');
            const item = button.parentElement;
            item.remove();
            
            // Atualizar numera√ß√£o e total
            const carrinhoCont = document.getElementById('carrinho-lista');
            const totalCont = document.getElementById('carrinho-total');
            const itens = carrinhoCont.querySelectorAll('.item-carrinho');
            
            if (itens.length === 0) {
                carrinhoCont.innerHTML = '<p class="carrinho-vazio">Carrinho vazio</p>';
                totalCont.textContent = 'R$ 0,00';
                
                // Desabilitar bot√£o finalizar
                const btnFinalizar = document.getElementById('finalizar-compra');
                if (btnFinalizar) {
                    btnFinalizar.disabled = true;
                }
            } else {
                // Renumerar itens
                itens.forEach((item, index) => {
                    const span = item.querySelector('span:first-child');
                    span.textContent = `Cartela ${index + 1}`;
                });
                
                // Atualizar total
                const novoTotal = itens.length * 5.00;
                totalCont.textContent = `R$ ${novoTotal.toFixed(2)}`;
            }
        }
        
        function limparCarrinho() {
            console.log('üßπ Limpando carrinho...');
            
            const carrinhoCont = document.getElementById('carrinho-lista');
            const totalCont = document.getElementById('carrinho-total');
            
            if (carrinhoCont && totalCont) {
                carrinhoCont.innerHTML = '<p class="carrinho-vazio">Carrinho vazio</p>';
                totalCont.textContent = 'R$ 0,00';
                
                // Desabilitar bot√£o finalizar
                const btnFinalizar = document.getElementById('finalizar-compra');
                if (btnFinalizar) {
                    btnFinalizar.disabled = true;
                }
                
                // Sincronizar com carrinho global se dispon√≠vel
                if (typeof window.carrinho !== 'undefined') {
                    window.carrinho.length = 0; // Limpar array
                    if (typeof window.atualizarCarrinho === 'function') {
                        window.atualizarCarrinho();
                    }
                }
                
                console.log('‚úÖ Carrinho limpo!');
            }
        }
        
        function abrirModal() {
            console.log('üí≥ Abrindo modal...');
            
            // Verificar se h√° itens no carrinho
            const carrinhoCont = document.getElementById('carrinho-lista');
            const itens = carrinhoCont.querySelectorAll('.item-carrinho');
            
            if (itens.length === 0) {
                alert('Carrinho vazio!');
                return;
            }
            
            // Se fun√ß√£o completa dispon√≠vel, usar
            if (typeof window.abrirModalCompleto === 'function') {
                window.abrirModalCompleto();
            } else {
                // Vers√£o funcional do modal
                console.log('üí≥ Abrindo modal (vers√£o inline)...');
                
                const modal = document.getElementById('modal-checkout');
                if (modal) {
                    modal.style.display = 'block';
                    
                    // Atualizar resumo da compra
                    const resumoCartelas = document.getElementById('resumo-cartelas');
                    const totalFinal = document.getElementById('total-final');
                    
                    if (resumoCartelas && totalFinal) {
                        const numeroCartelas = itens.length;
                        const total = numeroCartelas * 5.00;
                        
                        resumoCartelas.innerHTML = `
                            <p>${numeroCartelas} cartela(s) selecionada(s)</p>
                            ${Array.from(itens).map((item, index) => 
                                `<p>Cartela ${index + 1}: R$ 5,00</p>`
                            ).join('')}
                        `;
                        
                        totalFinal.textContent = `R$ ${total.toFixed(2)}`;
                    }
                    
                    console.log('‚úÖ Modal aberto');
                }
            }
        }
        
        function fecharCheckout() {
            console.log('‚ùå Fechando modal...');
            const modal = document.getElementById('modal-checkout');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Configurar eventos do modal quando DOM carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Configurando eventos do modal...');
            
            // Iniciar verifica√ß√£o do sistema
            setTimeout(() => {
                verificarSistemaCarregado();
            }, 1000);
            
            // Fechar modal ao clicar no X
            const closeBtn = document.querySelector('.modal .close');
            if (closeBtn) {
                closeBtn.onclick = fecharCheckout;
            }
            
            // Fechar modal ao clicar fora
            const modal = document.getElementById('modal-checkout');
            if (modal) {
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        fecharCheckout();
                    }
                };
            }
            
            // Configurar form de checkout
            const form = document.getElementById('form-checkout');
            if (form) {
                form.onsubmit = function(e) {
                    e.preventDefault();
                    console.log('üìù Form submetido...');
                    console.log('üîç Verificando window.processarCompraCompleta:', typeof window.processarCompraCompleta);
                    
                    if (typeof window.processarCompraCompleta === 'function') {
                        console.log('‚úÖ Chamando window.processarCompraCompleta');
                        window.processarCompraCompleta(e);
                    } else {
                        console.log('‚ùå window.processarCompraCompleta n√£o dispon√≠vel, usando fallback');
                        processarCompraSimples(e);
                    }
                };
                console.log('‚úÖ Form configurado');
            }
        });
        
        // Fun√ß√£o para verificar acesso admin (inline para garantir disponibilidade)
        function verificarAcessoAdmin() {
            console.log('üîê Redirecionando para √°rea administrativa...');
            window.location.href = 'admin.html';
        }
        
        function processarCompraSimples(event) {
            console.log('üí∞ Processando compra...');
            
            const form = event.target;
            const nome = form.querySelector('#nome-comprador').value;
            const telefone = form.querySelector('#telefone-comprador').value;
            
            if (!nome.trim()) {
                alert('Nome √© obrigat√≥rio!');
                return;
            }
            
            if (!telefone.trim()) {
                alert('Telefone √© obrigat√≥rio!');
                return;
            }
            
            try {
                // Tentar usar fun√ß√£o corrigida primeiro
                if (typeof window.processarCompraCompleta === 'function') {
                    console.log('‚úÖ Usando processamento completo com confirma√ß√£o de reservas');
                    window.processarCompraCompleta(event);
                    return;
                }
                
                // Fallback: processamento direto com Firebase
                console.log('‚ö†Ô∏è Usando fallback de processamento...');
                processarCompraFallback(event, nome, telefone);
                
            } catch (error) {
                console.error('‚ùå Erro no processamento:', error);
                alert(`‚ùå Erro ao processar compra: ${error.message}`);
            }
        }
        
        async function processarCompraFallback(event, nome, telefone) {
            console.log('üí∞ Processando compra (fallback)...');
            
            const form = event.target;
            const btn = form.querySelector('button[type="submit"]');
            const textoOriginal = btn.textContent;
            
            try {
                btn.textContent = '‚è≥ Processando...';
                btn.disabled = true;
                
                // Verificar se h√° cartelas no carrinho
                if (!window.carrinho || window.carrinho.length === 0) {
                    throw new Error('Carrinho vazio');
                }
                
                console.log(`üíæ Processando ${window.carrinho.length} cartela(s)...`);
                
                // Se Firebase dispon√≠vel, salvar as cartelas
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    console.log('üî• Salvando cartelas no Firebase...');
                    
                    const db = firebase.firestore();
                    const promises = [];
                    
                    window.carrinho.forEach((cartela, index) => {
                        const cartelaVendida = {
                            ...cartela,
                            status: 'vendida',
                            comprador: {
                                nome: nome.trim(),
                                telefone: telefone.trim()
                            },
                            nome: nome.trim(),
                            telefone: telefone.trim(),
                            dataVenda: firebase.firestore.FieldValue.serverTimestamp(),
                            dataCompra: new Date(),
                            timestamp: Date.now(),
                            processamento: 'fallback'
                        };
                        
                        promises.push(
                            db.collection('cartelas').doc(cartela.id).set(cartelaVendida)
                        );
                    });
                    
                    await Promise.all(promises);
                    console.log('‚úÖ Todas as cartelas salvas no Firebase');
                }
                
                // Sucesso
                const numeroCartelas = window.carrinho.length;
                const total = window.carrinho.reduce((sum, c) => sum + c.preco, 0);
                
                alert(`‚úÖ Compra realizada com sucesso!\n\n${numeroCartelas} cartela(s) comprada(s)\nTotal: R$ ${total.toFixed(2)}\n\nComprador: ${nome}\nTelefone: ${telefone}`);
                
                // Limpar carrinho
                window.carrinho = [];
                atualizarCarrinhoInterface();
                
                // Fechar modal
                fecharCheckout();
                
                // Resetar form
                form.reset();
                
                console.log('üéâ Compra processada com sucesso (fallback)!');
                
            } catch (error) {
                console.error('‚ùå Erro no fallback:', error);
                alert(`‚ùå Erro ao processar compra: ${error.message}`);
            } finally {
                btn.textContent = textoOriginal;
                btn.disabled = false;
            }
        }
        
        // Fun√ß√£o para verificar se o sistema est√° totalmente carregado
        async function verificarSistemaCarregado() {
            console.log('üîç Verificando se sistema est√° totalmente carregado...');
            
            let tentativas = 0;
            const maxTentativas = 50; // 5 segundos
            
            while (tentativas < maxTentativas) {
                const firebaseOk = typeof firebase !== 'undefined' && !!window.FirebaseDB;
                const funcoesOk = typeof window.gerarCartelaCorrigida === 'function' && 
                                 typeof window.adicionarAoCarrinhoCorrigida === 'function';
                
                console.log(`Tentativa ${tentativas + 1}: Firebase=${firebaseOk}, Fun√ß√µes=${funcoesOk}`);
                
                if (firebaseOk && funcoesOk) {
                    console.log('‚úÖ Sistema totalmente carregado!');
                    habilitarBotoesPrincipais();
                    return true;
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                tentativas++;
            }
            
            console.warn('‚ö†Ô∏è Sistema n√£o carregou no tempo esperado - habilitando mesmo assim');
            habilitarBotoesPrincipais(); // Habilitar mesmo assim para n√£o travar
            return false;
        }
        
        function habilitarBotoesPrincipais() {
            console.log('üîß Habilitando bot√µes principais...');
            
            const btnGerar = document.getElementById('gerar-preview');
            if (btnGerar) {
                btnGerar.disabled = false;
                btnGerar.textContent = 'üé≤ Gerar Nova Cartela';
                console.log('‚úÖ Bot√£o de gerar cartela habilitado');
            } else {
                console.error('‚ùå Bot√£o gerar-preview n√£o encontrado');
            }
        }
        
        // FALLBACK DE SEGURAN√áA: Habilitar bot√µes ap√≥s timeout m√°ximo
        setTimeout(() => {
            const btnGerar = document.getElementById('gerar-preview');
            if (btnGerar && btnGerar.disabled) {
                console.warn('‚ö†Ô∏è FALLBACK: Habilitando bot√µes ap√≥s timeout de seguran√ßa');
                habilitarBotoesPrincipais();
            }
        }, 10000); // 10 segundos m√°ximo
    </script>
    
    <!-- Firebase SDK v8 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
    
    <script src="login.js"></script>
    <script src="cartelas.js"></script>
    
    <!-- Sistema de Autentica√ß√£o - carregado por √∫ltimo -->
    <script src="auth.js"></script>

    <script>
        // Verifica√ß√£o adicional de autentica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîê Verifica√ß√£o adicional de autentica√ß√£o para cartelas.html');
            
            // Aguardar o auth.js carregar completamente
            setTimeout(() => {
                if (window.authManager) {
                    console.log('‚úÖ AuthManager encontrado - verificando acesso');
                    const isAuthenticated = window.authManager.isAuthenticated();
                    
                    if (!isAuthenticated) {
                        console.log('‚ùå Usu√°rio n√£o autenticado - mostrando modal');
                        window.authManager.showLoginModal();
                    } else {
                        console.log('‚úÖ Usu√°rio autenticado - acesso liberado');
                    }
                } else {
                    console.log('‚ö†Ô∏è AuthManager n√£o encontrado - carregando novamente');
                    // Fallback: recarregar auth.js se n√£o carregou
                    const script = document.createElement('script');
                    script.src = 'auth.js';
                    document.head.appendChild(script);
                }
            }, 1000);
        });
    </script>
</head>
<body>
    <!-- Bandeirolas -->
    <div class="bandeirolas">
        <div class="bandeirola bandeirola-1"></div>
        <div class="bandeirola bandeirola-2"></div>
        <div class="bandeirola bandeirola-3"></div>
        <div class="bandeirola bandeirola-4"></div>
        <div class="bandeirola bandeirola-5"></div>
        <div class="bandeirola bandeirola-6"></div>
        <div class="bandeirola bandeirola-7"></div>
        <div class="bandeirola bandeirola-8"></div>
        <div class="bandeirola bandeirola-9"></div>
        <div class="bandeirola bandeirola-10"></div>
    </div>

    <header>
        <div class="logo-empresa">
            <img src="inec.png" alt="Logo INEC" class="logo-inec">
        </div>
        <div class="nav-links">
            <a href="index.html" class="btn-nav">üé™ Bingo</a>
            <a href="index.html" class="btn-nav">üëÄ Minhas Cartelas</a>
            <a href="#" onclick="verificarAcessoAdmin()" class="btn-nav">‚öôÔ∏è Admin</a>
        </div>
        <div class="chapeu-palha">üëí</div>
        <h1>üé´ Comprar Cartelas</h1>
        <p>üéä Adquira suas cartelas para o Arrai√° INEC!</p>
    </header>

    <main>
        <!-- Status do Sistema -->
        <div id="status-sistema" style="display: none; padding: 10px; margin: 0 20px 20px 20px; border-radius: 5px; text-align: center; font-weight: bold;"></div>
        
        <div class="compra-container">
            <div class="info-section">
                <h2>üí∞ Informa√ß√µes</h2>
                <div class="preco-info">
                    <span class="label">Pre√ßo por cartela:</span>
                    <span id="preco-cartela" class="preco">R$ 5,00</span>
                </div>
                <div class="disponibilidade">
                    <span class="label">Cartelas dispon√≠veis:</span>
                    <span id="cartelas-disponiveis" class="quantidade">‚àû</span>
                </div>
            </div>

            <div class="preview-section">
                <h2>üéØ Sua Cartela</h2>
                <div id="cartela-preview" class="cartela-preview">
                    <div class="cartela-vazia">
                        <p>Clique em "Gerar Cartela" para ver sua cartela</p>
                    </div>
                </div>
                <div class="preview-actions">
                    <button id="gerar-preview" class="btn-primary" onclick="gerarCartela(); return false;" disabled>‚è≥ Carregando sistema...</button>
                    <button id="comprar-cartela" class="btn-success" disabled onclick="adicionarAoCarrinho(); return false;">üí≥ Comprar Esta Cartela</button>
                </div>
            </div>

            <div class="carrinho-section">
                <h2>üõí Carrinho</h2>
                <div id="carrinho-lista" class="carrinho-lista">
                    <p class="carrinho-vazio">Carrinho vazio</p>
                </div>
                <div class="carrinho-total">
                    <span class="label">Total:</span>
                    <span id="carrinho-total" class="total">R$ 0,00</span>
                </div>
                <div class="carrinho-actions">
                    <button id="finalizar-compra" class="btn-success" disabled onclick="abrirModal(); return false;">üéâ Finalizar Compra</button>
                    <button id="limpar-carrinho" class="btn-danger" onclick="limparCarrinho(); return false;">üóëÔ∏è Limpar Carrinho</button>
                </div>
            </div>
        </div>

        <!-- Modal de Finaliza√ß√£o -->
        <div id="modal-checkout" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>üí≥ Finalizar Compra</h3>
                <form id="form-checkout">
                    <div class="input-group">
                        <label for="nome-comprador">Nome Completo:</label>
                        <input type="text" id="nome-comprador" name="nome" required>
                    </div>
                    <div class="input-group">
                        <label for="telefone-comprador">Telefone:</label>
                        <input type="tel" id="telefone-comprador" name="telefone" required>
                    </div>
                    <div class="resumo-compra">
                        <h4>Resumo da Compra:</h4>
                        <div id="resumo-cartelas"></div>
                        <div class="total-final">
                            <strong>Total: <span id="total-final">R$ 0,00</span></strong>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-success">‚úÖ Confirmar Compra</button>
                        <button type="button" class="btn-secondary" onclick="fecharCheckout()">‚ùå Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Elementos decorativos -->
    <div class="fogueira">
        <div class="fogo"></div>
        <div class="lenha"></div>
    </div>

    <div class="estrelas">
        <div class="estrela estrela-1">‚≠ê</div>
        <div class="estrela estrela-2">‚ú®</div>
        <div class="estrela estrela-3">‚≠ê</div>
        <div class="estrela estrela-4">‚ú®</div>
        <div class="estrela estrela-5">‚≠ê</div>
    </div>

    <script>
    </script>
</body>
</html>
