<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Debug Final - Sistema Cartelas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .debug-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .form-test {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .resultado-final {
            background: #e9ecef;
            border: 2px solid #6c757d;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üö® Debug Final - Sistema Cartelas</h1>
    <p>Este √© o teste definitivo para identificar por que as cartelas n√£o est√£o sendo gravadas no Firebase.</p>
    
    <div class="debug-section">
        <h3>üìä Status dos Componentes</h3>
        <div id="status-firebase" class="status info">Verificando Firebase...</div>
        <div id="status-firebasedb" class="status info">Verificando FirebaseDB...</div>
        <div id="status-metodo" class="status info">Verificando m√©todo saveCartela...</div>
        <div id="status-funcao-global" class="status info">Verificando fun√ß√£o global...</div>
    </div>
    
    <div class="debug-section">
        <h3>üîß Testes Diretos</h3>
        <button onclick="testarFirebaseConexao()">üî• Testar Conex√£o Firebase</button>
        <button onclick="testarMetodoSaveCartela()">üíæ Testar M√©todo saveCartela</button>
        <button onclick="testarFuncaoGlobal()">üåê Testar Fun√ß√£o Global</button>
        <button onclick="simularFluxoCompleto()">üéØ Simular Fluxo REAL</button>
    </div>
    
    <div class="form-test">
        <h3>üìã Formul√°rio de Teste (Id√™ntico ao Real)</h3>
        <form id="form-teste-real">
            <div class="form-group">
                <label for="nome-test">Nome Completo:</label>
                <input type="text" id="nome-test" name="nome" value="Teste Final Debug" required>
            </div>
            <div class="form-group">
                <label for="telefone-test">Telefone:</label>
                <input type="tel" id="telefone-test" name="telefone" value="(11) 99999-0001" required>
            </div>
            <button type="submit">‚úÖ Confirmar Compra (REAL)</button>
        </form>
    </div>
    
    <div class="debug-section">
        <h3>üìù Log Detalhado</h3>
        <button onclick="limparLog()">üßπ Limpar Log</button>
        <div id="log-debug" class="log">Iniciando debug...</div>
    </div>
    
    <div id="resultado-final" class="resultado-final" style="display: none;">
        RESULTADO SER√Å EXIBIDO AQUI
    </div>

    <!-- Scripts EXATAMENTE como na p√°gina real -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="firebase-service.js"></script>
    <script src="login.js"></script>
    <script src="cartelas.js"></script>

    <script>
        let contadorTeste = 1;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log-debug');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'blue';
            
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateStatus(id, message, type) {
            const element = document.getElementById(id);
            element.textContent = message;
            element.className = `status ${type}`;
        }
        
        function mostrarResultado(message, tipo) {
            const div = document.getElementById('resultado-final');
            div.textContent = message;
            div.className = `resultado-final ${tipo}`;
            div.style.display = 'block';
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Debug final carregado');
            
            // Configurar formul√°rio REAL
            const form = document.getElementById('form-teste-real');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                log('üìù === FORMUL√ÅRIO REAL SUBMETIDO ===');
                
                // Chamar EXATAMENTE a mesma l√≥gica do HTML principal
                if (typeof window.processarCompraCompleta === 'function') {
                    log('‚úÖ Chamando window.processarCompraCompleta (M√âTODO REAL)');
                    window.processarCompraCompleta(e);
                } else {
                    log('‚ùå window.processarCompraCompleta N√ÉO DISPON√çVEL', 'error');
                    log('üîç Tentando chamar fun√ß√£o simples como fallback');
                    
                    // Tentar usar Firebase diretamente
                    if (window.FirebaseDB && typeof window.FirebaseDB.saveCartela === 'function') {
                        log('üî• Usando Firebase diretamente...');
                        testarGravacaoFor√ßada();
                    } else {
                        log('‚ùå Firebase n√£o dispon√≠vel', 'error');
                    }
                }
            });
            
            setTimeout(verificarStatusCompleto, 2000);
        });
        
        function verificarStatusCompleto() {
            log('üîç === VERIFICA√á√ÉO COMPLETA DE STATUS ===');
            
            // 1. Firebase SDK
            if (typeof firebase !== 'undefined') {
                updateStatus('status-firebase', '‚úÖ Firebase SDK carregado', 'success');
                log('‚úÖ Firebase SDK OK', 'success');
            } else {
                updateStatus('status-firebase', '‚ùå Firebase SDK n√£o carregado', 'error');
                log('‚ùå Firebase SDK FALHOU', 'error');
            }
            
            // 2. FirebaseDB
            if (window.FirebaseDB) {
                updateStatus('status-firebasedb', '‚úÖ FirebaseDB inicializado', 'success');
                log('‚úÖ FirebaseDB OK', 'success');
            } else {
                updateStatus('status-firebasedb', '‚ùå FirebaseDB n√£o inicializado', 'error');
                log('‚ùå FirebaseDB FALHOU', 'error');
            }
            
            // 3. M√©todo saveCartela
            if (window.FirebaseDB && typeof window.FirebaseDB.saveCartela === 'function') {
                updateStatus('status-metodo', '‚úÖ M√©todo saveCartela dispon√≠vel', 'success');
                log('‚úÖ M√©todo saveCartela OK', 'success');
            } else {
                updateStatus('status-metodo', '‚ùå M√©todo saveCartela n√£o encontrado', 'error');
                log('‚ùå M√©todo saveCartela FALHOU', 'error');
            }
            
            // 4. Fun√ß√£o global
            if (typeof window.processarCompraCompleta === 'function') {
                updateStatus('status-funcao-global', '‚úÖ Fun√ß√£o global dispon√≠vel', 'success');
                log('‚úÖ Fun√ß√£o global OK', 'success');
            } else {
                updateStatus('status-funcao-global', '‚ùå Fun√ß√£o global n√£o encontrada', 'error');
                log('‚ùå Fun√ß√£o global FALHOU', 'error');
            }
            
            // Verificar carrinho
            if (typeof window.carrinho !== 'undefined') {
                log(`üõí Carrinho global: ${window.carrinho.length} itens`);
            } else {
                log('üõí Carrinho global n√£o encontrado');
            }
        }
        
        async function testarFirebaseConexao() {
            log('üî• === TESTANDO CONEX√ÉO FIREBASE ===');
            
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK n√£o carregado');
                }
                
                log('‚úÖ Firebase SDK dispon√≠vel');
                
                const db = firebase.firestore();
                log('‚úÖ Firestore inicializado');
                
                // Teste de leitura simples
                const testDoc = await db.collection('teste').doc('conexao').set({
                    teste: true,
                    timestamp: Date.now()
                });
                
                log('‚úÖ Teste de escrita no Firestore OK', 'success');
                
            } catch (error) {
                log(`‚ùå Erro na conex√£o Firebase: ${error.message}`, 'error');
            }
        }
        
        async function testarMetodoSaveCartela() {
            log('üíæ === TESTANDO M√âTODO SAVECARTELA ===');
            
            if (!window.FirebaseDB) {
                log('‚ùå FirebaseDB n√£o dispon√≠vel', 'error');
                return;
            }
            
            if (typeof window.FirebaseDB.saveCartela !== 'function') {
                log('‚ùå M√©todo saveCartela n√£o √© uma fun√ß√£o', 'error');
                return;
            }
            
            const cartelaTeste = {
                id: `DEBUG-METODO-${Date.now()}`,
                numeros: Array.from({length: 15}, () => Math.floor(Math.random() * 75) + 1).sort((a, b) => a - b),
                preco: 5.00,
                status: 'vendida',
                comprador: {
                    nome: 'Teste M√©todo',
                    telefone: '(11) 99999-0002'
                },
                nome: 'Teste M√©todo',
                telefone: '(11) 99999-0002',
                dataCompra: new Date(),
                timestamp: Date.now()
            };
            
            try {
                log('üì§ Chamando FirebaseDB.saveCartela...');
                const resultado = await window.FirebaseDB.saveCartela(cartelaTeste);
                
                if (resultado.success) {
                    log(`‚úÖ M√âTODO OK! ID: ${resultado.id}`, 'success');
                    mostrarResultado('‚úÖ M√âTODO SAVECARTELA FUNCIONA!', 'success');
                } else {
                    log('‚ùå M√©todo retornou falha', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro no m√©todo: ${error.message}`, 'error');
            }
        }
        
        function testarFuncaoGlobal() {
            log('üåê === TESTANDO FUN√á√ÉO GLOBAL ===');
            
            if (typeof window.processarCompraCompleta !== 'function') {
                log('‚ùå Fun√ß√£o global n√£o dispon√≠vel', 'error');
                return;
            }
            
            // Criar evento fake
            const eventoFake = {
                preventDefault: () => log('preventDefault() chamado'),
                target: document.getElementById('form-teste-real'),
                type: 'submit'
            };
            
            // Criar carrinho fake
            if (!window.carrinho) {
                window.carrinho = [];
            }
            
            const cartelaFake = {
                id: `FAKE-${Date.now()}`,
                numeros: Array.from({length: 15}, () => Math.floor(Math.random() * 75) + 1).sort((a, b) => a - b),
                preco: 5.00,
                status: 'preview'
            };
            
            window.carrinho.push(cartelaFake);
            log(`üõí Carrinho fake criado com 1 item`);
            
            try {
                log('üì§ Chamando window.processarCompraCompleta...');
                window.processarCompraCompleta(eventoFake);
                log('‚úÖ Fun√ß√£o chamada sem erro', 'success');
            } catch (error) {
                log(`‚ùå Erro na fun√ß√£o global: ${error.message}`, 'error');
            }
        }
        
        async function simularFluxoCompleto() {
            log('üéØ === SIMULA√á√ÉO FLUXO COMPLETO ===');
            
            try {
                // 1. Verificar tudo
                if (!window.FirebaseDB || typeof window.FirebaseDB.saveCartela !== 'function') {
                    throw new Error('Firebase n√£o dispon√≠vel');
                }
                
                // 2. Criar cartela
                const cartela = {
                    id: `FLUXO-COMPLETO-${Date.now()}`,
                    numeros: Array.from({length: 15}, () => Math.floor(Math.random() * 75) + 1).sort((a, b) => a - b),
                    preco: 5.00,
                    status: 'vendida',
                    comprador: {
                        nome: 'Fluxo Completo',
                        telefone: '(11) 99999-0003'
                    },
                    nome: 'Fluxo Completo',
                    telefone: '(11) 99999-0003',
                    dataCompra: new Date(),
                    timestamp: Date.now()
                };
                
                log(`üìã Cartela criada: ${cartela.id}`);
                
                // 3. Salvar diretamente
                log('üíæ Salvando no Firebase...');
                const resultado = await window.FirebaseDB.saveCartela(cartela);
                
                if (resultado.success) {
                    log(`‚úÖ SUCESSO TOTAL! ID: ${resultado.id}`, 'success');
                    mostrarResultado('üéâ FLUXO COMPLETO FUNCIONOU! CARTELA SALVA!', 'success');
                    
                    // 4. Verificar se foi realmente salva
                    setTimeout(async () => {
                        try {
                            const db = firebase.firestore();
                            const doc = await db.collection('cartelas').doc(resultado.id).get();
                            
                            if (doc.exists) {
                                log('‚úÖ CONFIRMADO: Cartela existe no Firebase!', 'success');
                                const data = doc.data();
                                log(`üìã Dados: ${data.nome} - ${data.telefone} - ${data.numeros?.length} n√∫meros`);
                            } else {
                                log('‚ùå ERRO: Cartela n√£o encontrada no Firebase', 'error');
                            }
                        } catch (error) {
                            log(`‚ùå Erro ao verificar: ${error.message}`, 'error');
                        }
                    }, 2000);
                    
                } else {
                    log('‚ùå Falha na grava√ß√£o', 'error');
                    mostrarResultado('‚ùå FALHA NA GRAVA√á√ÉO', 'error');
                }
                
            } catch (error) {
                log(`üí• ERRO NO FLUXO: ${error.message}`, 'error');
                mostrarResultado(`üí• ERRO: ${error.message}`, 'error');
            }
        }
        
        async function testarGravacaoFor√ßada() {
            log('üöÄ === GRAVA√á√ÉO FOR√áADA ===');
            
            const nome = document.getElementById('nome-test').value;
            const telefone = document.getElementById('telefone-test').value;
            
            const cartela = {
                id: `FORCADA-${Date.now()}`,
                numeros: Array.from({length: 15}, () => Math.floor(Math.random() * 75) + 1).sort((a, b) => a - b),
                preco: 5.00,
                status: 'vendida',
                comprador: { nome, telefone },
                nome, telefone,
                dataCompra: new Date(),
                timestamp: Date.now()
            };
            
            try {
                const resultado = await window.FirebaseDB.saveCartela(cartela);
                if (resultado.success) {
                    log(`‚úÖ FOR√áADA OK! ID: ${resultado.id}`, 'success');
                    mostrarResultado('‚úÖ GRAVA√á√ÉO FOR√áADA FUNCIONOU!', 'success');
                } else {
                    log('‚ùå Grava√ß√£o for√ßada falhou', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro na grava√ß√£o for√ßada: ${error.message}`, 'error');
            }
        }
        
        function limparLog() {
            document.getElementById('log-debug').innerHTML = 'Log limpo...';
            document.getElementById('resultado-final').style.display = 'none';
        }
    </script>
</body>
</html>
